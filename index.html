<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyser</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define the Inter font family and a space-themed dark background */
        @import url('https://fonts.fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Deep space blue/black */
            color: #e5e7eb; /* Light gray text */
            min-height: 100vh;
        }
        
        /* Custom input and select styling for a sci-fi look */
        input[type="number"], select {
            background-color: #161b22;
            border: 1px solid #30363d;
            color: #e5e7eb; /* Softer light gray for input text */
            transition: border-color 0.2s, box-shadow 0.2s;
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
            padding-right: 2.5rem; 
        }

        /* --- FOCUS STYLE --- */
        input[type="number"]:focus, select:focus {
            border-color: #38bdf8; /* Bright Sky Blue for high visibility */
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.5); /* Wider, brighter focus ring */
            outline: none;
        }

        /* Styling for the dynamically added ship arms */
        .ship-arm-card {
            background-color: #21262d;
            border: 1px solid #30363d;
            transition: border-color 0.2s;
        }
        .ship-arm-card:hover {
            border-color: #60a5fa;
        }

        /* New Layout container: Max width, slightly centered for desktop visibility */
        .main-container {
            max-width: 1000px;
            width: 95%;
            display: grid; /* Enables stacking by default, and grid-cols-2 at lg */
            gap: 2rem;
        }
        
        @media (min-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr 1fr; /* Two equal columns for desktop */
            }
        }
        
        /* CRITICAL CSS FOR INDEPENDENT SCROLLING COLUMNS */
        @media (min-width: 1024px) {
            /* Left Column: Fixed position relative to viewport */
            .left-column-wrapper {
                position: sticky;
                top: 1rem; /* Space from the top */
                /* Calculate height to fit between top margin and bottom of viewport */
                max-height: calc(100vh - 2rem); 
                overflow-y: auto; /* Enable scrolling for inputs */
                padding-top: 0; /* Remove top padding from the scrolling container */
            }
            .static-header-pin {
                position: sticky;
                top: 0;
                z-index: 10; /* Ensure it stays above scrolling content */
                /* Use padding equal to the main wrapper's original top padding (p-6/p-8) to match the border/box visually */
                padding: 1.5rem 2rem 1.5rem 2rem; 
                background-color: #161b22; /* Match parent background */
                border-bottom: 1px solid #30363d; /* Visual separation line */
                margin-bottom: 2rem; /* Add spacing back after the header */
            }
        }
        /* END CRITICAL CSS */
    </style>
</head>
<body class="p-4 sm:p-8 flex justify-center items-start">

    <!-- MAIN GRID CONTAINER -->
    <div class="main-container">
        
        <!-- LEFT COLUMN: INPUTS AND TEAM ASSEMBLY -->
        <div class="w-full">
            <div class="left-column-wrapper bg-[#161b22] rounded-2xl shadow-2xl border border-blue-900/30">
                
                <!-- STATIC HEADER PINNED AT TOP -->
                <div class="static-header-pin p-6 sm:p-8 rounded-t-2xl">
                    <div class="text-center">
                        <div class="mb-2 flex items-center justify-center p-2">
                            <img src="https://media.discordapp.net/attachments/988651682122584134/1426345013377241169/AJfQ9KSIlByviCr-2cKRFtEIyKBJf0zQGJEvB_4JIpXPrPXNJkB3pVK3y1eD1HyGunZlYx2m0YSC2e3I1Dna5UkbxqP1k6C9Kco272vYe1rOWWj3WFfBu00oKAbDKeDcu0sG0IwBMrVj6H6H5VVm-1JK8Mh-c_7dCJM0WwQ5QeqM5lIfhCms9gs1024-rj.png?ex=68f3748f&is=68f2230f&hm=2d9d6d8fca9315f915aa2cd43a70d695e4839e8588bf056e2b561cc525006b8c&" 
                                 alt="Mining Fractor Analyser Logo" 
                                 class="w-full h-auto max-w-full rounded-lg object-contain shadow-lg">
                        </div>
                        <p class="text-sm text-gray-400 mt-2">Configure your mining team and analyze rock fracture limits.</p>
                    </div>
                </div>
                <!-- END STATIC HEADER PINNED AT TOP -->

                <!-- SCROLLABLE BODY CONTENT -->
                <div class="p-6 sm:p-8 space-y-8">

                    <!-- 1. Ship Assembly -->
                    <div class="p-4 bg-blue-900/20 rounded-xl border border-blue-700/50">
                        <label for="shipSelectToAdd" class="block text-base font-medium mb-2 text-blue-300">1. Assemble Your Mining Team</label>
                        <div class="flex space-x-2">
                            <select id="shipSelectToAdd" class="flex-grow p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white">
                                <!-- Options populated by JS -->
                            </select>
                            <button onclick="addShipLoadout()"
                                    class="p-3 text-sm font-bold rounded-lg transition-all duration-200 
                                           bg-blue-600 hover:bg-blue-700 shadow-md active:scale-95 whitespace-nowrap">
                                Add Ship
                            </button>
                        </div>
                    </div>

                    <!-- Active Loadout Cards -->
                    <h2 class="text-xl font-semibold text-gray-300">Active Laser Heads:</h2>
                    <div id="multiShipContainer" class="space-y-4 min-h-[100px] p-2 border border-gray-700 rounded-xl">
                        <p class="text-center text-gray-500 p-4 border border-dashed border-gray-700 rounded-lg">
                            Add ships above to configure their mining laser heads.
                        </p>
                    </div>

                    <!-- 2. Rock Parameters Group -->
                    <h2 class="text-xl font-semibold text-blue-300">2. Rock & Gadget Setup</h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Rock Stats Input (Resistance and Instability) -->
                        <div class="p-4 bg-[#21262d] rounded-xl col-span-2 sm:col-span-1">
                            <label for="resistance" class="block text-sm font-medium mb-2 text-gray-300">Base Resistance (%)</label>
                            <input type="number" id="resistance" value="16.0" step="0.1" placeholder="e.g., 16.0"
                                   class="w-full p-3 rounded-lg" oninput="calculate()">
                        </div>
                        
                        <div class="p-4 bg-[#21262d] rounded-xl col-span-2 sm:col-span-1">
                            <label for="instability" class="block text-sm font-medium mb-2 text-gray-300">Base Instability (%)</label>
                            <input type="number" id="instability" value="20.0" step="0.1" placeholder="e.g., 20.0"
                                   class="w-full p-3 rounded-lg" oninput="calculate()">
                        </div>

                        <!-- Target Rock Mass Input -->
                        <div class="p-4 bg-[#21262d] rounded-xl col-span-2">
                            <label for="rockMass" class="block text-sm font-medium mb-2 text-gray-300">Target Rock Mass (kg)</label>
                            <input type="number" id="rockMass" value="23922" placeholder="e.g., 23922"
                                   class="w-full p-3 rounded-lg" oninput="calculate()">
                        </div>
                    </div>
                    
                    <!-- Gadget Slot -->
                    <div class="p-4 bg-[#21262d] rounded-xl">
                        <label for="gadgetSelect" class="block text-sm font-medium mb-2 text-gray-300">3. Select Gadget (Rock Modifiers)</label>
                        <select id="gadgetSelect" onchange="calculate()"
                               class="w-full p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white">
                            <!-- Options populated by JS -->
                        </select>
                    </div>

                    <button onclick="calculate()"
                            class="w-full p-4 text-lg font-bold rounded-xl transition-all duration-200 
                                   bg-indigo-600 hover:bg-indigo-700 shadow-md hover:shadow-lg active:scale-95">
                        RUN ANALYTIC SIMULATION
                    </button>

                    <!-- FOOTNOTE 1: RSI Profile link (REMOVED) -->
                    <footer class="pt-4 border-t border-gray-700/50 text-center text-xs hidden">
                    </footer>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: RESULTS AND SUGGESTIONS -->
        <div class="w-full">
            <div class="right-column-wrapper bg-[#161b22] p-6 sm:p-8 rounded-2xl shadow-2xl border border-blue-900/30 space-y-8">
                
                <h2 class="text-2xl font-extrabold text-blue-400 text-center">ANALYTIC RESULTS</h2>
                
                <!-- Calculation Results -->
                <section id="results" class="pt-2">
                    <p class="text-center text-gray-400 italic">Configure your loadout and rock parameters to run the simulation.</p>
                </section>
                
                <!-- Recommendation output -->
                <section id="suggestion" class="pt-6 border-t border-gray-700/50 hidden">
                </section>
                
                <!-- FOOTNOTE 2: UEX Data Runner & RSI Profile link (COMBINED) -->
                <footer class="pt-4 border-t border-gray-700/50 text-center text-xs">
                    <p class="text-gray-500">
                        <a href="https://robertsspaceindustries.com/en/citizens/CHIRONDRAGON" target="_blank" class="text-indigo-400 hover:text-indigo-300 transition-colors duration-150 font-medium">
                            CHIRONDRAGON RSI Profile
                        </a>
                        <span class="text-gray-600">|</span>
                        <a href="https://uexcorp.space/@CHIRONDRAGON?tab=datarunner&set_lang=en_US" target="_blank" class="text-indigo-400 hover:text-indigo-300 transition-colors duration-150 font-medium">
                            UEX Data Runner
                        </a>
                    </p>
                </footer>
            </div>
        </div>
    </div>
    <!-- END MAIN GRID CONTAINER -->


    <script>
        // Data Definitions based on the latest single-ship file, adapted for dynamic adding
        const ships = [
            // Updated defaultLaser powers based on new laser data (Max Helix II and I, Pitman Max Power)
            { id: "mole", name: "Argo MOLE", arms: 3, maxLaserSize: 2, defaultLaser: 4080, moduleSlots: 3, isFixedLaser: false }, 
            { id: "prospector", name: "MISC Prospector", arms: 1, maxLaserSize: 1, defaultLaser: 3150, moduleSlots: 3, isFixedLaser: false }, 
            { id: "golem", name: "Drake Golem", arms: 1, maxLaserSize: 1, defaultLaser: 2700, moduleSlots: 2, isFixedLaser: true, fixedLaserName: "Pitman (~2700 MW)" } 
        ];

        // --- UPDATED LASER HEADS DATA FROM PDF ---
        const allLaserHeads = [
            // Laser, Size, MaxPower, ModuleSlots, Resistance (not used for effective resistance), Instability (not used for effective instability)
            { name: "Lancet MH1 (~2520 MW)", size: 1, power: 2520, moduleSlots: 1, resistanceEffect: -10, instabilityEffect: 40 },
            { name: "Hofstede-S1 (~2100 MW)", size: 1, power: 2100, moduleSlots: 1, resistanceEffect: -30, instabilityEffect: 10 },
            { name: "Klein-S1 (~2220 MW)", size: 1, power: 2220, moduleSlots: 0, resistanceEffect: -45, instabilityEffect: 35 },
            { name: "Impact I (~2100 MW)", size: 1, power: 2100, moduleSlots: 2, resistanceEffect: 10, instabilityEffect: -10 },
            { name: "Helix I (~3150 MW)", size: 1, power: 3150, moduleSlots: 2, resistanceEffect: -30, instabilityEffect: 0.0 },
            { name: "Arbor MH1 (~1890 MW)", size: 1, power: 1890, moduleSlots: 1, resistanceEffect: 25, instabilityEffect: -35 },
            { name: "Lancet MH2 (~3600 MW)", size: 2, power: 3600, moduleSlots: 2, resistanceEffect: 0.0, instabilityEffect: -10 },
            { name: "Hofstede-S2 (~3360 MW)", size: 2, power: 3360, moduleSlots: 2, resistanceEffect: -30, instabilityEffect: 10 },
            { name: "Klein-S2 (~3600 MW)", size: 2, power: 3600, moduleSlots: 1, resistanceEffect: -45, instabilityEffect: 35 },
            { name: "Impact II (~3360 MW)", size: 2, power: 3360, moduleSlots: 3, resistanceEffect: 10, instabilityEffect: -10 }, // Note: Impact II power reduced from 4080 to 3360 based on PDF
            { name: "Helix II (~4080 MW)", size: 2, power: 4080, moduleSlots: 3, resistanceEffect: -30, instabilityEffect: 0.0 },
            { name: "Arbor MH2 (~2400 MW)", size: 2, power: 2400, moduleSlots: 2, resistanceEffect: 25, instabilityEffect: -35 },
            // Pitman is fixed on Golem, added separately if the user wants to compare it. MaxPower 2700, 2 slots
            { name: "Pitman (~2700 MW)", size: 1, power: 3150, moduleSlots: 2, resistanceEffect: 25, instabilityEffect: 35 } 
        ].sort((a, b) => a.power - b.power);
        
        // --- UPDATED POWER MODULES DATA (Expanded and Verified) ---
        const powerModules = [
            // Active Modules (Only one active module's power multiplier/effects apply per laser head)
            { name: "Surge (Active, +50% Power, -15% Res)", multiplier: 1.50, resistanceEffect: -15, instabilityEffect: 0.0, activation: 'Active' },
            { name: "Brandt (Active, +35% Power, +15% Res)", multiplier: 1.35, resistanceEffect: 15, instabilityEffect: 0.0, activation: 'Active' },
            { name: "Stampede (Active, +35% Power, -10 Inst)", multiplier: 1.35, resistanceEffect: 0.0, instabilityEffect: -10, activation: 'Active' },
            { name: "Forel (Active, Charge Window +60%)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0, activation: 'Active' }, // Utility focus
            { name: "Lifeline (Active, Stability)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Active' }, // Utility focus
            { name: "Torpid (Active, Charge Rate +60%)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Active' }, // Utility focus
            { name: "Rime (Active, -15% Power, -25% Res)", multiplier: 0.85, resistanceEffect: -25, instabilityEffect: 0.0, activation: 'Active' },
            { name: "Optimum (Active, -15% Power, -80% Catastrophic Rate)", multiplier: 0.85, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Active' },
            
            // Passive Modules (All passive modules' power multipliers/effects stack per laser head)
            { name: "Rieger-C3 (Passive, +25% Power, -1% Inst)", multiplier: 1.25, resistanceEffect: 0.0, instabilityEffect: -1, activation: 'Passive' },
            { name: "Rieger-C2 (Passive, +20% Power, -3% Inst)", multiplier: 1.20, resistanceEffect: 0.0, instabilityEffect: -3, activation: 'Passive' },
            { name: "Focus III (Passive, -5% Power, +40% Opt Window)", multiplier: 0.95, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "Focus II (Passive, -10% Power, +37% Opt Window)", multiplier: 0.90, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "Focus (Passive, -15% Power, +30% Opt Window)", multiplier: 0.85, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "Torrent III (Passive, +40% Instability)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 40, activation: 'Passive' }, 
            { name: "Torrent II (Passive, +35% Instability)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 35, activation: 'Passive' }, 
            { name: "Torrent (Passive, +30% Instability)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 30, activation: 'Passive' }, 
            { name: "XTR-XL (Passive, +25% Opt Window, -24% Inert)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "XTR-L (Passive, +22% Opt Window, -23% Inert)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "XTR (Passive, +15% Opt Window, -20% Inert)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "FLTR-XL (Passive, -24% Inert)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' }, // Extraction only, no fracture effect
            { name: "Vaux-C3 (Passive, -5% Charge Rate)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' }, // Charge rate utility
            
            // Default/None
            { name: "None", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Default' },
        ];
        
        // Custom sort function: Default, Active (by power), Passive (by power)
        function sortModules(modules) {
            return modules.sort((a, b) => {
                // 1. Put 'None' first
                if (a.name === 'None') return -1;
                if (b.name === 'None') return 1;

                // 2. Group Active before Passive
                if (a.activation === 'Active' && b.activation === 'Passive') return -1;
                if (a.activation === 'Passive' && b.activation === 'Active') return 1;

                // 3. Within the same group, sort by power multiplier (highest first)
                if (a.multiplier !== b.multiplier) {
                    return b.multiplier - a.multiplier;
                }
                
                // 4. Fallback to alphabetical
                return a.name.localeCompare(b.name);
            });
        }
        const sortedModules = sortModules([...powerModules]); // Create a copy and sort it


        // --- UPDATED GADGETS DATA (Verified and expanded) ---
        const gadgets = [
            // CRITICAL FIX: Sabir now has negative reduction and instability effect to signify reduction.
            // Reduction < 0 means Multiplicative Reduction Factor (e.g., -50.0 -> x 0.50)
            // Reduction > 0 means Additive Resistance Increase (e.g., 10.0 -> +10 points)
            { name: "Sabir (-50% Res, -15% Inst)",    reduction: -50.0,    instabilityEffect: -15, type: 'Multiplicative' }, 
            { name: "OptiMax (-30% Resistance )",  reduction: -30.0,    instabilityEffect: 0.0, type: 'Multiplicative' },
            { name: "BoreMax (+10% Resistance, -70% Instability )",   reduction: 10.0,   instabilityEffect: -70, type: 'Additive' }, 
            { name: "Waveshift (Stability/Charge Rate, -35% Instability)",    reduction: 0.0,     instabilityEffect: -35, type: 'Utility' }, 
            { name: "Stalwart (Instability Reduction, -35% Instability)",     reduction: 0.0,     instabilityEffect: -35, type: 'Utility' }, 
            { name: "Okunis (Optimal Window/Charge Rate)",  reduction: 0.0,     instabilityEffect: 0.0, type: 'Utility' },
            { name: "None",                                 reduction: 0.0,     instabilityEffect: 0.0, type: 'None' }, 
        ].sort((a, b) => b.reduction - a.reduction);

        let armIdCounter = 0; // Unique ID for each added laser head

        /**
         * Generates the HTML for a single mining laser head's configuration.
         * @param {number} armIndex - The index of the laser head (1, 2, or 3) for display.
         * @param {object} ship - The ship data object (MOLE, Prospector, Golem).
         * @returns {string} The HTML for the laser head configuration.
         */
        function createArmConfigHtml(armIndex, ship) {
            armIdCounter++; // Ensure unique ID for this laser head
            const armUniqueId = `arm-${ship.id}-${armIdCounter}`;
            const isFixedLaser = ship.isFixedLaser; 

            // 1. Laser Head Options (Filtered by ship's maxLaserSize)
            let laserOptionsHtml = allLaserHeads
                .filter(head => head.size <= ship.maxLaserSize)
                .map(head => {
                    // Check if this head is the default one for the ship type, based on power and slots
                    let isSelected = false;
                    if (ship.id === 'mole' && head.name.includes('Helix II')) isSelected = true;
                    else if (ship.id === 'prospector' && head.name.includes('Helix I')) isSelected = true;
                    else if (ship.id === 'golem' && head.name.includes('Pitman')) isSelected = true;

                    return `<option 
                            value="${head.power}" 
                            data-slots="${head.moduleSlots}" 
                            data-resistance="${head.resistanceEffect}" 
                            data-instability="${head.instabilityEffect}" 
                            ${isSelected ? 'selected' : ''}>
                            ${head.name} (${head.moduleSlots} Slots)
                            </option>`;
                }).join('');

            let laserSelectAttributes = '';
            let laserSelectDisabled = '';
            if (isFixedLaser) {
                laserSelectDisabled = 'disabled';
                laserOptionsHtml = `<option value="${ships.find(s=>s.id === ship.id).defaultLaser}" data-slots="${ships.find(s=>s.id === ship.id).moduleSlots}" selected>${ship.fixedLaserName} (Fixed, ${ships.find(s=>s.id === ship.id).moduleSlots} Slots)</option>`;
            } else {
                // IMPORTANT: We need to trigger recalculate *and* potentially re-render module slots if a laser head changes.
                laserSelectAttributes = `onchange="updateLaserConfig(this, '${armUniqueId}'); calculate();"`;
            }
            
            // 2. Module Slot Options (Sorted and grouped)
            const moduleOptionsHtml = sortedModules.map(mod => 
                `<option value="${mod.name}" ${mod.name.startsWith('None') ? 'selected' : ''}>${mod.name}</option>`
            ).join('');

            // Determine the actual number of slots for the default/fixed laser head
            const actualMaxSlots = isFixedLaser ? ship.moduleSlots : allLaserHeads.find(h => h.power === ship.defaultLaser)?.moduleSlots || ship.moduleSlots;

            // 3. Module Slots (Enable/Disable 3rd slot based on what is currently selected/fixed)
            let moduleSlotsHtml = '<div id="module-slots-container-' + armUniqueId + '">';
            for (let i = 1; i <= 3; i++) {
                const isDisabled = i > actualMaxSlots;
                const slotText = isDisabled ? `--- SLOT DISABLED (${actualMaxSlots} Slots Max) ---` : `Module Slot ${i}`;
                const initialValue = 'None'; 
                const disabledClass = isDisabled ? 'opacity-50' : '';
                
                moduleSlotsHtml += `
                    <select id="${armUniqueId}-mod${i}" class="arm-module-select w-full p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white mb-3 ${disabledClass}" 
                            onchange="calculate()" value="${initialValue}" ${isDisabled ? 'disabled' : ''}>
                        ${isDisabled ? `<option value="None">${slotText}</option>` : moduleOptionsHtml}
                    </select>
                `;
            }
            moduleSlotsHtml += '</div>';

            // --- Full Laser Head Structure ---
            return `
                <div id="${armUniqueId}" class="p-4 rounded-xl shadow-lg ship-arm-card space-y-3" data-ship-id="${ship.id}" data-max-modules="${actualMaxSlots}">
                    <div class="flex justify-between items-start">
                        <h4 class="text-lg font-bold ${ship.id === 'mole' ? 'text-indigo-400' : ship.id === 'prospector' ? 'text-green-400' : 'text-amber-400'}">
                            ${ship.name} - Laser Head ${armIndex}
                        </h4>
                        <button onclick="removeArmConfig('${armUniqueId}')" title="Remove Laser Head" class="p-1 bg-red-600 hover:bg-red-700 text-white rounded-full transition-all duration-150 active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <label class="block text-sm font-medium text-gray-400">Laser Head (Base Power)</label>
                    <select id="${armUniqueId}-laser" class="arm-laser-select w-full p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white"
                            data-max-size="${ship.maxLaserSize}" ${laserSelectAttributes} ${laserSelectDisabled}>
                        ${laserOptionsHtml}
                    </select>
                    <p class="text-xs text-gray-500 italic text-right -mt-2 mb-2">Click or tap to view options</p>

                    <label class="block text-sm font-medium text-gray-400">Modules (Max <span id="${armUniqueId}-slot-count">${actualMaxSlots}</span> Slots)</label>
                    ${moduleSlotsHtml}
                </div>
            `;
        }
        
        /**
         * Dynamically updates the module slots available when a different laser head is selected.
         */
        function updateLaserConfig(selectElement, armUniqueId) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const newMaxSlots = parseInt(selectedOption.getAttribute('data-slots'));
            const container = document.getElementById(armUniqueId);
            const slotContainer = document.getElementById(`module-slots-container-${armUniqueId}`);
            const slotCountDisplay = document.getElementById(`${armUniqueId}-slot-count`);

            if (!container || !slotContainer) return;

            // 1. Update the overall arm data attribute for calculation logic
            container.setAttribute('data-max-modules', newMaxSlots);
            slotCountDisplay.textContent = newMaxSlots;

            // 2. Prepare the new module HTML
            const moduleOptionsHtml = sortedModules.map(mod => 
                `<option value="${mod.name}">${mod.name}</option>`
            ).join('');

            let newModuleSlotsHtml = '';
            for (let i = 1; i <= 3; i++) {
                const isDisabled = i > newMaxSlots;
                const slotText = isDisabled ? `--- SLOT DISABLED (${newMaxSlots} Slots Max) ---` : `Module Slot ${i}`;
                const initialValue = 'None'; 
                const disabledClass = isDisabled ? 'opacity-50' : '';

                // Try to retain the existing value if possible
                const oldSelect = document.getElementById(`${armUniqueId}-mod${i}`);
                const retainedValue = oldSelect && !isDisabled ? oldSelect.value : initialValue;
                
                let options = isDisabled ? `<option value="None">${slotText}</option>` : `<option value="None">None</option>` + moduleOptionsHtml.replace(`value="${retainedValue}"`, `value="${retainedValue}" selected`);

                newModuleSlotsHtml += `
                    <select id="${armUniqueId}-mod${i}" class="arm-module-select w-full p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white mb-3 ${disabledClass}" 
                            onchange="calculate()" value="${retainedValue}" ${isDisabled ? 'disabled' : ''}>
                        ${options}
                    </select>
                `;
            }

            slotContainer.innerHTML = newModuleSlotsHtml;
        }

        /**
         * Adds a set of loadout arms corresponding to the selected ship.
         */
        function addShipLoadout() {
            const container = document.getElementById('multiShipContainer');
            const selectElement = document.getElementById('shipSelectToAdd');
            const selectedShipId = selectElement.value;
            const shipData = ships.find(s => s.id === selectedShipId);

            if (!shipData) return;

            // Remove initial placeholder message if present
            const placeholder = container.querySelector('p.text-gray-500');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Add all arms for the selected ship
            for (let i = 1; i <= shipData.arms; i++) {
                const armHtml = createArmConfigHtml(i, shipData);
                container.insertAdjacentHTML('beforeend', armHtml);
            }
            
            // Recalculate after adding new ships
            calculate();
        }

        /**
         * Removes an arm configuration from the DOM.
         * @param {string} armId - The unique ID of the arm element to remove.
         */
        function removeArmConfig(armId) {
            const armElement = document.getElementById(armId);
            if (armElement) {
                armElement.remove();
            }
            
            const container = document.getElementById('multiShipContainer');
            // If all arms are removed, show the placeholder again
            if (container.children.length === 0) {
                container.innerHTML = `
                    <p class="text-center text-gray-500 p-4 border border-dashed border-gray-700 rounded-lg">
                        Add ships above to configure their mining laser heads.
                    </p>
                `;
            }
            calculate();
        }


        /**
         * Dynamically populates the ship and gadget select dropdowns on load.
         */
        function populateSelects() {
            // 1. Populate "Add Ship" Select
            const shipSelectElement = document.getElementById('shipSelectToAdd');
            if (shipSelectElement) {
                shipSelectElement.innerHTML = ships.map((ship) => 
                    `<option value="${ship.id}">${ship.name} (Laser Heads: ${ship.arms})</option>`
                ).join('');
                // Default to MOLE for easy initial testing of multi-arm ships
                shipSelectElement.value = 'mole';
            }
            
        // 2. Populate Gadget Slot
        const gadgetSelectElement = document.getElementById('gadgetSelect');
        if (gadgetSelectElement) {
            // Find the "None" gadget to use as default
            const defaultGadget = gadgets.find(g => g.name === "None");

            // Populate dropdown with names as values (unique identifiers)
            gadgetSelectElement.innerHTML = gadgets.map(g =>
                `<option value="${g.name}" ${g === defaultGadget ? 'selected' : ''}>${g.name}</option>`
            ).join('');

            // --- Set default explicitly to "None" ---
            if (defaultGadget) {
                gadgetSelectElement.value = defaultGadget.name;
            }
        }
            
            // Run initial calculation (which will show the 'no ships' message)
            calculate(); 
        }

        /**
         * Assesses mining difficulty based on Instability and Resistance.
         */
        function assessDifficulty(instability, resistance) {
            // Note: The difficulty score calculation logic has been simplified slightly to be based on the final, modified rock parameters
            let difficultyScore = resistance * 1.5 + instability;
            
            if (difficultyScore >= 100) {
                return { text: "EXTREME: Very high instability and resistance. Requires exceptional skill and stability modules.", color: "text-red-500" };
            } else if (difficultyScore >= 60) {
                return { text: "HARD: High instability/resistance. Requires specialized modules (Forel/Torrent) for safe charging.", color: "text-orange-400" };
            } else if (difficultyScore >= 30) {
                return { text: "MODERATE: Average difficulty. Standard play should be fine, but stability modules are helpful.", color: "text-yellow-300" };
            } else {
                return { text: "EASY: Low difficulty rock. Minimal risk of overheating or explosion.", color: "text-green-400" };
            }
        }


        /**
         * The core JavaScript function to perform the mining calculation and suggestion.
         */
        function calculate() {
            const resultsContainer = document.getElementById('results');
            const suggestionContainer = document.getElementById('suggestion');
            const allArms = document.querySelectorAll('.ship-arm-card');
            
            // 1. Input Validation and Power/Modifier Summation
            if (allArms.length === 0) {
                displayResult('No mining laser heads added. Assemble your team above to begin the calculation.', 'text-gray-400');
                suggestionContainer.classList.add('hidden');
                return;
            }

            let totalEffectiveLaserPower = 0;
            
            // NEW MODIFIERS: These will track the total MULTIPLICATIVE effect of ALL lasers and ALL modules.
            let totalResistanceMultiplier = 1.0; 
            let totalInstabilityMultiplier = 1.0; 
            let validationError = false;
            let totalArmsCount = allArms.length;

            allArms.forEach(arm => {
                const armUniqueId = arm.id;
                const maxModules = parseInt(arm.dataset.maxModules);
                
                // Get Laser Power and Attributes
                const laserSelect = document.getElementById(`${armUniqueId}-laser`);
                const basePowerValue = laserSelect ? (laserSelect.value || '0') : '0';
                const basePower = parseFloat(basePowerValue);
                const selectedOption = laserSelect.options[laserSelect.selectedIndex];

                // --- MODIFIERS PER ARM (Laser + Modules) ---
                let armResistanceMultiplier = 1.0;
                let armInstabilityMultiplier = 1.0;
                let totalModulePowerMultiplier = 1.0;
                let activeModules = [];
                let passiveModules = [];

                // 1. Apply Laser Head Effects (Multiplicative)
                const laserResistanceEffect = parseFloat(selectedOption.getAttribute('data-resistance')) || 0;
                const laserInstabilityEffect = parseFloat(selectedOption.getAttribute('data-instability')) || 0;

                // Apply laser's inherent modifiers (e.g., Lancet -10% Res -> x 0.90)
                armResistanceMultiplier *= (1 + (laserResistanceEffect / 100));
                armInstabilityMultiplier *= (1 + (laserInstabilityEffect / 100));
                
                // 2. Collect all module selections for this arm
                for (let i = 1; i <= 3; i++) { 
                    const moduleSelect = document.getElementById(`${armUniqueId}-mod${i}`);
                    if (moduleSelect && i <= maxModules) { 
                        const moduleName = moduleSelect.value;
                        const selectedModule = powerModules.find(m => m.name === moduleName);

                        if (selectedModule && selectedModule.name !== 'None') {
                            if (selectedModule.activation === 'Active') {
                                activeModules.push(selectedModule);
                            } else if (selectedModule.activation === 'Passive') {
                                passiveModules.push(selectedModule);
                            }
                        }
                    }
                }
                
                // 3. Apply Active Module Rule (only the most powerful one is active)
                if (activeModules.length > 0) {
                    activeModules.sort((a, b) => b.multiplier - a.multiplier);
                    const activeModule = activeModules[0];
                    
                    // Apply Power Multiplier (Accumulative)
                    totalModulePowerMultiplier *= activeModule.multiplier; 
                    
                    // Apply Resistance/Instability Modifiers (Multiplicative Stacking per arm)
                    armInstabilityMultiplier *= (1 + (activeModule.instabilityEffect / 100)); 
                    armResistanceMultiplier *= (1 + (activeModule.resistanceEffect / 100));
                }

                // 4. Apply Passive Module Rule (all stack)
                passiveModules.forEach(mod => {
                    // Apply Power Multiplier (Accumulative)
                    totalModulePowerMultiplier *= mod.multiplier; 
                    
                    // Apply Resistance/Instability Modifiers (Multiplicative Stacking per arm)
                    armInstabilityMultiplier *= (1 + (mod.instabilityEffect / 100)); 
                    armResistanceMultiplier *= (1 + (mod.resistanceEffect / 100));
                });
                // --- END MODULE EFFECT CALCULATION PER ARM ---

                // Add calculated arm modifiers to the total multi-ship pool
                totalResistanceMultiplier *= armResistanceMultiplier;
                totalInstabilityMultiplier *= armInstabilityMultiplier;

                if (isNaN(basePower) || basePower <= 0) {
                    validationError = true;
                } else {
                    // Total effective power is the sum of (Base Power * Total Multiplier) for each arm
                    totalEffectiveLaserPower += basePower * totalModulePowerMultiplier;
                }
            });

            // Re-normalize multipliers based on the number of arms
            // We take the N-th root of the compounded multiplier, where N is the number of arms
            const totalModifierRoot = 1.0 / totalArmsCount;
            totalResistanceMultiplier = Math.pow(totalResistanceMultiplier, totalModifierRoot);
            totalInstabilityMultiplier = Math.pow(totalInstabilityMultiplier, totalModifierRoot);
            

            // Get Rock & Gadget Stats
            const baseResistance = parseFloat(document.getElementById('resistance').value);
            const initialInstability = parseFloat(document.getElementById('instability').value);
            const gadgetSelect = document.getElementById('gadgetSelect');
            const selectedGadgetName = gadgetSelect.value;
            const rockMass = parseFloat(document.getElementById('rockMass').value);
            
            // Final Validation (Catches NaN from number inputs if they are cleared by the user)
            if (validationError || isNaN(baseResistance) || isNaN(rockMass) || isNaN(initialInstability) || totalEffectiveLaserPower <= 0) {
                displayResult('Error: Ensure all active laser heads have a valid Laser Head selected and all rock parameters contain valid positive numbers.', 'text-yellow-400');
                suggestionContainer.classList.add('hidden');
                return;
            }

            // 2. Calculate Final Rock Parameters (Gadget applied last)
            const selectedGadget = gadgets.find(g => g.name === selectedGadgetName);

            if (selectedGadget) {
                // Gadget Resistance and Instability are also applied multiplicatively
                // Reduction is negative (e.g., -50) -> Multiplier 0.50
                // Increase is positive (e.g., 10) -> Multiplier 1.10
                totalResistanceMultiplier *= (1 + (selectedGadget.reduction / 100));
                totalInstabilityMultiplier *= (1 + (selectedGadget.instabilityEffect / 100));
            }
            
            // Step 3: Apply the total multiplier to the base rock stats
            let finalEffectiveResistance = baseResistance * totalResistanceMultiplier;
            let finalModifiedInstability = initialInstability * totalInstabilityMultiplier;

            // Apply final clamps
            if (finalEffectiveResistance < 0) finalEffectiveResistance = 0; 
            if (finalModifiedInstability < 0) finalModifiedInstability = 0; // Instability cannot be negative
            
            // --- Output Display Formatting ---
            const resistanceDisplayBreakdown = `Total Multiplier: x${totalResistanceMultiplier.toFixed(2)}`;
            const instabilityDisplayBreakdown = `Total Multiplier: x${totalInstabilityMultiplier.toFixed(2)}`;
            // ---------------------------------

            // 3. Perform Fracture Calculation
            const resistanceDecimal = finalEffectiveResistance / 100.0;
            
            let breakableMassLimit;
            let requiredEffectivePower = 0; 

            if (resistanceDecimal >= 1.0) {
                breakableMassLimit = 0.0;
            } else {
                const denominator = 1.0 - resistanceDecimal;
                // Formula: (Total Effective Laser Power * 5) / (1 - Effective Resistance)
                breakableMassLimit = (totalEffectiveLaserPower * 5) / denominator;
                
                // Required Power = (Target Mass * (1 - Effective Resistance)) / 5
                requiredEffectivePower = (rockMass * denominator) / 5; 
            }

            // 4. Determine Verdict and Format Output
            const isSuccess = breakableMassLimit >= rockMass;

            const formattedMaxMass = breakableMassLimit.toLocaleString(undefined, { maximumFractionDigits: 2 });
            const formattedRockMass = rockMass.toLocaleString();
            const formattedEffectivePower = totalEffectiveLaserPower.toLocaleString(undefined, { maximumFractionDigits: 2 });
            
            let verdictClass = isSuccess ? 'bg-green-700/80' : 'bg-red-700/80';
            let verdictIcon = isSuccess ? '✅' : '❌';
            let verdictText = isSuccess ? 'FRACTURE SUCCESSFUL!' : 'FRACTURE FAILED. Power short.';
            
            let massDifference = isSuccess ? 
                `${(breakableMassLimit - rockMass).toLocaleString(undefined, { maximumFractionDigits: 2 })} kg over the target mass.` : 
                `${(rockMass - breakableMassLimit).toLocaleString(undefined, { maximumFractionDigits: 2 })} kg short of the target mass.`;

            // Difficulty Assessment uses the final module-modified instability and effective resistance
            const difficulty = assessDifficulty(finalModifiedInstability, finalEffectiveResistance);


            const outputHtml = `
                <div class="space-y-6 text-white text-center">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 rounded-xl bg-[#21262d] shadow-inner border border-gray-700">
                            <p class="text-sm text-gray-400">Final Effective Resistance</p>
                            <p class="text-3xl font-extrabold text-red-400 mt-1">${finalEffectiveResistance.toFixed(1)}%</p>
                            <p class="text-xs text-gray-500">(Base ${baseResistance.toFixed(1)}% | ${resistanceDisplayBreakdown})</p>
                        </div>
                        <div class="p-3 rounded-xl bg-[#21262d] shadow-inner border border-gray-700">
                            <p class="text-sm text-gray-400">Modified Instability</p>
                            <p class="text-3xl font-extrabold text-purple-400 mt-1">${finalModifiedInstability.toFixed(2)}%</p>
                            <p class="text-xs text-gray-500">(Base ${initialInstability.toFixed(2)}% | ${instabilityDisplayBreakdown})</p>
                        </div>
                    </div>
                    
                    <div class="p-3 rounded-xl bg-indigo-900/40 shadow-inner border border-indigo-700">
                        <p class="text-sm text-gray-400">Total Combined Effective Laser Power (${totalArmsCount} Laser Heads)</p>
                        <p class="text-4xl font-extrabold text-yellow-300 mt-1">${formattedEffectivePower} MW</p>
                    </div>

                    <div class="p-3 rounded-xl bg-[#21262d] shadow-inner border border-gray-700">
                        <p class="text-sm text-gray-400">Max Theoretical Breakable Mass Limit</p>
                        <p class="text-4xl font-extrabold text-indigo-300 mt-1">${formattedMaxMass} kg</p>
                    </div>
                    
                    <div class="p-4 rounded-xl font-semibold text-lg text-white ${verdictClass} shadow-xl mt-6">
                        <p class="text-2xl">${verdictIcon} ${verdictText}</p>
                        <p class="text-sm pt-2 text-gray-200 italic">${massDifference}</p>
                        <p class="text-sm pt-1 text-gray-300">Target Rock Mass: ${formattedRockMass} kg</p>
                    </div>
                    
                    <div class="p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <p class="text-base font-semibold text-gray-300">Mining Difficulty Assessment:</p>
                        <p class="mt-1 font-bold ${difficulty.color}">${difficulty.text}</p>
                    </div>
                </div>
            `;

            resultsContainer.innerHTML = outputHtml;
            
            // 5. Generate Suggestions (Failure Alert, Stability Warning, and Max Loadout)
            let suggestionHtml = '';
            let recommendedLoadoutHtml = '';
            let warningsHtml = ''; 
            
           // --- CACLULATION FOR MINIMUM ARMS ---
            // Max S2 Laser (Helix II: 4080 MW, 3 slots) * Surge (1.50) * Rieger-C3 (1.25) * Rieger-C2 (1.20) = 9180 MW
            const maxEffectivePowerPerBestArm = 4080 * 1.50 * 1.25 * 1.20; // 9180 MW
            const minArmsRequired = Math.ceil(requiredEffectivePower / maxEffectivePowerPerBestArm);
            const currentArmsSufficient = totalArmsCount >= minArmsRequired;

            // --- A. Generate Max Power Loadout Recommendation (ALWAYS GENERATED) ---
            
            // Ideal Loadout Components for Max Power
            const recommendedGadget = gadgets.find(g => g.name.startsWith("Sabir"));
            const topActiveModule = powerModules.find(m => m.activation === 'Active' && m.name.startsWith("Surge")); // Surge (1.50)
            const topPassiveModules = powerModules.filter(m => m.activation === 'Passive').sort((a, b) => b.multiplier - a.multiplier);
            
            // The two best passive modules (Rieger-C3, Rieger-C2)
            const recommendedPassiveModules = [ 
                topPassiveModules.find(m => m.name.startsWith("Rieger-C3")),
                topPassiveModules.find(m => m.name.startsWith("Rieger-C2")),
            ].filter(Boolean); // Filter out null/undefined if any are missing

            const recommendedLaserS2 = allLaserHeads.find(h => h.name.startsWith("Helix II")); 
            const recommendedLaserS1 = allLaserHeads.find(h => h.name.startsWith("Helix I"));  
            const recommendedGolemLaser = allLaserHeads.find(h => h.name.includes("Pitman")); // Find by name as power changed
            
            // --- NEW ARM REQUIREMENT ANALYSIS BLOCK (Precedes detailed loadout) ---
            const requiredArmsHtml = `
                <div class="p-4 rounded-xl shadow-lg border ${currentArmsSufficient ? 'border-green-600 bg-green-900/40' : 'border-red-600 bg-red-900/40'} text-center mb-6">
                    <h3 class="text-xl font-bold ${currentArmsSufficient ? 'text-green-300' : 'text-red-300'}">
                        Min. Laser Heads Required
                    </h3>
                    <p class="text-sm text-gray-300 mt-2">
                        Required Effective Power: <span class="font-extrabold text-yellow-300">${requiredEffectivePower.toLocaleString(undefined, { maximumFractionDigits: 2 })} MW</span>
                    </p>
                    <p class="text-4xl font-extrabold text-white mt-2">
                        ${minArmsRequired}
                    </p>
                    <p class="text-xs text-gray-400 mt-1">
                        (Calculation based on max **Helix II** loadout: ${maxEffectivePowerPerBestArm.toLocaleString(undefined, { maximumFractionDigits: 2 })} MW/arm)
                    </p>
                    ${!currentArmsSufficient ? 
                        `<p class="text-sm text-red-200 mt-3 font-bold">WARNING: Your current team (${totalArmsCount} arms) is insufficient for the recommended loadout.</p>` :
                        `<p class="text-sm text-green-200 mt-3 font-bold">STATUS: Your current team (${totalArmsCount} arms) is sufficient.</p>`
                    }
                </div>
            `;
            // --- END NEW BLOCK ---

            recommendedLoadoutHtml += requiredArmsHtml;
            recommendedLoadoutHtml += `<h2 class="text-xl font-semibold text-center text-yellow-300 mb-4">Max Power Loadout Details</h2>`;
            
            recommendedLoadoutHtml += `<div class="p-4 bg-gray-800/50 rounded-lg mb-6 border border-blue-600">
                <p class="font-bold text-blue-300">Max Resistance Reduction Gadget:</p>
                <p class="text-lg text-white font-semibold mt-1">${recommendedGadget.name}</p>
                <p class="text-sm text-gray-400">(Recommended to reduce target resistance)</p>
            </div>`;

            recommendedLoadoutHtml += '<h3 class="text-lg font-bold text-center text-yellow-300 mb-4">Loadout Per Ship Type</h3>';
            
            // --- NEW SHIP REQUIREMENT ANALYSIS ---
            const minMOLEsRequired = Math.ceil(minArmsRequired / 3);
            const minProspectorsRequired = minArmsRequired; // Assuming one arm per Prospector
            
            recommendedLoadoutHtml += `
                <div class="p-4 bg-gray-800/50 rounded-lg mb-6 border border-indigo-600">
                    <h4 class="font-bold text-indigo-300">To Meet the ${minArmsRequired} Arm Requirement:</h4>
                    <p class="text-sm text-gray-300 mt-2">
                        You would need at least:
                    </p>
                    <div class="flex justify-around mt-3 text-lg font-extrabold">
                        <span class="text-indigo-400">${minMOLEsRequired} MOLE${minMOLEsRequired > 1 ? 's' : ''}</span>
                        <span class="text-gray-600">OR</span>
                        <span class="text-green-400">${minProspectorsRequired} Prospector${minProspectorsRequired > 1 ? 's' : ''}</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-3">
                        (Assumes all required ships are configured with the optimal loadout shown below.)
                    </p>
                </div>
            `;
            // --- END NEW SHIP REQUIREMENT ANALYSIS ---

            recommendedLoadoutHtml += '<div class="space-y-4">';

            // To avoid generating multiple loadouts for each ship type present, we will generate the three standard loadouts (MOLE/S2, Prospector/S1, Golem/Fixed)

            const loadoutTypes = [
                { id: 'mole', name: 'MOLE (S2/3 Slots)', laser: recommendedLaserS2, slots: 3 },
                { id: 'prospector', name: 'Prospector (S1/3 Slots)', laser: recommendedLaserS1, slots: 3 },
                { id: 'golem', name: 'Golem (Fixed/2 Slots)', laser: recommendedGolemLaser, slots: 2 }
            ];

            loadoutTypes.forEach(type => {
                const maxModules = type.slots;

                // Determine module list based on slots
                let moduleList;
                if (type.id === 'golem') {
                    // Golem (2 slots): 1 Active (Surge) + 1 Passive (Rieger-C3)
                    moduleList = [topActiveModule, recommendedPassiveModules[0]].filter(Boolean);
                } else { 
                    // MOLE/Prospector (3 slots): 1 Active (Surge) + 2 Passive (Rieger-C3, Rieger-C2)
                    moduleList = [topActiveModule, ...recommendedPassiveModules].filter(Boolean);
                }
                
                moduleList = moduleList.slice(0, maxModules);
                
                // Calculate the max effective power for this recommended arm loadout
                let rec_power_multiplier = 1.0;
                
                const rec_active_module = moduleList.find(m => m.activation === 'Active');
                const rec_passive_modules = moduleList.filter(m => m.activation === 'Passive');
                
                if (rec_active_module) {
                    rec_power_multiplier *= rec_active_module.multiplier;
                }
                rec_passive_modules.forEach(mod => {
                    rec_power_multiplier *= mod.multiplier;
                });
                
                const maxEffectivePower = type.laser.power * rec_power_multiplier;
                
                const moduleHtml = moduleList.map((mod, i) => 
                    `<li class="ml-4 list-disc text-green-300">Slot ${i+1}: <span class="font-bold">${mod.name}</span> (x${mod.multiplier.toFixed(2)})</li>`
                ).join('');
                
                const titleColorClass = type.id === 'mole' ? 'text-indigo-400' : type.id === 'prospector' ? 'text-green-400' : 'text-amber-400';

                recommendedLoadoutHtml += `
                    <div class="p-4 rounded-xl bg-gray-900 border border-gray-700">
                        <h4 class="text-lg font-bold ${titleColorClass}">${type.name} - Max Loadout</h4>
                        <p class="text-sm text-gray-400 mt-1">
                            Max Achievable Power: <span class="text-yellow-400 font-bold">${maxEffectivePower.toLocaleString(undefined, { maximumFractionDigits: 2 })} MW</span>
                        </p>
                        
                        <div class="mt-3 p-3 bg-[#161b22] rounded-lg">
                            <p class="font-medium text-blue-400">Laser Head:</p>
                            <p class="text-base font-bold text-white">${type.laser.name}</p>
                        </div>
                                                    
                        <div class="mt-3 p-3 bg-[#161b22] rounded-lg">
                            <p class="font-medium text-blue-400">Recommended Modules (${maxModules} Slots):</p>
                            <ul class="text-sm space-y-1 pt-1">
                                ${moduleHtml}
                            </ul>
                        </div>
                    </div>
                `;
            });


            recommendedLoadoutHtml += '</div>';

            // --- B. Generate Failure Warning (CONDITIONAL) ---
            if (!isSuccess && requiredEffectivePower > 0) {
                 
                 const formattedRequiredPower = requiredEffectivePower.toLocaleString(undefined, { maximumFractionDigits: 2 });
                 const powerNeeded = requiredEffectivePower - totalEffectiveLaserPower;
                 
                 warningsHtml += `
                    <div class="p-4 bg-red-900/40 rounded-xl border border-red-700/50 mb-6">
                        <h3 class="text-xl font-bold text-red-300 mb-2">🚀 Power Shortfall Alert!</h3>
                        <p class="text-gray-300">The current loadout is **${powerNeeded.toLocaleString(undefined, { maximumFractionDigits: 2 })} MW** short. Your Total Effective Laser Power of **${formattedEffectivePower} MW** must reach at least **${formattedRequiredPower} MW**.</p>
                        <p class="mt-2 text-sm text-yellow-200">
                            **Action Plan:**
                            <ul class="list-disc list-inside ml-2 mt-1 space-y-1">
                                <li>Refer to the **Min. Laser Heads Required** section above to correctly staff your crew.</li>
                                <li>The recommended loadouts below represent the maximum power you can achieve per ship type.</li>
                                <li>Ensure your current ships are using these **Max Loadouts** to close the power gap.</li>
                            </ul>
                        </p>
                    </div>
                 `;
            }
            
            // --- C. Generate Stability Warning (CONDITIONAL) ---
            if (finalEffectiveResistance > 30 || finalModifiedInstability > 40) {
                
                let instabilityTip = finalModifiedInstability > 40 ? 'Your **Instability** is critically high. Expect a small optimal window.' : '';
                let resistanceTip = finalEffectiveResistance > 30 ? 'Your **Resistance** is high, making the rock hard to heat.' : '';

                warningsHtml += `
                    <div class="p-4 bg-purple-900/40 rounded-xl border border-purple-700/50 ${warningsHtml.length > 0 ? '' : 'mb-6'}">
                        <h3 class="text-xl font-bold text-purple-300 mb-2">🛡️ Rock Stability Warning!</h3>
                        <p class="text-gray-300">
                            ${instabilityTip} ${resistanceTip}
                        </p>
                        <p class="mt-2 text-sm text-yellow-200">
                            **Module Recommendation:**
                            <ul class="list-disc list-inside ml-2 mt-1 space-y-1">
                                <li>To reduce **Instability**: Equip **Stampede** (Active) or **Rieger-C2/C3** (Passive).</li>
                                <li>To reduce **Resistance**: Equip **Surge** (Active) or **Rime** (Active).</li>
                                <li>For optimal window control: Use **Focus** series modules.</li>
                            </ul>
                        </p>
                    </div>
                `;
            }
            
            // --- D. Combine and Display ---
            if (warningsHtml.length > 0) {
                // If there were warnings, prepend them to the loadout recommendation
                suggestionContainer.innerHTML = `<h2 class="text-xl font-semibold text-center text-red-400 mb-4">Urgent Analysis & Loadout Guide</h2>` + warningsHtml + recommendedLoadoutHtml;
                suggestionContainer.classList.remove('hidden');
            } else if (recommendedLoadoutHtml.length > 0) {
                // If only the loadout recommendation exists (successful, low difficulty rock)
                suggestionContainer.innerHTML = recommendedLoadoutHtml;
                suggestionContainer.classList.remove('hidden');
            } else {
                suggestionContainer.classList.add('hidden');
            }
        }

        // Helper function for error messages
        function displayResult(message, className) {
            document.getElementById('results').innerHTML = `<p class="text-center mt-4 ${className} font-bold text-lg">${message}</p>`;
        }
        
        // Run initial population on load
        window.onload = () => {
            populateSelects();
        };
    </script>
</body>
</html>
