<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mining Fracture Analyser - Star Citizen</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Load Tesseract.js for OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- Load Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Define the Inter font family */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- THEME VARIABLES --- */
        :root {
            /* Dark Theme (Default) */
            --bg-main: #0d1117;
            --bg-panel: #161b22;
            --bg-card: #21262d;
            --bg-input: #161b22;
            --border-main: #30363d;
            --border-blue: rgba(30, 58, 138, 0.3);
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --text-strong: #f3f4f6;
            --chart-grid: #374151;
            --chart-text: #e5e7eb;
            --scrollbar-track: #0d1117;
            --scrollbar-thumb: #30363d;
            --scrollbar-hover: #38bdf8;
            
            /* Neon Glows */
            --glow-blue: 0 0 15px rgba(56, 189, 248, 0.2);
            --glow-purple: 0 0 15px rgba(168, 85, 247, 0.2);
            --glow-yellow: 0 0 15px rgba(234, 179, 8, 0.2);
        }

        [data-theme="light"] {
            /* Light Theme Overrides - "Aerospace Platinum" */
            --bg-main: #eef2f6;       
            --bg-panel: #ffffff;      
            --bg-card: #f8fafc;       
            --bg-input: #ffffff;
            --border-main: #cbd5e1;   
            --border-blue: rgba(59, 130, 246, 0.4); 
            --text-main: #1e293b;     
            --text-muted: #64748b;    
            --text-strong: #0f172a;   
            --chart-grid: #e2e8f0;
            --chart-text: #475569;
            --scrollbar-track: #eef2f6;
            --scrollbar-thumb: #94a3b8;
            --scrollbar-hover: #3b82f6;

            /* "Halo" Shadows for Light Mode */
            --glow-blue: 0 10px 25px -5px rgba(59, 130, 246, 0.25), 0 0 4px rgba(59, 130, 246, 0.1);
            --glow-purple: 0 10px 25px -5px rgba(147, 51, 234, 0.25), 0 0 4px rgba(147, 51, 234, 0.1);
            --glow-yellow: 0 10px 25px -5px rgba(234, 179, 8, 0.35), 0 0 4px rgba(234, 179, 8, 0.1);
        }

        /* App-like behavior */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            min-height: 100vh;
            user-select: none; 
            cursor: default;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        input, select, #results-wrapper, #warnings-wrapper, #configs-wrapper, #ai-response-area, h1, h2, h3, h4, p, span {
            user-select: text; 
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-hover); }

        /* Input styling */
        input[type="number"], select {
            background-color: var(--bg-input);
            border: 1px solid var(--border-main);
            color: var(--text-main);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s;
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
            padding-right: 2.5rem; 
        }

        input[type="number"]:focus, select:focus {
            border-color: #38bdf8; 
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3); 
            outline: none;
        }

        /* Ship Arm Card */
        .ship-arm-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-main);
            transition: border-color 0.2s, opacity 0.2s, background-color 0.3s;
        }
        .ship-arm-card:hover {
            border-color: #60a5fa;
        }
        .ship-arm-card.disabled-arm {
            opacity: 0.5;
            border-color: var(--border-main);
        }

        /* Layout */
        .main-container {
            max-width: 2400px;
            width: 98%;
            display: grid;
            gap: 1.5rem;
            margin: 0 auto;
        }
        
        /* AI Box */
        .ai-response-box {
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.9) 100%);
            border: 1px solid rgba(96, 165, 250, 0.3);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.1) inset;
        }
        
        /* Visual Gadget Selector Styling */
        .gadget-radio:checked + div {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }

        @media (min-width: 1440px) {
            .main-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- NEON HOVER CLASSES --- */
        .neon-hover-blue, .neon-hover-purple, .neon-hover-yellow {
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        
        .neon-hover-blue:hover {
            border-color: #3b82f6; 
            box-shadow: var(--glow-blue);
        }
        
        .neon-hover-purple:hover {
            border-color: #a855f7; 
            box-shadow: var(--glow-purple);
        }
        
        .neon-hover-yellow:hover {
            border-color: #eab308; 
            box-shadow: var(--glow-yellow);
        }

        @media (min-width: 1024px) {
            .sticky-column-wrapper {
                position: sticky;
                top: 1rem; 
                max-height: calc(100vh - 2rem); 
                overflow-y: auto; 
                padding-top: 0; 
                -ms-overflow-style: none;  
                scrollbar-width: none;  
            }
            .sticky-column-wrapper::-webkit-scrollbar { display: none; }

            .static-header-pin {
                position: relative;
                z-index: 10; 
                padding: 1.5rem 2rem 1.5rem 2rem; 
                background-color: var(--bg-panel);
                border-bottom: 1px solid var(--border-main);
                margin-bottom: 2rem; 
                transition: background-color 0.3s ease;
            }

            .sticky-scroll-content {
                overflow-y: auto;
                max-height: calc(100vh - 2rem); 
                position: sticky;
                top: 1rem;
                -ms-overflow-style: none; 
                scrollbar-width: none; 
            }
            .sticky-scroll-content::-webkit-scrollbar { display: none; }
        }
    </style>
</head>
<body class="p-4 sm:p-6 flex justify-center items-start">

    <!-- MAIN GRID CONTAINER -->
    <div class="main-container">
        
        <!-- GLOBAL HEADER -->
        <div class="col-span-1 lg:col-span-4 w-full bg-[var(--bg-panel)] rounded-2xl shadow-2xl border border-[var(--border-blue)] p-6 flex flex-col md:flex-row items-center justify-between mb-2 gap-6 transition-colors duration-300">
             <div class="flex flex-col md:flex-row items-center gap-6 text-center md:text-left">
                 <div class="flex-shrink-0 w-24"> 
                    <img src="https://github.com/esramos-design/mfa.github.io/blob/main/mpa.jpg?raw=true" 
                        alt="Mining Fracture Analyser Logo" 
                        class="w-full h-auto rounded-lg object-contain shadow-lg"
                        onerror="this.onerror=null; this.src='https://placehold.co/150x150/161b22/e5e7eb?text=MFA';">
                </div>
                <div class="max-w-4xl">
                    <h1 class="text-2xl font-bold text-[var(--text-main)] mb-2">Mining Fracture Analyser</h1>
                    <p class="text-sm text-[var(--text-muted)] leading-relaxed">
                        Precision calculation engine for industrial crews. Real-time Total Combined Effective Laser Power (MW) calculation accounting for distance, resistance, and module buffs.
                        Updated for latest UEX data.
                    </p>
                </div>
            </div>
            
            <!-- Header Buttons -->
            <div class="flex flex-col gap-2 min-w-[140px] w-full md:w-auto">
                <button onclick="toggleTheme()" 
                        class="px-4 py-2 bg-[var(--bg-card)] hover:bg-[var(--border-main)] text-[var(--text-main)] text-xs font-bold uppercase rounded-lg transition-colors text-center border border-[var(--border-main)] shadow-md flex items-center justify-center gap-2">
                    <span id="theme-icon">‚òÄÔ∏è</span> <span id="theme-text">Light Mode</span>
                </button>

                <a href="https://github.com/esramos-design/mfa.github.io/blob/main/README.md" target="_blank" 
                   class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold uppercase rounded-lg transition-colors text-center border border-gray-600 shadow-md flex items-center justify-center gap-2">
                   <span>üìÑ</span> View Readme
                </a>
                <a href="https://discord.gg/wktsh9h46F" target="_blank"
                   class="px-4 py-2 bg-[#5865F2] hover:bg-[#4752C4] text-white text-xs font-bold uppercase rounded-lg transition-colors text-center border border-blue-500/30 shadow-md flex items-center justify-center gap-2">
                   <span>üí¨</span> Join Discord
                </a>
            </div>
        </div>

        <!-- COLUMN 1: ROCK PARAMS & OCR & GADGETS (Blue Glow) -->
        <div class="w-full">
            <div class="sticky-column-wrapper bg-[var(--bg-panel)] rounded-2xl shadow-2xl border border-[var(--border-blue)] no-scrollbar transition-colors duration-300 neon-hover-blue">
                
                <div class="static-header-pin p-6 sm:p-8 rounded-t-2xl">
                     <h2 class="text-xl font-extrabold text-blue-400 text-center uppercase tracking-wide">Rock Analysis</h2>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- OCR SECTION -->
                    <div class="mb-6 p-1 border-2 border-dashed border-[var(--border-main)] rounded-xl hover:border-blue-400 transition-colors bg-[var(--bg-main)]" id="ocr-drop-zone">
                        <div class="relative flex flex-col items-center justify-center py-6 text-center cursor-pointer" onclick="document.getElementById('fileInput').click()">
                            <div id="ocr-loading" class="absolute inset-0 bg-[var(--bg-main)]/90 z-10 flex flex-col items-center justify-center rounded-xl hidden">
                                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mb-2"></div>
                                <p class="text-blue-400 font-bold animate-pulse">ANALYSING ROCK DATA...</p>
                                <p class="text-xs text-[var(--text-muted)]" id="ocr-status">Initializing Tesseract...</p>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-[var(--text-muted)] mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <p class="text-sm text-[var(--text-muted)] font-semibold">Auto-Scan Rock (OCR)</p>
                            <p class="text-xs text-[var(--text-muted)] mt-1">Click to Upload or <span class="text-blue-400 font-bold">CTRL+V</span> Screenshot</p>
                            <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleFileSelect(this)">
                        </div>
                    </div>

                    <!-- Rock Parameters -->
                    <h2 class="text-lg font-semibold text-blue-300 border-b border-[var(--border-main)] pb-2">Rock Setup</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 bg-[var(--bg-card)] rounded-xl col-span-2 sm:col-span-1">
                            <label for="resistance" class="block text-xs font-medium mb-1 text-[var(--text-muted)]">Base Resistance (%)</label>
                            <input type="number" id="resistance" value="16.0" step="0.1" placeholder="e.g., 16.0"
                                    class="w-full p-2 rounded-lg text-sm font-mono" oninput="calculate()">
                        </div>
                        <div class="p-3 bg-[var(--bg-card)] rounded-xl col-span-2 sm:col-span-1">
                            <label for="instability" class="block text-xs font-medium mb-1 text-[var(--text-muted)]">Base Instability (%)</label>
                            <input type="number" id="instability" value="20.0" step="0.1" placeholder="e.g., 20.0"
                                    class="w-full p-2 rounded-lg text-sm font-mono" oninput="calculate()">
                        </div>
                        <div class="p-3 bg-[var(--bg-card)] rounded-xl col-span-2">
                            <label for="rockMass" class="block text-xs font-medium mb-1 text-[var(--text-muted)]">Target Rock Mass (kg)</label>
                            <input type="number" id="rockMass" value="23922" placeholder="e.g., 23922"
                                    class="w-full p-2 rounded-lg text-sm font-mono" oninput="calculate()">
                        </div>
                    </div>
                    <button onclick="calculate()"
                            class="w-full p-4 text-lg font-bold rounded-xl transition-all duration-200 
                                bg-indigo-600 hover:bg-indigo-700 shadow-md hover:shadow-lg active:scale-95 text-white border border-indigo-500">
                        RUN SIMULATION
                    </button>

                    <!-- VISUAL GADGET LIST (Moved from Col 2) -->
                    <div class="mt-6 p-4 bg-[var(--bg-card)] rounded-xl border border-[var(--border-main)]">
                        <label class="block text-sm font-medium mb-3 text-[var(--text-muted)] border-b border-[var(--border-main)] pb-2">Select Active Gadget</label>
                        
                        <!-- INCREASED HEIGHT TO 600px TO SHOW ALL -->
                        <div id="gadget-list-container" class="space-y-3 max-h-[600px] overflow-y-auto no-scrollbar pr-1">
                            <!-- Populated by JS -->
                        </div>
                        
                        <!-- Hidden input to store selected gadget value -->
                        <input type="hidden" id="gadgetSelect" value="None">
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUMN 2: TEAM ASSEMBLY (Blue Glow) -->
        <div class="w-full">
            <div class="sticky-column-wrapper bg-[var(--bg-panel)] rounded-2xl shadow-2xl border border-[var(--border-blue)] no-scrollbar transition-colors duration-300 neon-hover-blue">
                
                <div class="static-header-pin p-6 rounded-t-2xl">
                    <h2 class="text-xl font-extrabold text-blue-400 text-center uppercase tracking-wide">Team Assembly</h2>
                </div>

                <div class="p-6 space-y-6">
                    <div class="p-4 bg-blue-900/10 rounded-xl border border-blue-700/30">
                        <label for="shipSelectToAdd" class="block text-sm font-medium mb-2 text-blue-300">Add Mining Ship</label>
                        <div class="mb-4 flex justify-center bg-black/20 rounded-lg p-2">
                            <img id="selectedShipImage" src="" alt="Selected Ship" class="rounded-lg shadow-md border border-blue-900/50 max-h-32 object-contain w-full hidden">
                        </div>
                        <div class="flex space-x-2">
                            <select id="shipSelectToAdd" class="flex-grow p-3 rounded-lg bg-[var(--bg-input)] border border-[var(--border-main)] text-[var(--text-main)] text-sm" onchange="updateShipImage()">
                                <!-- Options populated by JS -->
                            </select>
                            <button onclick="addShipLoadout()"
                                    class="p-3 text-sm font-bold rounded-lg transition-all duration-200 
                                        bg-blue-600 hover:bg-blue-700 shadow-md active:scale-95 whitespace-nowrap text-white">
                                + Add
                            </button>
                        </div>
                    </div>

                    <h2 class="text-lg font-semibold text-[var(--text-muted)] border-b border-[var(--border-main)] pb-2">Active Laser Heads:</h2>
                    <div id="multiShipContainer" class="space-y-4 min-h-[100px] p-2 rounded-xl">
                        <p id="empty-state-msg" class="text-center text-[var(--text-muted)] text-sm p-4 border border-dashed border-[var(--border-main)] rounded-lg">
                            Add ships above to configure their mining laser heads.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUMN 3: ANALYTIC RESULTS & CHARTS (Purple Glow) -->
        <div class="w-full">
            <div id="results-wrapper" class="sticky-scroll-content bg-[var(--bg-panel)] p-6 rounded-2xl shadow-2xl border border-[var(--border-blue)] space-y-6 no-scrollbar transition-colors duration-300 neon-hover-purple">
                
                <h2 class="text-xl font-extrabold text-blue-400 text-center uppercase tracking-wide">Analytics</h2>

                <section id="results" class="pt-2">
                    <p class="text-center text-[var(--text-muted)] italic text-sm">Configure your loadout to see results.</p>
                </section>

                <div class="p-4 bg-[var(--bg-card)] rounded-xl border border-purple-600/30">
                   <h3 class="text-xs font-bold text-purple-400 mb-2 text-center uppercase">Power vs. Resistance Curve</h3>
                   <div class="h-48 w-full"><canvas id="resistanceChart"></canvas></div>
               </div>
                 
                <div class="p-4 bg-[var(--bg-card)] rounded-xl border border-yellow-600/30">
                    <h3 class="text-xs font-bold text-yellow-500 mb-2 text-center uppercase">Risk Profile</h3>
                    <div class="h-48 w-full"><canvas id="modChart"></canvas></div>
                </div>

                <div class="p-4 bg-[var(--bg-card)] rounded-xl border border-blue-600/30">
                    <h3 class="text-xs font-bold text-blue-400 mb-2 text-center uppercase">Power vs. Margin</h3>
                    <div class="h-32 w-full"><canvas id="powerChart"></canvas></div>
                </div>
                
                <footer class="pt-4 border-t border-[var(--border-main)] text-center text-xs">
                    <p class="text-[var(--text-muted)]">MFA v3.6 Enhanced</p>
                </footer>
            </div>
        </div>

        <!-- COLUMN 4: AI, WARNINGS & RECOMMENDATIONS (Yellow Glow) -->
        <div class="w-full">
            <div id="warnings-wrapper" class="sticky-scroll-content bg-[var(--bg-panel)] p-6 rounded-2xl shadow-2xl border border-[var(--border-blue)] space-y-6 no-scrollbar transition-colors duration-300 neon-hover-yellow">
                
                <!-- AI SECTION -->
                <div id="ai-section" class="hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-purple-400 uppercase tracking-widest flex items-center gap-2">
                            <span class="text-lg">ü§ñ</span> AI Senior Foreman
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="askAI('briefing')" class="px-3 py-1 text-xs font-bold text-white bg-blue-600 hover:bg-blue-700 rounded transition-colors shadow-lg shadow-blue-900/20">
                                ‚ú® Orders
                            </button>
                            <button onclick="askAI('strategy')" class="px-3 py-1 text-xs font-bold text-white bg-purple-600 hover:bg-purple-700 rounded transition-colors shadow-lg shadow-purple-900/20">
                                ‚ú® Strategy
                            </button>
                        </div>
                    </div>
                    
                    <div class="ai-response-box p-4 rounded-lg relative min-h-[100px]">
                        <div id="ai-loading" class="hidden absolute inset-0 flex items-center justify-center bg-gray-900/80 rounded-lg z-10">
                            <div class="flex flex-col items-center">
                                <div class="w-2 h-2 bg-blue-400 rounded-full animate-ping mb-2"></div>
                                <p class="text-xs text-blue-300 font-mono animate-pulse">Establishing Comms...</p>
                            </div>
                        </div>
                         <div id="ai-content" class="text-sm text-gray-300 font-mono leading-relaxed whitespace-pre-wrap">
                            <span class="text-gray-500 italic">// Awaiting uplink... Run simulation first.</span>
                         </div>
                    </div>
                </div>

                <h2 class="text-xl font-extrabold text-yellow-500 text-center uppercase tracking-wide border-t border-[var(--border-main)] pt-6">Analysis & Fleet Solutions</h2>
                
                <section id="warnings" class="pt-2">
                    <p class="text-center text-[var(--text-muted)] italic text-sm">Warnings and requirements will appear here.</p>
                </section>
                
                 <h3 class="text-lg font-extrabold text-green-500 text-center uppercase tracking-wide border-t border-[var(--border-main)] pt-6">Recommended Loadouts</h3>
                <section id="configs" class="pt-2">
                    <p class="text-center text-[var(--text-muted)] italic text-sm">Fleet recommendations will appear here.</p>
                </section>

            </div>
        </div>

    </div>

    <script>
        const apiKey = ""; // API Key provided by environment
        
        function initTheme() {
            const storedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', storedTheme);
            updateThemeIcon(storedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            
            if (currentSimState.power > 0) {
                calculate();
            }
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            if (theme === 'light') {
                icon.textContent = 'üåô';
                text.textContent = 'Dark Mode';
            } else {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Light Mode';
            }
        }
        
        // --- SIMULATION LOGIC ---
        let currentSimState = {
            mass: 0,
            resistance: 0,
            instability: 0,
            power: 0,
            success: false,
            activeArms: 0
        };

        async function askAI(mode) {
            const aiLoading = document.getElementById('ai-loading');
            const aiContent = document.getElementById('ai-content');
            
            if (currentSimState.power === 0) {
                aiContent.innerHTML = `<span class="text-yellow-500">// ERROR: No simulation data. Please run the simulation first.</span>`;
                return;
            }

            aiLoading.classList.remove('hidden');
            aiContent.innerHTML = ''; 

            let prompt = "";
            const rockDetails = `Rock Mass: ${currentSimState.mass}kg, Resistance: ${currentSimState.resistance.toFixed(1)}%, Instability: ${currentSimState.instability.toFixed(1)}%.`;
            const crewDetails = `Crew Power: ${currentSimState.power.toFixed(0)} MW from ${currentSimState.activeArms} active laser heads.`;
            const status = currentSimState.success ? "FRACTURE POSSIBLE" : "FRACTURE IMPOSSIBLE (Low Power)";

            if (mode === 'strategy') {
                prompt = `You are an expert Senior Mining Foreman in Star Citizen. 
                Analyze this mining scenario:
                ${rockDetails}
                ${crewDetails}
                Status: ${status}.
                
                Provide a short, strategic assessment (max 100 words).
                1. Is this safe? (High instability means risk of explosion).
                2. Suggest specific Modules (e.g., Stampede for instability, Surge for power, Brandt for resistance) or Gadgets (BoreMax, Sabir) if the rock is difficult.
                3. Use sci-fi terminology appropriate for Star Citizen.`;
            } else if (mode === 'briefing') {
                 prompt = `You are a Mining Crew Commander in Star Citizen.
                 Generate a short, tactical 'Copy/Paste' order for the crew chat.
                 Scenario:
                 ${rockDetails}
                 ${crewDetails}
                 
                 The briefing should:
                 1. Be brief and commanding.
                 2. Call out the target mass and resistance.
                 3. If power is low, order them to use modules (Surge!). If instability is high, order them to be careful.
                 4. Format it like a transmission: "/// COMMAND UPLINK /// ... "`;
            }

            try {
                const response = await callGemini(prompt);
                aiContent.innerHTML = marked.parse(response);
            } catch (error) {
                aiContent.innerHTML = `<span class="text-red-500">// COMM LINK FAILURE: ${error.message}</span>`;
            } finally {
                aiLoading.classList.add('hidden');
            }
        }

        async function callGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            let attempts = 0;
            const maxAttempts = 3;
            const delays = [1000, 2000, 4000];
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (e) {
                    attempts++;
                    if (attempts >= maxAttempts) throw e;
                    await new Promise(r => setTimeout(r, delays[attempts - 1]));
                }
            }
        }

        let powerChart = null;
        let modChart = null;
        let resistanceChart = null;

        const ships = [
            { id: "mole", name: "Argo MOLE", arms: 3, maxLaserSize: 2, defaultLaser: 4080, moduleSlots: 3, isFixedLaser: false }, 
            { id: "prospector", name: "MISC Prospector", arms: 1, maxLaserSize: 1, defaultLaser: 3150, moduleSlots: 2, isFixedLaser: false }, 
            { id: "golem", name: "Drake Golem", arms: 1, maxLaserSize: 1, defaultLaser: 2700, moduleSlots: 2, isFixedLaser: true, fixedLaserName: "Pitman (~2700 MW)" } 
        ];

        const allLaserHeads = [
            { name: "Arbor MHV", size: 0, power: 1890, moduleSlots: 1, resistanceEffect: 25, instabilityEffect: -35, optimalWindow: 1.0, shatterDamage: 50, extractionRate: 1.0, inertFiltering: 0.0, optimalChargeRate: 1.0, overchargeRate: 1.0 }, 
            { name: "S0 Helix", size: 0, power: 1000, moduleSlots: 0, resistanceEffect: -30, instabilityEffect: 0, optimalWindow: 0.7, shatterDamage: 80, extractionRate: 1.2, inertFiltering: -0.1, optimalChargeRate: 1.2, overchargeRate: 1.2 }, 
            { name: "S00 Hofstede", size: 0, power: 500, moduleSlots: 0, resistanceEffect: -30, instabilityEffect: 10, optimalWindow: 1.5, shatterDamage: 40, extractionRate: 1.0, inertFiltering: 0.0, optimalChargeRate: 2.0, overchargeRate: 1.0 }, 
            { name: "Lawson", size: 0, power: 1890, moduleSlots: 0, resistanceEffect: 0, instabilityEffect: 0, optimalWindow: 1.0, shatterDamage: 50, extractionRate: 1.0, inertFiltering: 0.0, optimalChargeRate: 1.0, overchargeRate: 1.0 },
            { name: "Pitman", size: 0, power: 3150, moduleSlots: 2, resistanceEffect: 25, instabilityEffect: 35, optimalWindow: 0.8, shatterDamage: 90, extractionRate: 1.1, inertFiltering: 0.0, optimalChargeRate: 1.1, overchargeRate: 1.3 }, 
            { name: "Arbor MH1", size: 1, power: 1890, moduleSlots: 1, resistanceEffect: 25, instabilityEffect: -35, optimalWindow: 1.0, shatterDamage: 50, extractionRate: 1.0, inertFiltering: 0.0, optimalChargeRate: 1.0, overchargeRate: 1.0 },
            { name: "Helix I", size: 1, power: 3150, moduleSlots: 2, resistanceEffect: -30, instabilityEffect: 0.0, optimalWindow: 0.6, shatterDamage: 80, extractionRate: 1.0, inertFiltering: -0.15, optimalChargeRate: 1.2, overchargeRate: 1.5 },
            { name: "Hofstede-S1", size: 1, power: 2100, moduleSlots: 1, resistanceEffect: -30, instabilityEffect: 10, optimalWindow: 1.5, shatterDamage: 40, extractionRate: 1.0, inertFiltering: 0.0, optimalChargeRate: 2.0, overchargeRate: 1.0 },
            { name: "Impact I", size: 1, power: 2100, moduleSlots: 2, resistanceEffect: 10, instabilityEffect: -10, optimalWindow: 1.1, shatterDamage: 60, extractionRate: 1.3, inertFiltering: 0.0, optimalChargeRate: 1.3, overchargeRate: 1.1 },
            { name: "Klein-S1", size: 1, power: 2220, moduleSlots: 0, resistanceEffect: -45, instabilityEffect: 35, optimalWindow: 0.9, shatterDamage: 70, extractionRate: 1.1, inertFiltering: 0.0, optimalChargeRate: 1.5, overchargeRate: 1.2 },
            { name: "Lancet MH1", size: 1, power: 1400, moduleSlots: 1, resistanceEffect: -10, instabilityEffect: -75, optimalWindow: 3.0, shatterDamage: 30, extractionRate: 0.8, inertFiltering: 0.2, optimalChargeRate: 0.5, overchargeRate: 0.5 },
            { name: "Arbor MH2", size: 2, power: 2400, moduleSlots: 2, resistanceEffect: 25, instabilityEffect: -35, optimalWindow: 1.0, shatterDamage: 50, extractionRate: 1.0, inertFiltering: 0.0, optimalChargeRate: 1.0, overchargeRate: 1.0 },
            { name: "Helix II", size: 2, power: 4080, moduleSlots: 3, resistanceEffect: -30, instabilityEffect: 0.0, optimalWindow: 0.6, shatterDamage: 80, extractionRate: 1.0, inertFiltering: -0.2, optimalChargeRate: 1.2, overchargeRate: 1.5 },
            { name: "Hofstede-S2", size: 2, power: 3360, moduleSlots: 2, resistanceEffect: -30, instabilityEffect: 10, optimalWindow: 1.5, shatterDamage: 40, extractionRate: 1.0, inertFiltering: 0.0, optimalChargeRate: 2.0, overchargeRate: 1.0 },
            { name: "Impact II", size: 2, power: 3360, moduleSlots: 3, resistanceEffect: 10, instabilityEffect: -10, optimalWindow: 1.1, shatterDamage: 60, extractionRate: 1.3, inertFiltering: 0.0, optimalChargeRate: 1.3, overchargeRate: 1.1 },
            { name: "Klein-S2", size: 2, power: 3600, moduleSlots: 1, resistanceEffect: -45, instabilityEffect: 35, optimalWindow: 0.9, shatterDamage: 70, extractionRate: 1.1, inertFiltering: 0.0, optimalChargeRate: 1.5, overchargeRate: 1.2 },
            { name: "Lancet MH2", size: 2, power: 1800, moduleSlots: 2, resistanceEffect: -20, instabilityEffect: -75, optimalWindow: 3.0, shatterDamage: 30, extractionRate: 0.8, inertFiltering: 0.3, optimalChargeRate: 0.5, overchargeRate: 0.5 },
        ].sort((a, b) => {
            if (b.size !== a.size) return b.size - a.size;
            return b.power - a.power;
        });

        const powerModules = [
            { name: "Surge (Active)", multiplier: 1.50, resistanceEffect: -15, instabilityEffect: 10, activation: 'Active', windowEffect: 0, extractionEffect: 0, inertEffect: 0 },
            { name: "Brandt (Active)", multiplier: 1.35, resistanceEffect: 15, instabilityEffect: 0.0, activation: 'Active', windowEffect: 0, extractionEffect: 0, inertEffect: 0 },
            { name: "Stampede (Active)", multiplier: 1.35, resistanceEffect: 0.0, instabilityEffect: -10, activation: 'Active', windowEffect: 0, extractionEffect: 0, inertEffect: 0 },
            { name: "Forel (Active)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0, activation: 'Active', windowEffect: 60, extractionEffect: 0, inertEffect: 0 },
            { name: "Lifeline (Active)", multiplier: 1.00, resistanceEffect: -15, instabilityEffect: -20.0, activation: 'Active', windowEffect: 0, extractionEffect: 0, inertEffect: 0 },
            { name: "Torpid (Active)", multiplier: 0.60, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Active', windowEffect: 0, extractionEffect: 0, inertEffect: 0 }, 
            { name: "Rime (Active)", multiplier: 0.85, resistanceEffect: -25, instabilityEffect: -10.0, activation: 'Active', windowEffect: 0, extractionEffect: 0, inertEffect: 0 },
            { name: "Optimum (Active)", multiplier: 0.85, resistanceEffect: 0.0, instabilityEffect: -10.0, activation: 'Active', windowEffect: 20, extractionEffect: 0, inertEffect: 0 },
            { name: "Rieger-C3 (Passive)", multiplier: 1.25, resistanceEffect: 0.0, instabilityEffect: -1, activation: 'Passive', windowEffect: -1, extractionEffect: 0, inertEffect: 0 },
            { name: "Rieger-C2 (Passive)", multiplier: 1.20, resistanceEffect: 0.0, instabilityEffect: -3, activation: 'Passive', windowEffect: -3, extractionEffect: 0, inertEffect: 0 },
            { name: "Rieger (Passive)", multiplier: 1.15, resistanceEffect: 0.0, instabilityEffect: -10, activation: 'Passive', windowEffect: 0, extractionEffect: 0, inertEffect: 0 },
            { name: "Focus III (Passive)", multiplier: 0.95, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive', windowEffect: 40, extractionEffect: 0, inertEffect: 0 },
            { name: "Focus II (Passive)", multiplier: 0.90, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive', windowEffect: 37, extractionEffect: 0, inertEffect: 0 },
            { name: "Focus (Passive)", multiplier: 0.85, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive', windowEffect: 30, extractionEffect: 0, inertEffect: 0 },
            { name: "Torrent III (Passive)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 40, activation: 'Passive', windowEffect: 0, extractionEffect: 25, inertEffect: 0 }, 
            { name: "Torrent II (Passive)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 35, activation: 'Passive', windowEffect: 0, extractionEffect: 20, inertEffect: 0 }, 
            { name: "Torrent (Passive)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 30, activation: 'Passive', windowEffect: 0, extractionEffect: 15, inertEffect: 0 }, 
            { name: "XTR-XL (Passive)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive', windowEffect: 25, extractionEffect: 0, inertEffect: 24 },
            { name: "XTR-L (Passive)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive', windowEffect: 22, extractionEffect: 0, inertEffect: 23 },
            { name: "XTR (Passive)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive', windowEffect: 15, extractionEffect: 0, inertEffect: 20 },
            { name: "FLTR-XL (Passive)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive', windowEffect: 0, extractionEffect: 0, inertEffect: 24 },
            { name: "FLTR-L (Passive)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive', windowEffect: 0, extractionEffect: 0, inertEffect: 23 },
            { name: "FLTR (Passive)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive', windowEffect: 0, extractionEffect: 0, inertEffect: 20 },
            { name: "Vaux-C3 (Passive)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive', windowEffect: 0, extractionEffect: 0, inertEffect: 0 },
            { name: "None", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Default', windowEffect: 0, extractionEffect: 0, inertEffect: 0 },
        ]; 
        
        function sortModules(modules) {
            return modules.sort((a, b) => {
                if (a.name === 'None') return -1;
                if (b.name === 'None') return 1;
                if (a.activation === 'Active' && b.activation === 'Passive') return -1;
                if (a.activation === 'Passive' && b.activation === 'Active') return 1;
                if (a.multiplier !== b.multiplier) {
                    return b.multiplier - a.multiplier;
                }
                return a.name.localeCompare(b.name);
            });
        }
        const sortedModules = sortModules([...powerModules]); 

        const gadgets = [
            { name: "Sabir (-50% Res, +15% Inst)", reduction: -50.0, instabilityEffect: 15, type: 'Multiplicative', desc: "-50% Resistance, +15% Instability" }, 
            { name: "OptiMax (-30% Res, -30% Win)", reduction: -30.0, instabilityEffect: 0.0, type: 'Multiplicative', desc: "-30% Resistance, -30% Window Size" },
            { name: "BoreMax (+10% Res, -70% Inst)", reduction: 10.0, instabilityEffect: -70, type: 'Additive', desc: "+10% Resistance, -70% Instability" }, 
            { name: "Waveshift (-35% Inst, +100% Win)", reduction: 0.0, instabilityEffect: -35, type: 'Utility', desc: "-35% Instability, +100% Window Size" }, 
            { name: "Stalwart (-35% Inst, -30% Res)", reduction: -30.0, instabilityEffect: -35, type: 'Utility', desc: "-35% Instability, -30% Resistance" }, 
            { name: "Okunis (+100% Rate, +50% Win)", reduction: 0.0, instabilityEffect: 0.0, type: 'Utility', desc: "+100% Rate, +50% Window Size" },
            { name: "None", reduction: 0.0, instabilityEffect: 0.0, type: 'None', desc: "No Gadget Attached" }, 
        ].sort((a, b) => {
            // Sort None to top, then by reduction
            if (a.name === "None") return -1;
            if (b.name === "None") return 1;
            return b.reduction - a.reduction;
        });

        let armIdCounter = 0; 

        function createArmConfigHtml(armIndex, ship) {
            armIdCounter++; 
            const armUniqueId = `arm-${ship.id}-${armIdCounter}`;
            const isFixedLaser = ship.isFixedLaser; 

            const availableHeads = allLaserHeads.filter(head => {
                if (ship.id === 'golem') return head.name.includes('Pitman');
                if (head.name.includes('Pitman')) return false; 
                if (head.size === 0) return false; 
                if (ship.id === 'mole') return head.size === 2; 
                if (ship.id === 'prospector') return head.size === 1; 
                return head.size <= ship.maxLaserSize;
            });

            const generateOption = (head) => {
                let isSelected = false;
                if (ship.id === 'mole' && head.name.includes('Helix II')) isSelected = true;
                else if (ship.id === 'prospector' && head.name.includes('Helix I')) isSelected = true;
                else if (ship.id === 'golem' && head.name.includes('Pitman')) isSelected = true;

                return `<option 
                        value="${head.power}" 
                        data-slots="${head.moduleSlots}" 
                        data-resistance="${head.resistanceEffect}" 
                        data-instability="${head.instabilityEffect}" 
                        ${isSelected ? 'selected' : ''}>
                            ${head.name} (${head.moduleSlots} Slots)
                        </option>`;
            };

            const size2Heads = availableHeads.filter(h => h.size === 2);
            const size1Heads = availableHeads.filter(h => h.size === 1);
            let laserOptionsHtml = '';

            if (size2Heads.length > 0) {
                laserOptionsHtml += `<optgroup label="Size 2 Laser Heads">`;
                laserOptionsHtml += size2Heads.map(generateOption).join('');
                laserOptionsHtml += `</optgroup>`;
            }
            if (size1Heads.length > 0) {
                laserOptionsHtml += `<optgroup label="Size 1 Laser Heads">`;
                laserOptionsHtml += size1Heads.map(generateOption).join('');
                laserOptionsHtml += `</optgroup>`;
            }
            if (laserOptionsHtml === '' && availableHeads.length > 0) {
                 laserOptionsHtml = availableHeads.map(generateOption).join('');
            }

            let laserSelectAttributes = '';
            let laserSelectDisabled = '';
            
            let defaultLaserData;
            if (isFixedLaser) {
                defaultLaserData = allLaserHeads.find(h => h.name.includes(ship.fixedLaserName.split('(')[0].trim()));
            } else {
                defaultLaserData = allLaserHeads.find(h => h.power === ship.defaultLaser);
            }
            const actualMaxSlots = defaultLaserData?.moduleSlots || ship.moduleSlots;

            if (isFixedLaser) {
                laserSelectDisabled = 'disabled';
                const pitmanLaser = allLaserHeads.find(h => h.name.includes('Pitman'));
                laserOptionsHtml = `<option value="${pitmanLaser.power}" data-slots="${actualMaxSlots}" data-resistance="${pitmanLaser.resistanceEffect}" data-instability="${pitmanLaser.instabilityEffect}" selected>${ship.fixedLaserName} (Fixed, ${actualMaxSlots} Slots)</option>`;
            } else {
                laserSelectAttributes = `onchange="updateLaserConfig(this, '${armUniqueId}'); calculate();"`;
            }
            
            const activeModulesHtml = sortedModules.filter(m => m.activation === 'Active').map(mod => `<option value="${mod.name}">${mod.name}</option>`).join('');
            const passiveModulesHtml = sortedModules.filter(m => m.activation === 'Passive').map(mod => `<option value="${mod.name}">${mod.name}</option>`).join('');
            const defaultOption = `<option value="None" selected>None</option>`;
            const finalModuleOptions = `${defaultOption}<optgroup label="Active Modules">${activeModulesHtml}</optgroup><optgroup label="Passive Modules">${passiveModulesHtml}</optgroup>`;

            let moduleSlotsHtml = '<div id="module-slots-container-' + armUniqueId + '">';
            for (let i = 1; i <= 3; i++) {
                const isDisabled = i > actualMaxSlots;
                const slotText = isDisabled ? `--- SLOT DISABLED (${actualMaxSlots} Slots Max) ---` : `Module Slot ${i}`;
                const disabledClass = isDisabled ? 'opacity-50' : '';
                const toggleContainerId = `${armUniqueId}-mod${i}-toggle-container`;
                const toggleId = `${armUniqueId}-mod${i}-active-toggle`;
                
                moduleSlotsHtml += `
                    <div class="flex items-center gap-2 mb-3">
                        <select id="${armUniqueId}-mod${i}" class="arm-module-select flex-grow p-3 rounded-lg bg-[var(--bg-input)] border border-[var(--border-main)] text-[var(--text-main)] ${disabledClass}" 
                                onchange="checkModuleActive(this, '${toggleContainerId}'); calculate()" ${isDisabled ? 'disabled' : ''}>
                            ${isDisabled ? `<option value="None">${slotText}</option>` : finalModuleOptions}
                        </select>
                        <div id="${toggleContainerId}" class="hidden flex-col items-center justify-center bg-[var(--bg-input)] border border-[var(--border-blue)] rounded px-2 py-1 h-full ml-1 min-h-[50px] min-w-[60px]">
                            <span class="text-[9px] text-blue-300 font-bold mb-1 leading-none uppercase tracking-wide">Active</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="${toggleId}" class="sr-only peer" checked onchange="calculate()">
                                <div class="w-8 h-4 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-500"></div>
                            </label>
                        </div>
                    </div>`;
            }
            moduleSlotsHtml += '</div>';

            return `
                <div id="${armUniqueId}" class="p-4 rounded-xl shadow-lg ship-arm-card space-y-3" data-ship-id="${ship.id}" data-max-modules="${actualMaxSlots}">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-2">
                            <h4 class="text-lg font-bold ${ship.id === 'mole' ? 'text-indigo-400' : ship.id === 'prospector' ? 'text-green-500' : 'text-amber-500'}">
                                ${ship.name} - Head ${armIndex}
                            </h4>
                            <label class="relative inline-flex items-center cursor-pointer ml-3">
                                <input type="checkbox" id="${armUniqueId}-enable" class="sr-only peer" checked onchange="toggleArm('${armUniqueId}'); calculate();">
                                <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <button onclick="removeArmConfig('${armUniqueId}')" title="Remove Laser Head" class="p-1 bg-red-600 hover:bg-red-700 text-white rounded-full transition-all duration-150 active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <label class="block text-sm font-medium text-[var(--text-muted)]">Laser Head (Base Power)</label>
                    <select id="${armUniqueId}-laser" class="arm-laser-select w-full p-3 rounded-lg bg-[var(--bg-input)] border border-[var(--border-main)] text-[var(--text-main)]"
                            data-max-size="${ship.maxLaserSize}" ${laserSelectAttributes} ${laserSelectDisabled}>
                        ${laserOptionsHtml}
                    </select>
                    <p class="text-xs text-[var(--text-muted)] italic text-right -mt-2 mb-2">Click or tap to view options</p>

                    <label class="block text-sm font-medium text-[var(--text-muted)]">Modules (Max <span id="${armUniqueId}-slot-count">${actualMaxSlots}</span> Slots)</label>
                    ${moduleSlotsHtml}
                </div>
            `;
        }
        
        function checkModuleActive(selectElement, toggleContainerId) {
            const selectedName = selectElement.value;
            const module = powerModules.find(m => m.name === selectedName);
            const container = document.getElementById(toggleContainerId);
            if (container) {
                if (module && module.activation === 'Active') {
                    container.classList.remove('hidden');
                    container.classList.add('flex');
                } else {
                    container.classList.add('hidden');
                    container.classList.remove('flex');
                }
            }
        }
        
        function toggleArm(armId) {
            const container = document.getElementById(armId);
            const checkbox = document.getElementById(armId + '-enable');
            if (checkbox.checked) {
                container.classList.remove('disabled-arm');
            } else {
                container.classList.add('disabled-arm');
            }
        }
        
        function updateLaserConfig(selectElement, armUniqueId) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const newMaxSlots = parseInt(selectedOption.getAttribute('data-slots'));
            const container = document.getElementById(armUniqueId);
            const slotContainer = document.getElementById(`module-slots-container-${armUniqueId}`);
            const slotCountDisplay = document.getElementById(`${armUniqueId}-slot-count`);

            if (!container || !slotContainer) return;

            container.setAttribute('data-max-modules', newMaxSlots);
            slotCountDisplay.textContent = newMaxSlots;

            const activeModulesHtml = sortedModules.filter(m => m.activation === 'Active').map(mod => `<option value="${mod.name}">${mod.name}</option>`).join('');
            const passiveModulesHtml = sortedModules.filter(m => m.activation === 'Passive').map(mod => `<option value="${mod.name}">${mod.name}</option>`).join('');
            const defaultOption = `<option value="None">None</option>`;
            const finalModuleOptions = `${defaultOption}<optgroup label="Active Modules">${activeModulesHtml}</optgroup><optgroup label="Passive Modules">${passiveModulesHtml}</optgroup>`;

            let newModuleSlotsHtml = '';
            for (let i = 1; i <= 3; i++) {
                const isDisabled = i > newMaxSlots;
                const slotText = isDisabled ? `--- SLOT DISABLED (${newMaxSlots} Slots Max) ---` : `Module Slot ${i}`;
                const disabledClass = isDisabled ? 'opacity-50' : '';
                const oldSelect = document.getElementById(`${armUniqueId}-mod${i}`);
                const retainedValue = oldSelect && !isDisabled ? oldSelect.value : 'None'; 
                const retainedModule = powerModules.find(m => m.name === retainedValue);
                const showToggle = retainedModule && retainedModule.activation === 'Active';
                const toggleDisplay = showToggle ? 'flex' : 'hidden';
                const toggleContainerId = `${armUniqueId}-mod${i}-toggle-container`;
                const toggleId = `${armUniqueId}-mod${i}-active-toggle`;
                const oldToggle = document.getElementById(toggleId);
                const wasChecked = oldToggle ? oldToggle.checked : true; 

                let options = isDisabled ? `<option value="None">${slotText}</option>` : finalModuleOptions.replace(`value="${retainedValue}"`, `value="${retainedValue}" selected`);

                newModuleSlotsHtml += `
                    <div class="flex items-center gap-2 mb-3">
                        <select id="${armUniqueId}-mod${i}" class="arm-module-select flex-grow p-3 rounded-lg bg-[var(--bg-input)] border border-[var(--border-main)] text-[var(--text-main)] ${disabledClass}" 
                                onchange="checkModuleActive(this, '${toggleContainerId}'); calculate()" ${isDisabled ? 'disabled' : ''}>
                            ${options}
                        </select>
                        <div id="${toggleContainerId}" class="${toggleDisplay} flex-col items-center justify-center bg-[var(--bg-input)] border border-[var(--border-blue)] rounded px-2 py-1 h-full ml-1 min-h-[50px] min-w-[60px]">
                            <span class="text-[9px] text-blue-300 font-bold mb-1 leading-none uppercase tracking-wide">Active</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="${toggleId}" class="sr-only peer" ${wasChecked ? 'checked' : ''} onchange="calculate()">
                                <div class="w-8 h-4 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-500"></div>
                            </label>
                        </div>
                    </div>`;
            }
            slotContainer.innerHTML = newModuleSlotsHtml;
        }

        function addShipLoadout() {
            const container = document.getElementById('multiShipContainer');
            const selectElement = document.getElementById('shipSelectToAdd');
            const selectedShipId = selectElement.value;
            const shipData = ships.find(s => s.id === selectedShipId);
            if (!shipData) return;

            const placeholder = document.getElementById('empty-state-msg');
            if (placeholder) placeholder.remove();
            
            for (let i = 1; i <= shipData.arms; i++) {
                const armHtml = createArmConfigHtml(i, shipData);
                container.insertAdjacentHTML('beforeend', armHtml);
            }
            calculate();
        }

        function removeArmConfig(armId) {
            const armElement = document.getElementById(armId);
            if (armElement) armElement.remove();
            
            const container = document.getElementById('multiShipContainer');
            if (container.children.length === 0) {
                container.innerHTML = `
                    <p id="empty-state-msg" class="text-center text-[var(--text-muted)] text-sm p-4 border border-dashed border-[var(--border-main)] rounded-lg">
                        Add ships above to configure their mining laser heads.
                    </p>`;
            }
            calculate();
        }

        function updateShipImage() {
            const shipSelectElement = document.getElementById('shipSelectToAdd');
            const selectedShipId = shipSelectElement.value;
            const imageElement = document.getElementById('selectedShipImage');
            let imageUrl = '';
            if (selectedShipId === 'mole') imageUrl = "https://github.com/esramos-design/mfa.github.io/blob/main/mole.jpg?raw=true";
            else if (selectedShipId === 'prospector') imageUrl = "https://github.com/esramos-design/mfa.github.io/blob/main/prospector.jpg?raw=true";
            else if (selectedShipId === 'golem') imageUrl = "https://github.com/esramos-design/mfa.github.io/blob/main/golem.jpg?raw=true";

            if (imageUrl) {
                imageElement.src = imageUrl;
                imageElement.classList.remove('hidden');
            } else {
                imageElement.classList.add('hidden');
            }
        }

        function populateSelects() {
            const shipSelectElement = document.getElementById('shipSelectToAdd');
            if (shipSelectElement && ships.length > 0) {
                shipSelectElement.innerHTML = ships.map((ship) => 
                    `<option value="${ship.id}">${ship.name} (Laser Heads: ${ship.arms})</option>`
                ).join('');
                shipSelectElement.value = 'mole';
                updateShipImage();
            }
            // Populate Visual Gadgets List instead of Select
            populateGadgetList();
            calculate(); 
        }

        function populateGadgetList() {
            const listContainer = document.getElementById('gadget-list-container');
            if (!listContainer) return;

            let html = '';
            gadgets.forEach((gadget, index) => {
                // Generate unique ID
                const gadgetToggleId = `gadget-toggle-${index}`;
                // Default check 'None'
                const isChecked = gadget.name === "None" ? 'checked' : ''; 
                // Determine styling based on type
                let typeColor = 'text-gray-400';
                if(gadget.type === 'Multiplicative') typeColor = 'text-purple-400';
                else if(gadget.type === 'Additive') typeColor = 'text-blue-400';
                else if(gadget.type === 'Utility') typeColor = 'text-green-400';

                html += `
                <div class="relative flex items-center justify-between p-3 rounded-lg bg-[var(--bg-input)] border border-[var(--border-main)] hover:border-blue-500/50 transition-colors cursor-pointer" onclick="document.getElementById('${gadgetToggleId}').click()">
                    <div class="flex-grow">
                        <div class="flex items-center gap-2">
                            <h4 class="text-sm font-bold text-[var(--text-main)]">${gadget.name.split('(')[0]}</h4>
                            <span class="text-[10px] px-1.5 py-0.5 rounded border border-[var(--border-main)] bg-[var(--bg-card)] ${typeColor}">${gadget.type}</span>
                        </div>
                        <p class="text-xs text-[var(--text-muted)] mt-0.5">${gadget.desc}</p>
                    </div>
                    <div class="ml-3">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="radio" name="activeGadget" value="${gadget.name}" id="${gadgetToggleId}" class="gadget-radio sr-only peer" ${isChecked} onchange="handleGadgetToggle(this)">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>`;
            });
            listContainer.innerHTML = html;
        }

        function handleGadgetToggle(radioInput) {
            // Update hidden input for compatibility
            const hiddenInput = document.getElementById('gadgetSelect');
            if(hiddenInput) hiddenInput.value = radioInput.value;
            calculate();
        }

        function assessDifficulty(instability, resistance) {
            let difficultyScore = resistance * 1.5 + instability;
            if (difficultyScore >= 100) return { text: "EXTREME: Very high instability and resistance. Requires exceptional skill and stability modules.", color: "text-red-500" };
            else if (difficultyScore >= 60) return { text: "HARD: High instability/resistance. Requires specialized modules (Forel/Torrent) for safe charging.", color: "text-orange-400" };
            else if (difficultyScore >= 30) return { text: "MODERATE: Average difficulty. Standard play should be fine, but stability modules are helpful.", color: "text-yellow-500" };
            else return { text: "EASY: Low difficulty rock. Minimal risk of overheating or explosion.", color: "text-green-500" };
        }

        function updateCharts(effectivePower, requiredPower, finalResistance, finalInstability, rockMass) {
            const powerCanvas = document.getElementById('powerChart');
            const modCanvas = document.getElementById('modChart');
            const resistanceCanvas = document.getElementById('resistanceChart');

            if (!powerCanvas || !modCanvas || !resistanceCanvas) return;

            const style = getComputedStyle(document.body);
            const gridColor = style.getPropertyValue('--chart-grid').trim();
            const textColor = style.getPropertyValue('--chart-text').trim();

            const powerCtx = powerCanvas.getContext('2d');
            const modCtx = modCanvas.getContext('2d');
            const resistanceCtx = resistanceCanvas.getContext('2d');
            
            if (powerChart) powerChart.destroy();
            if (modChart) modChart.destroy();
            if (resistanceChart) resistanceChart.destroy();

            const margin = effectivePower - requiredPower;
            const success = margin >= 0;
            const totalMax = Math.max(effectivePower, requiredPower) * 1.1; 
            
            const dataPower = effectivePower / 1000;
            const dataRequired = requiredPower / 1000;
            const dataMax = totalMax / 1000;

            powerChart = new Chart(powerCtx, {
                type: 'bar',
                data: {
                    labels: ['Team Power (kMW)', 'Required Power (kMW)'],
                    datasets: [{
                        label: 'Power',
                        data: [dataPower, dataRequired],
                        backgroundColor: [success ? '#10b981' : '#f87171', '#3b82f6'],
                        borderColor: [success ? '#059669' : '#dc2626', '#2563eb'],
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    aspectRatio: 2, 
                    indexAxis: 'y', 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.x !== null) label += (context.parsed.x * 1000).toLocaleString(undefined, { maximumFractionDigits: 2 }) + ' MW';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0,
                            max: dataMax,
                            ticks: {
                                callback: function(value) { return value.toFixed(0) + ' kMW'; },
                                color: textColor 
                            },
                            grid: { color: gridColor } 
                        },
                        y: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    }
                }
            });

            let safeMargin = 100 - (finalResistance + finalInstability);
            if (safeMargin < 0) safeMargin = 0; 

            modChart = new Chart(modCtx, {
                type: 'doughnut',
                data: {
                    labels: [`Resistance (${finalResistance.toFixed(1)}%)`, `Instability (${finalInstability.toFixed(2)}%)`, `Safe Margin (${safeMargin.toFixed(1)}%)`],
                    datasets: [{
                        data: [finalResistance, finalInstability, safeMargin],
                        backgroundColor: ['rgba(239, 68, 68, 0.9)', 'rgba(234, 179, 8, 0.9)', 'rgba(55, 65, 81, 0.5)'],
                        borderColor: 'transparent',
                        borderWidth: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: textColor, font: { size: 11 } } }
                    },
                    cutout: '60%' 
                }
            });

            const resLabels = [];
            const reqData = [];
            const myPowerData = [];
            for(let i=0; i<=100; i+=5) {
                resLabels.push(i + '%');
                let decimal = i / 100.0;
                let req = (rockMass * (1.0 - decimal)) / 5.0;
                reqData.push(req / 1000); 
                myPowerData.push(effectivePower / 1000); 
            }
            
            resistanceChart = new Chart(resistanceCtx, {
                type: 'line',
                data: {
                    labels: resLabels,
                    datasets: [
                        { label: 'Team Power', data: myPowerData, borderColor: '#3b82f6', backgroundColor: '#3b82f6', borderWidth: 2, pointRadius: 0, pointHoverRadius: 5 },
                        { label: 'Required Power (Calc)', data: reqData, borderColor: '#fbbf24', backgroundColor: '#fbbf24', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, pointHoverRadius: 5 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: textColor, font: { size: 10 } } },
                        tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' kMW'; } } }
                    },
                    scales: {
                         x: { ticks: { color: textColor, maxTicksLimit: 11 }, grid: { color: gridColor }, title: { display: true, text: 'Resistance %', color: textColor, font: { size: 10 } } },
                        y: { ticks: { color: textColor }, grid: { color: gridColor }, title: { display: true, text: 'Power (kMW)', color: textColor, font: { size: 10 } } }
                    }
                }
            });
        }

        function generateSmartLoadouts(mass, res, inst, reqPwr, currentPwr) {
            const calcLoadout = (laser, activeM, passiveM1, passiveM2) => {
                const modules = [activeM, passiveM1, passiveM2].filter(Boolean);
                let pwrMult = 1.0;
                let resEff = laser.resistanceEffect;
                let instEff = laser.instabilityEffect;
                let winMult = laser.optimalWindow;
                let extrMult = laser.extractionRate;
                let inertMult = laser.inertFiltering;
                let shatter = laser.shatterDamage;
                let chargeRate = laser.optimalChargeRate;
                let overcharge = laser.overchargeRate;

                modules.forEach(m => {
                    pwrMult *= m.multiplier;
                    resEff += m.resistanceEffect;
                    instEff += m.instabilityEffect;
                    winMult *= (1 + (m.windowEffect / 100));
                    extrMult *= (1 + (m.extractionEffect / 100));
                    inertMult += (m.inertEffect / 100);
                });

                return {
                    laser: laser,
                    modules: modules,
                    stats: { power: laser.power * pwrMult, resistanceRed: resEff, instability: instEff, window: winMult, extraction: extrMult, inert: inertMult, shatter: shatter, chargeRate: chargeRate, overcharge: overcharge }
                };
            };

            const size2Heads = allLaserHeads.filter(h => h.size === 2);
            const size1Heads = allLaserHeads.filter(h => h.size === 1);
            const golemHead = allLaserHeads.find(h => h.name.includes("Pitman"));

            const modSurge = powerModules.find(m => m.name.includes("Surge"));
            const modStampede = powerModules.find(m => m.name.includes("Stampede"));
            const modRieger = powerModules.find(m => m.name.includes("Rieger-C3"));
            const modFocus = powerModules.find(m => m.name.includes("Focus III"));
            const modBrandt = powerModules.find(m => m.name.includes("Brandt"));
            const modTorrent = powerModules.find(m => m.name.includes("Torrent III"));
            const modXtr = powerModules.find(m => m.name.includes("XTR-XL"));

            const breakerLaser = size2Heads.find(h => h.name.includes("Helix II")) || size2Heads[0];
            const breakerLoadout = calcLoadout(breakerLaser, modSurge, modRieger, modRieger);
            const surgeonLaser = size2Heads.find(h => h.name.includes("Lancet MH2")) || size2Heads[0];
            const surgeonLoadout = calcLoadout(surgeonLaser, modBrandt, modFocus, modFocus);
            const vacuumLaser = size2Heads.find(h => h.name.includes("Impact II")) || size2Heads[0];
            const vacuumLoadout = calcLoadout(vacuumLaser, null, modTorrent, modXtr);
            const soloLaser = size1Heads.find(h => h.name.includes("Helix I")) || size1Heads[0];
            const soloLoadout = calcLoadout(soloLaser, modSurge, modRieger, null);
            const golemLoadout = calcLoadout(golemHead, modSurge, modRieger, null);

            let extraShipRec = null;
            if (reqPwr > currentPwr) {
                const deficit = reqPwr - currentPwr;
                const prospectorsNeeded = Math.ceil(deficit / soloLoadout.stats.power);
                const golemsNeeded = Math.ceil(deficit / golemLoadout.stats.power);
                const molesNeeded = Math.ceil(deficit / (breakerLoadout.stats.power * 3));
                extraShipRec = {
                    primary: { count: prospectorsNeeded, type: "Prospector" },
                    secondary: { count: golemsNeeded, type: "Golem" },
                    tertiary: { count: molesNeeded, type: "MOLE" }
                };
            }

            return {
                mole: [
                    { role: "ISOTOPE BREAKER", ...breakerLoadout, desc: "MAX POWER & FRACTURE" },
                    { role: "STABILITY ANCHOR", ...surgeonLoadout, desc: "MAX WINDOW & SAFETY" },
                    { role: "QUANTUM VACUUM", ...vacuumLoadout, desc: "MAX EXTRACTION SPEED" }
                ],
                prospector: { role: "SOLO VANGUARD", ...soloLoadout, desc: "BALANCED SOLO LOADOUT" },
                golem: { role: "PITMAN SPECIAL", ...golemLoadout, desc: "OPTIMIZED FIXED HEAD" }, 
                extra: extraShipRec
            };
        }

        function calculate() {
            const resultsContainer = document.getElementById('results');
            const aiSection = document.getElementById('ai-section');
            const configsContainer = document.getElementById('configs');
            const warningsContainer = document.getElementById('warnings');
            const allArms = document.querySelectorAll('.ship-arm-card');
            
            if (allArms.length === 0) {
                displayResult('No mining laser heads added. Assemble your team above to begin the calculation.', 'text-[var(--text-muted)]');
                if (aiSection) aiSection.classList.add('hidden');
                if (configsContainer) configsContainer.innerHTML = `<p class="text-center text-[var(--text-muted)] italic">Max power configs will appear here.</p>`;
                if (warningsContainer) warningsContainer.innerHTML = `<p class="text-center text-[var(--text-muted)] italic">Warnings will appear here.</p>`;
                if (powerChart) { powerChart.destroy(); powerChart = null; }
                if (modChart) { modChart.destroy(); modChart = null; }
                if (resistanceChart) { resistanceChart.destroy(); resistanceChart = null; }
                return;
            }

            let totalEffectiveLaserPower = 0;
            let totalResistanceMultiplier = 1.0; 
            let totalInstabilityMultiplier = 1.0; 
            let activeArmsCount = 0;

            allArms.forEach(arm => {
                const armUniqueId = arm.id;
                const isEnabledCheck = document.getElementById(`${armUniqueId}-enable`);
                const isEnabled = isEnabledCheck ? isEnabledCheck.checked : true;
                if (!isEnabled) return;
                
                const laserSelect = document.getElementById(`${armUniqueId}-laser`);
                // FIX: Safety check to prevent crash if DOM element is missing
                if (!laserSelect) return; 

                activeArmsCount++;
                const maxModules = parseInt(arm.dataset.maxModules);
                const basePower = parseFloat(laserSelect.value || '0');
                
                // FIX: Check if option exists
                if (laserSelect.selectedIndex === -1) return;
                const selectedOption = laserSelect.options[laserSelect.selectedIndex];
                
                let armResMult = 1.0 + (parseFloat(selectedOption.getAttribute('data-resistance')) || 0) / 100;
                let armInstMult = 1.0 + (parseFloat(selectedOption.getAttribute('data-instability')) || 0) / 100;
                let modPowerMult = 1.0;

                for (let i = 1; i <= 3; i++) { 
                    const moduleSelect = document.getElementById(`${armUniqueId}-mod${i}`);
                    if (moduleSelect && i <= maxModules) { 
                        const modName = moduleSelect.value;
                        const mod = powerModules.find(m => m.name === modName);
                        if (mod && mod.name !== 'None') {
                            const toggleId = `${armUniqueId}-mod${i}-active-toggle`;
                            const toggleEl = document.getElementById(toggleId);
                            const isActive = (!mod.activation || mod.activation !== 'Active') || (toggleEl ? toggleEl.checked : true);
                            
                            if (isActive) {
                                modPowerMult *= mod.multiplier;
                                armResMult *= (1 + (mod.resistanceEffect / 100));
                                armInstMult *= (1 + (mod.instabilityEffect / 100));
                            }
                        }
                    }
                }
                totalResistanceMultiplier *= armResMult;
                totalInstabilityMultiplier *= armInstMult;
                totalEffectiveLaserPower += basePower * modPowerMult;
            });

            if (activeArmsCount > 0) {
                const totalModifierRoot = 1.0 / activeArmsCount;
                totalResistanceMultiplier = Math.pow(totalResistanceMultiplier, totalModifierRoot);
                totalInstabilityMultiplier = Math.pow(totalInstabilityMultiplier, totalModifierRoot);
            }

            const baseResistance = parseFloat(document.getElementById('resistance').value);
            const initialInstability = parseFloat(document.getElementById('instability').value);
            // USE HIDDEN INPUT VALUE FROM VISUAL LIST
            const gadgetSelect = document.getElementById('gadgetSelect');
            const selectedGadget = gadgets.find(g => g.name === gadgetSelect.value);
            const rockMass = parseFloat(document.getElementById('rockMass').value);

            if (selectedGadget) {
                totalResistanceMultiplier *= (1 + (selectedGadget.reduction / 100));
                totalInstabilityMultiplier *= (1 + (selectedGadget.instabilityEffect / 100));
            }

            let finalEffectiveResistance = baseResistance * totalResistanceMultiplier;
            let finalModifiedInstability = initialInstability * totalInstabilityMultiplier;
            if (finalEffectiveResistance < 0) finalEffectiveResistance = 0;
            if (finalModifiedInstability < 0) finalModifiedInstability = 0;

            const resDecimal = finalEffectiveResistance / 100.0;
            let breakableMassLimit = 0;
            let requiredEffectivePower = 0;

            if (resDecimal < 1.0) {
                const denominator = 1.0 - resDecimal;
                breakableMassLimit = (totalEffectiveLaserPower * 5) / denominator;
                requiredEffectivePower = (rockMass * denominator) / 5;
            }
            const isSuccess = breakableMassLimit >= rockMass;

            currentSimState = { mass: rockMass, resistance: finalEffectiveResistance, instability: finalModifiedInstability, power: totalEffectiveLaserPower, success: isSuccess, activeArms: activeArmsCount };
            if (aiSection) aiSection.classList.remove('hidden');

            const formattedEffectivePower = totalEffectiveLaserPower.toLocaleString(undefined, { maximumFractionDigits: 0 });
            const verdictClass = isSuccess ? 'bg-green-700/80' : 'bg-red-700/80';
            const verdictIcon = isSuccess ? '‚úÖ' : '‚ùå';
            const verdictText = isSuccess ? 'FRACTURE SUCCESSFUL' : 'POWER INSUFFICIENT';
            const difficulty = assessDifficulty(finalModifiedInstability, finalEffectiveResistance);

            resultsContainer.innerHTML = `
                <div class="space-y-6 text-[var(--text-main)] text-center">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 rounded-xl bg-[var(--bg-card)] shadow-inner border border-[var(--border-main)]">
                            <p class="text-sm text-[var(--text-muted)]">Final Resistance</p>
                            <p class="text-3xl font-extrabold text-red-400 mt-1">${finalEffectiveResistance.toFixed(1)}%</p>
                        </div>
                        <div class="p-3 rounded-xl bg-[var(--bg-card)] shadow-inner border border-[var(--border-main)]">
                            <p class="text-sm text-[var(--text-muted)]">Final Instability</p>
                            <p class="text-3xl font-extrabold text-purple-400 mt-1">${finalModifiedInstability.toFixed(1)}%</p>
                        </div>
                    </div>
                    <div class="p-3 rounded-xl bg-[var(--bg-card)] shadow-inner border border-indigo-700">
                        <p class="text-sm text-[var(--text-muted)]">Total Effective Power</p>
                        <p class="text-4xl font-extrabold text-yellow-500 mt-1">${formattedEffectivePower} MW</p>
                    </div>
                    <div class="p-4 rounded-xl font-semibold text-lg text-white ${verdictClass} shadow-xl">
                        <p class="text-2xl">${verdictIcon} ${verdictText}</p>
                        <p class="text-xs font-normal mt-1 opacity-80">Req: ${requiredEffectivePower.toFixed(0)} MW</p>
                    </div>
                    <div class="p-4 bg-[var(--bg-card)] rounded-xl border border-[var(--border-main)]">
                        <p class="mt-1 font-bold ${difficulty.color}">${difficulty.text}</p>
                    </div>
                </div>
            `;

            const recommendations = generateSmartLoadouts(rockMass, baseResistance, initialInstability, requiredEffectivePower, totalEffectiveLaserPower);
            
            // New Card Design Function
            const renderNewCard = (rec, colorClass, badgeColor) => {
                const mods = rec.modules.map(m => m.name.replace(/\(Active\)|\(Passive\)/g, '').trim()).join(' + ');
                // Calculate percentages for visual bars (arbitrary scaling for visual flair)
                const powerPct = Math.min((rec.stats.power / 5000) * 100, 100);
                const resPct = Math.min(Math.abs(rec.stats.resistanceRed) * 1.5, 100);
                const stabPct = Math.min(Math.abs(rec.stats.instability) * 2, 100);

                return `
                <div class="group relative mb-4 p-4 rounded-xl bg-[var(--bg-card)] border border-[var(--border-main)] hover:border-${badgeColor}-500 transition-all duration-300 shadow-lg overflow-hidden">
                    <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity">
                        <svg class="w-16 h-16 text-${badgeColor}-500" fill="currentColor" viewBox="0 0 20 20"><path d="M13 7h-6l-4 5.5 4 5.5h6l4-5.5-4-5.5z"/></svg>
                    </div>
                    
                    <div class="flex justify-between items-start border-b border-[var(--border-main)] pb-3 mb-3 relative z-10">
                        <div>
                            <h4 class="text-xs font-black tracking-widest text-${badgeColor}-400 uppercase mb-1">${rec.role}</h4>
                            <p class="text-[10px] text-[var(--text-muted)] font-mono">${rec.desc}</p>
                        </div>
                        <span class="text-[10px] font-bold text-[var(--text-main)] bg-[var(--bg-panel)] px-2 py-1 rounded border border-[var(--border-main)] shadow-sm">
                            ${rec.laser.name}
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-3 relative z-10">
                        <!-- Power Bar -->
                        <div class="col-span-2">
                            <div class="flex justify-between text-[10px] text-[var(--text-muted)] mb-1">
                                <span>OUTPUT</span>
                                <span class="text-yellow-500 font-bold">${(rec.stats.power/1000).toFixed(1)} kMW</span>
                            </div>
                            <div class="w-full bg-[var(--bg-input)] rounded-full h-1.5">
                                <div class="bg-yellow-500 h-1.5 rounded-full" style="width: ${powerPct}%"></div>
                            </div>
                        </div>
                        
                        <!-- Resistance Bar -->
                        <div>
                            <div class="flex justify-between text-[10px] text-[var(--text-muted)] mb-1">
                                <span>RES RED</span>
                                <span class="text-red-400 font-bold">${rec.stats.resistanceRed.toFixed(0)}%</span>
                            </div>
                            <div class="w-full bg-[var(--bg-input)] rounded-full h-1.5">
                                <div class="bg-red-500 h-1.5 rounded-full" style="width: ${resPct}%"></div>
                            </div>
                        </div>

                        <!-- Stability Bar -->
                        <div>
                            <div class="flex justify-between text-[10px] text-[var(--text-muted)] mb-1">
                                <span>STABILITY</span>
                                <span class="text-purple-400 font-bold">${rec.stats.instability.toFixed(0)}%</span>
                            </div>
                            <div class="w-full bg-[var(--bg-input)] rounded-full h-1.5">
                                <div class="bg-purple-500 h-1.5 rounded-full" style="width: ${stabPct}%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 text-[10px] text-[var(--text-muted)] pt-2 border-t border-[var(--border-main)] font-mono relative z-10">
                        <span class="uppercase tracking-wide">Modules:</span>
                        <span class="text-[var(--text-strong)] font-bold truncate" title="${mods}">${mods}</span>
                    </div>
                </div>`;
            };

            let recHtml = `<div class="space-y-4">`;
            
            // --- REDESIGNED REINFORCEMENT BOX ---
            if (recommendations.extra) {
                const deficit = (requiredEffectivePower - totalEffectiveLaserPower).toFixed(0);
                recHtml += `
                <div class="mb-6 p-1 rounded-xl bg-gradient-to-r from-red-600/20 to-orange-600/20 border border-red-500/50 shadow-[0_0_15px_rgba(239,68,68,0.2)]">
                    <div class="bg-[var(--bg-panel)] rounded-lg p-4 relative overflow-hidden">
                        <!-- Striped Warning Background -->
                        <div class="absolute inset-0 opacity-5" style="background-image: repeating-linear-gradient(45deg, #000 0, #000 10px, transparent 10px, transparent 20px);"></div>
                        
                        <div class="flex items-center justify-between mb-3 relative z-10">
                            <h4 class="text-sm font-black text-red-500 uppercase tracking-widest flex items-center gap-2">
                                <span class="animate-pulse">‚ö†Ô∏è</span> INSUFFICIENT POWER
                            </h4>
                            <span class="text-xs font-mono font-bold text-red-400 bg-red-900/20 px-2 py-1 rounded border border-red-500/30">
                                -${deficit} MW
                            </span>
                        </div>

                        <p class="text-[10px] text-[var(--text-muted)] uppercase tracking-wide mb-2 text-center">Deploy Additional Assets:</p>
                        
                        <div class="grid grid-cols-3 gap-2 relative z-10">
                            <div class="flex flex-col items-center bg-[var(--bg-input)] p-2 rounded border border-green-900/30">
                                <span class="text-lg font-bold text-green-500">+${recommendations.extra.primary.count}</span>
                                <span class="text-[8px] uppercase text-[var(--text-muted)]">Prospector</span>
                            </div>
                            <div class="flex flex-col items-center bg-[var(--bg-input)] p-2 rounded border border-orange-900/30">
                                <span class="text-lg font-bold text-orange-500">+${recommendations.extra.secondary.count}</span>
                                <span class="text-[8px] uppercase text-[var(--text-muted)]">Golem</span>
                            </div>
                            <div class="flex flex-col items-center bg-[var(--bg-input)] p-2 rounded border border-indigo-900/30">
                                <span class="text-lg font-bold text-indigo-500">+${recommendations.extra.tertiary.count}</span>
                                <span class="text-[8px] uppercase text-[var(--text-muted)]">MOLE</span>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            recHtml += `<div class="flex items-center gap-2 mb-4"><div class="h-px flex-1 bg-[var(--border-main)]"></div><span class="text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-widest">OPTIMAL CONFIGURATIONS</span><div class="h-px flex-1 bg-[var(--border-main)]"></div></div>`;
            
            // MOLE SECTION
            recHtml += `<div class="relative pl-3 border-l-2 border-indigo-500/30 mb-6">`;
            recHtml += `<h4 class="text-xs font-black text-indigo-400 uppercase mb-3 flex items-center gap-2">ARGO MOLE <span class="text-[9px] text-[var(--text-muted)] font-normal ml-auto">Size 2 Hardpoints</span></h4>`;
            recHtml += renderNewCard(recommendations.mole[0], 'text-red-400', 'indigo');
            recHtml += renderNewCard(recommendations.mole[1], 'text-blue-400', 'indigo');
            recHtml += renderNewCard(recommendations.mole[2], 'text-green-400', 'indigo');
            recHtml += `</div>`;

            // PROSPECTOR SECTION
            recHtml += `<div class="relative pl-3 border-l-2 border-green-500/30 mb-6">`;
            recHtml += `<h4 class="text-xs font-black text-green-400 uppercase mb-3 flex items-center gap-2">MISC PROSPECTOR <span class="text-[9px] text-[var(--text-muted)] font-normal ml-auto">Size 1 Hardpoint</span></h4>`;
            recHtml += renderNewCard(recommendations.prospector, 'text-yellow-400', 'green');
            recHtml += `</div>`;
            
            // GOLEM SECTION
             recHtml += `<div class="relative pl-3 border-l-2 border-orange-500/30">`;
             recHtml += `<h4 class="text-xs font-black text-orange-400 uppercase mb-3 flex items-center gap-2">DRAKE GOLEM <span class="text-[9px] text-[var(--text-muted)] font-normal ml-auto">Fixed Size 0</span></h4>`;
             recHtml += renderNewCard(recommendations.golem, 'text-orange-400', 'orange');
             recHtml += `</div></div>`;

            configsContainer.innerHTML = recHtml;
            warningsContainer.innerHTML = ''; 

            updateCharts(totalEffectiveLaserPower, requiredEffectivePower, finalEffectiveResistance, finalModifiedInstability, rockMass);
        }

        function displayResult(message, className) {
            document.getElementById('results').innerHTML = `<p class="text-center mt-4 ${className} font-bold text-lg">${message}</p>`;
        }
        
        // --- OCR FUNCTIONALITY ---
        document.addEventListener('paste', function(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    const blob = item.getAsFile();
                    processOCR(blob);
                    break; 
                }
            }
        });

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                processOCR(input.files[0]);
            }
        }

        async function processOCR(imageBlob) {
            const loadingOverlay = document.getElementById('ocr-loading');
            const statusText = document.getElementById('ocr-status');
            
            loadingOverlay.classList.remove('hidden');
            statusText.innerText = "Preprocessing Image...";

            try {
                const worker = await Tesseract.createWorker();
                statusText.innerText = "Recognizing Text...";
                const ret = await worker.recognize(imageBlob);
                const text = ret.data.text;
                statusText.innerText = "Parsing Data...";
                applyScannedData(text);
                await worker.terminate();
            } catch (err) {
                console.error(err);
                alert("Failed to scan image. Please ensure the screenshot is clear.");
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function applyScannedData(text) {
            const numberGroup = "([\\d][\\d\\s,.]*)"; 
            const separators = "[\\s:.]*"; 
            const massRegex = new RegExp("(?:Mass|Mas|M|Rock Mass)" + separators + numberGroup, "i");
            const resRegex = new RegExp("(?:Resistance|Res|Resist)" + separators + numberGroup, "i");
            const instRegex = new RegExp("(?:Instability|Inst|Stablity)" + separators + numberGroup, "i");

            const massMatch = text.match(massRegex);
            const resMatch = text.match(resRegex);
            const instMatch = text.match(instRegex);

            let updated = false;
            const parseValue = (str) => {
                const cleaned = str.replace(/[^\d.]/g, '');
                return parseFloat(cleaned);
            };

            if (massMatch && massMatch[1]) {
                const val = parseValue(massMatch[1]);
                if (!isNaN(val)) { document.getElementById('rockMass').value = val; updated = true; }
            }
            if (resMatch && resMatch[1]) {
                const val = parseValue(resMatch[1]);
                if (!isNaN(val)) { document.getElementById('resistance').value = val; updated = true; }
            }
            if (instMatch && instMatch[1]) {
                const val = parseValue(instMatch[1]);
                if (!isNaN(val)) { document.getElementById('instability').value = val; updated = true; }
            }

            if (updated) {
                calculate();
                const container = document.getElementById('ocr-drop-zone');
                container.classList.add('border-green-500');
                setTimeout(() => container.classList.remove('border-green-500'), 2000);
            } else {
                alert("Could not detect Mass, Resistance, or Instability values. \n\nTip: Crop the screenshot closer to the rock stats on the right side of the UI.");
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initTheme(); // Initial theme setup
            populateSelects();
        });

    </script>
</body>
</html>
