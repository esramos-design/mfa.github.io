<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mining Fracture Analyser - Star Citizen</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Load Tesseract.js for OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        /* Define the Inter font family and a space-themed dark background */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Deep space blue/black */
            color: #e5e7eb; /* Light gray text */
            min-height: 100vh;
        }
        
        /* Custom input and select styling for a sci-fi look */
        input[type="number"], select {
            background-color: #161b22;
            border: 1px solid #30363d;
            color: #e5e7eb; /* Softer light gray for input text */
            transition: border-color 0.2s, box-shadow 0.2s;
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
            padding-right: 2.5rem; 
        }

        /* --- FOCUS STYLE --- */
        input[type="number"]:focus, select:focus {
            border-color: #38bdf8; /* Bright Sky Blue for high visibility */
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.5); /* Wider, brighter focus ring */
            outline: none;
        }

        /* Styling for the dynamically added ship arms */
        .ship-arm-card {
            background-color: #21262d;
            border: 1px solid #30363d;
            transition: border-color 0.2s, opacity 0.2s;
        }
        .ship-arm-card:hover {
            border-color: #60a5fa;
        }
        /* Disabled state styling */
        .ship-arm-card.disabled-arm {
            opacity: 0.5;
            border-color: #30363d;
        }

        /* New Layout container: Wider for 5 columns */
        .main-container {
            max-width: 2200px; /* Increased max width for 5 columns */
            width: 98%;
            display: grid; /* Enables stacking by default */
            gap: 1.5rem;
        }
        
        @media (min-width: 1280px) {
            .main-container {
                grid-template-columns: repeat(5, 1fr); /* Five equal columns for large desktop */
            }
        }
        
        /* CRITICAL CSS FOR INDEPENDENT SCROLLING COLUMNS */
        @media (min-width: 1024px) {
            /* Sticky Column Wrapper */
            .sticky-column-wrapper {
                position: sticky;
                top: 1rem; /* Space from the top */
                /* Calculate height to fit between top margin and bottom of viewport */
                max-height: calc(100vh - 2rem); 
                overflow-y: auto; /* Enable scrolling for inputs */
                padding-top: 0; /* Remove top padding from the scrolling container */
            }
            .static-header-pin {
                position: sticky;
                top: 0;
                z-index: 10; /* Ensure it stays above scrolling content */
                /* Use padding equal to the main wrapper's original top padding (p-6/p-8) to match the border/box visually */
                padding: 1.5rem 2rem 1.5rem 2rem; 
                background-color: #161b22; /* Match parent background */
                border-bottom: 1px solid #30363d; /* Visual separation line */
                margin-bottom: 2rem; /* Add spacing back after the header */
            }

            /* Generic sticky scroll content class */
            .sticky-scroll-content {
                overflow-y: auto;
                max-height: calc(100vh - 2rem); 
                position: sticky;
                top: 1rem;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6 flex justify-center items-start">

    <!-- MAIN GRID CONTAINER -->
    <div class="main-container">
        
        <!-- COLUMN 1: ROCK & GADGET SETUP (Moved specific sections here) -->
        <div class="w-full">
            <div class="sticky-column-wrapper bg-[#161b22] rounded-2xl shadow-2xl border border-blue-900/30">
                
                <!-- STATIC HEADER PINNED AT TOP -->
                <div class="static-header-pin p-6 sm:p-8 rounded-t-2xl">
                    <div class="text-center">
                        <div class="mb-2 flex items-center justify-center p-2">
                            <!-- LOGO: Uses local file 'mpa.jpg' with fallback -->
                            <img src="https://github.com/esramos-design/mfa.github.io/blob/main/mpa.jpg?raw=true" 
                                alt="Mining Fractor Analyser Logo" 
                                class="w-full h-auto max-w-[70%] rounded-lg object-contain shadow-lg"
                                onerror="this.onerror=null; this.src='https://placehold.co/600x150/161b22/e5e7eb?text=Mining+Analyser';">
                        </div>
                        <p class="text-sm text-gray-400 mt-2 max-w-4xl mx-auto leading-relaxed text-left">
                            The Mining Fracture Analyser is a powerful, real-time calculation tool designed specifically for cooperative mining crews in Star Citizen, such as those using multiple MOLEs, Prospectors, or Golems. This application simplifies complex in-game mechanics by calculating your crew's Total Combined Effective Laser Power (MW) and comparing it against a targeted rock's mass, effective resistance, and instability. Use it to pre-determine if your team has enough power to successfully fracture a difficult asteroid or planet-side rock before committing time and resources.
                        </p>
                    </div>
                </div>
                
                <!-- SCROLLABLE BODY CONTENT -->
                <div class="p-6 space-y-6">

                    <!-- NEW OCR SECTION -->
                    <div class="mb-6 p-1 border-2 border-dashed border-gray-600 rounded-xl hover:border-blue-400 transition-colors bg-[#0d1117]" id="ocr-drop-zone">
                        <div class="relative flex flex-col items-center justify-center py-6 text-center cursor-pointer" onclick="document.getElementById('fileInput').click()">
                            
                            <!-- Loading Overlay (Hidden by default) -->
                            <div id="ocr-loading" class="absolute inset-0 bg-[#0d1117]/90 z-10 flex flex-col items-center justify-center rounded-xl hidden">
                                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mb-2"></div>
                                <p class="text-blue-400 font-bold animate-pulse">ANALYSING ROCK DATA...</p>
                                <p class="text-xs text-gray-500" id="ocr-status">Initializing Tesseract...</p>
                            </div>

                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <p class="text-sm text-gray-300 font-semibold">Auto-Scan Rock (OCR)</p>
                            <p class="text-xs text-gray-500 mt-1">Click to Upload or <span class="text-blue-400 font-bold">CTRL+V</span> Screenshot</p>
                            <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleFileSelect(this)">
                        </div>
                    </div>
                    <!-- END OCR SECTION -->

                    <!-- 2. Rock Parameters Group -->
                    <h2 class="text-lg font-semibold text-blue-300">Rock & Gadget Setup</h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Rock Stats Input -->
                        <div class="p-3 bg-[#21262d] rounded-xl col-span-2 sm:col-span-1">
                            <label for="resistance" class="block text-xs font-medium mb-1 text-gray-300">Base Resistance (%)</label>
                            <input type="number" id="resistance" value="16.0" step="0.1" placeholder="e.g., 16.0"
                                    class="w-full p-2 rounded-lg text-sm" oninput="calculate()">
                        </div>
                        
                        <div class="p-3 bg-[#21262d] rounded-xl col-span-2 sm:col-span-1">
                            <label for="instability" class="block text-xs font-medium mb-1 text-gray-300">Base Instability (%)</label>
                            <input type="number" id="instability" value="20.0" step="0.1" placeholder="e.g., 20.0"
                                    class="w-full p-2 rounded-lg text-sm" oninput="calculate()">
                        </div>

                        <!-- Target Rock Mass Input -->
                        <div class="p-3 bg-[#21262d] rounded-xl col-span-2">
                            <label for="rockMass" class="block text-xs font-medium mb-1 text-gray-300">Target Rock Mass (kg)</label>
                            <input type="number" id="rockMass" value="23922" placeholder="e.g., 23922"
                                    class="w-full p-2 rounded-lg text-sm" oninput="calculate()">
                        </div>
                    </div>
                    
                    <!-- Gadget Slot -->
                    <div class="p-3 bg-[#21262d] rounded-xl">
                        <label for="gadgetSelect" class="block text-xs font-medium mb-1 text-gray-300">Select Gadget (Rock Modifiers)</label>
                        <select id="gadgetSelect" onchange="calculate()"
                               class="w-full p-2 rounded-lg bg-[#161b22] border border-[#30363d] text-white text-sm">
                            <!-- Options populated by JS -->
                        </select>
                    </div>

                    <button onclick="calculate()"
                            class="w-full p-4 text-lg font-bold rounded-xl transition-all duration-200 
                                bg-indigo-600 hover:bg-indigo-700 shadow-md hover:shadow-lg active:scale-95">
                        RUN ANALYTIC SIMULATION
                    </button>

                </div>
            </div>
        </div>

        <!-- COLUMN 2: TEAM ASSEMBLY (Moved Here) -->
        <div class="w-full">
            <div class="sticky-column-wrapper bg-[#161b22] rounded-2xl shadow-2xl border border-blue-900/30">
                
                <!-- HEADER FOR COLUMN 2 -->
                <div class="static-header-pin p-6 rounded-t-2xl">
                    <h2 class="text-xl font-extrabold text-blue-400 text-center">TEAM ASSEMBLY</h2>
                </div>

                <div class="p-6 space-y-6">
                    <!-- 1. Ship Assembly -->
                    <div class="p-4 bg-blue-900/20 rounded-xl border border-blue-700/50">
                        <label for="shipSelectToAdd" class="block text-sm font-medium mb-2 text-blue-300">Add Mining Ship</label>
                        
                        <!-- Dynamic Ship Image Display -->
                        <div class="mb-4 flex justify-center">
                            <img id="selectedShipImage" src="" alt="Selected Ship" class="rounded-lg shadow-md border border-blue-900/50 max-h-48 object-contain w-full hidden">
                        </div>

                        <div class="flex space-x-2">
                            <select id="shipSelectToAdd" class="flex-grow p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white text-sm" onchange="updateShipImage()">
                                <!-- Options populated by JS -->
                            </select>
                            <button onclick="addShipLoadout()"
                                    class="p-3 text-sm font-bold rounded-lg transition-all duration-200 
                                        bg-blue-600 hover:bg-blue-700 shadow-md active:scale-95 whitespace-nowrap">
                                Add
                            </button>
                        </div>
                    </div>

                    <!-- Active Loadout Cards -->
                    <h2 class="text-lg font-semibold text-gray-300">Active Laser Heads:</h2>
                    <div id="multiShipContainer" class="space-y-4 min-h-[100px] p-2 border border-gray-700 rounded-xl">
                        <p class="text-center text-gray-500 text-sm p-4 border border-dashed border-gray-700 rounded-lg">
                            Add ships above to configure their mining laser heads.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUMN 3: ANALYTIC RESULTS & CHARTS -->
        <div class="w-full">
            <div id="results-wrapper" class="sticky-scroll-content bg-[#161b22] p-6 rounded-2xl shadow-2xl border border-blue-900/30 space-y-6">
                
                <h2 class="text-xl font-extrabold text-blue-400 text-center">ANALYTIC RESULTS</h2>
                
                <!-- Chart 1: Power vs Required -->
                <div class="p-4 bg-gray-900/50 rounded-xl border border-blue-600/50">
                    <h3 class="text-sm font-bold text-blue-300 mb-2 text-center">Power & Fracture Margin</h3>
                    <div class="h-32 w-full"><canvas id="powerChart"></canvas></div>
                </div>
                 
                 <!-- Chart 2: Rock Difficulty Profile -->
                <div class="p-4 bg-gray-900/50 rounded-xl border border-yellow-600/50">
                    <h3 class="text-sm font-bold text-yellow-300 mb-2 text-center">Risk Profile (Difficulty Factors)</h3>
                    <div class="h-48 w-full"><canvas id="modChart"></canvas></div>
                </div>

                 <!-- Chart 3: Power vs Resistance Curve -->
                 <div class="p-4 bg-gray-900/50 rounded-xl border border-purple-600/50">
                    <h3 class="text-sm font-bold text-purple-300 mb-2 text-center">Effective Power vs Resistance</h3>
                    <div class="h-48 w-full"><canvas id="resistanceChart"></canvas></div>
                </div>

                <!-- Calculation Results -->
                <section id="results" class="pt-2">
                    <p class="text-center text-gray-400 italic text-sm">Configure your loadout to see results.</p>
                </section>
                
                <footer class="pt-4 border-t border-gray-700/50 text-center text-xs">
                    <p class="text-gray-500">Powered by MFA</p>
                </footer>
            </div>
        </div>

        <!-- COLUMN 4: REQUIREMENTS & WARNINGS -->
        <div class="w-full">
            <div id="warnings-wrapper" class="sticky-scroll-content bg-[#161b22] p-6 rounded-2xl shadow-2xl border border-blue-900/30 space-y-6">
                <h2 class="text-xl font-extrabold text-yellow-400 text-center">REQUIREMENTS</h2>
                <!-- Warning output -->
                <section id="warnings" class="pt-2">
                    <p class="text-center text-gray-400 italic text-sm">Warnings and requirements will appear here.</p>
                </section>
            </div>
        </div>

        <!-- COLUMN 5: MAX POWER CONFIGS -->
        <div class="w-full">
            <div id="configs-wrapper" class="sticky-scroll-content bg-[#161b22] p-6 rounded-2xl shadow-2xl border border-blue-900/30 space-y-6">
                <h2 class="text-xl font-extrabold text-green-400 text-center">MAX POWER CONFIGS</h2>
                <!-- Config output -->
                <section id="configs" class="pt-2">
                    <p class="text-center text-gray-400 italic text-sm">Recommended loadouts will appear here.</p>
                </section>
            </div>
        </div>

    </div>

    <script>
        // Global chart instances
        let powerChart = null;
        let modChart = null;
        let resistanceChart = null;

        // Data Definitions
        // UPDATED SHIP IMAGES TO USE DIRECT GITHUB RAW LINKS
        const ships = [
            { 
                id: "mole", 
                name: "Argo MOLE", 
                arms: 3, 
                maxLaserSize: 2, 
                defaultLaser: 4080, 
                moduleSlots: 3, 
                isFixedLaser: false
            }, 
            { 
                id: "prospector", 
                name: "MISC Prospector", 
                arms: 1, 
                maxLaserSize: 1, 
                defaultLaser: 3150, 
                moduleSlots: 2, 
                isFixedLaser: false
            }, 
            { 
                id: "golem", 
                name: "Drake Golem", 
                arms: 1, 
                maxLaserSize: 1, 
                defaultLaser: 2700, 
                moduleSlots: 2, 
                isFixedLaser: true, 
                fixedLaserName: "Pitman (~2700 MW)"
            } 
        ];

        const allLaserHeads = [
            { name: "Arbor MHV Mining Laser", size: 0, power: 1890, moduleSlots: 1, resistanceEffect: 25, instabilityEffect: -35 }, 
            { name: "S0 Helix Mining Laser", size: 0, power: 1000, moduleSlots: 0, resistanceEffect: -30, instabilityEffect: 0 }, 
            { name: "S00 Hofstede Mining Laser", size: 0, power: 500, moduleSlots: 0, resistanceEffect: -30, instabilityEffect: 10 }, 
            { name: "Lawson Mining Laser", size: 0, power: 1890, moduleSlots: 0, resistanceEffect: 0, instabilityEffect: 0 },
            { name: "Pitman Mining Laser", size: 0, power: 3150, moduleSlots: 2, resistanceEffect: 25, instabilityEffect: 35 }, 

            // Size 1
            { name: "Arbor MH1 Mining Laser", size: 1, power: 1890, moduleSlots: 1, resistanceEffect: 25, instabilityEffect: -35 },
            { name: "Helix I Mining Laser", size: 1, power: 3150, moduleSlots: 2, resistanceEffect: -30, instabilityEffect: 0.0 },
            { name: "Hofstede-S1 Mining Laser", size: 1, power: 2100, moduleSlots: 1, resistanceEffect: -30, instabilityEffect: 10 },
            { name: "Impact I Mining Laser", size: 1, power: 2100, moduleSlots: 2, resistanceEffect: 10, instabilityEffect: -10 },
            { name: "Klein-S1 Mining Laser", size: 1, power: 2220, moduleSlots: 0, resistanceEffect: -45, instabilityEffect: 35 },
            { name: "Lancet MH1 Mining Laser", size: 1, power: 2520, moduleSlots: 1, resistanceEffect: -10, instabilityEffect: 40 },

            // Size 2
            { name: "Arbor MH2 Mining Laser", size: 2, power: 2400, moduleSlots: 2, resistanceEffect: 25, instabilityEffect: -35 },
            { name: "Helix II Mining Laser", size: 2, power: 4080, moduleSlots: 3, resistanceEffect: -30, instabilityEffect: 0.0 },
            { name: "Hofstede-S2 Mining Laser", size: 2, power: 3360, moduleSlots: 2, resistanceEffect: -30, instabilityEffect: 10 },
            { name: "Impact II Mining Laser", size: 2, power: 3360, moduleSlots: 3, resistanceEffect: 10, instabilityEffect: -10 },
            { name: "Klein-S2 Mining Laser", size: 2, power: 3600, moduleSlots: 1, resistanceEffect: -45, instabilityEffect: 35 },
            { name: "Lancet MH2 Mining Laser", size: 2, power: 3600, moduleSlots: 2, resistanceEffect: 0.0, instabilityEffect: -10 },
        ].sort((a, b) => {
            // Sort by Size descending first (2 -> 1 -> 0), then by Power descending
            if (b.size !== a.size) {
                return b.size - a.size;
            }
            return b.power - a.power;
        });

        const powerModules = [
            { name: "Surge (Active, +50% Power, +10 Inst)", multiplier: 1.50, resistanceEffect: -15, instabilityEffect: 10, activation: 'Active' },
            { name: "Brandt (Active, +35% Power, +15% Res)", multiplier: 1.35, resistanceEffect: 15, instabilityEffect: 0.0, activation: 'Active' },
            { name: "Stampede (Active, +35% Power, -10 Inst)", multiplier: 1.35, resistanceEffect: 0.0, instabilityEffect: -10, activation: 'Active' },
            { name: "Forel (Active, Charge Window +60%)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0, activation: 'Active' },
            { name: "Lifeline (Active, -15% Res, -20% Inst)", multiplier: 1.00, resistanceEffect: -15, instabilityEffect: -20.0, activation: 'Active' },
            { name: "Torpid (Active, -40% Power)", multiplier: 0.60, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Active' },
            { name: "Rime (Active, -15% Power, -25% Res)", multiplier: 0.85, resistanceEffect: -25, instabilityEffect: 0.0, activation: 'Active' },
            { name: "Optimum (Active, -15% Power, -10% Inst)", multiplier: 0.85, resistanceEffect: 0.0, instabilityEffect: -10.0, activation: 'Active' },
            { name: "Rieger-C3 (Passive, +25% Power, -1% Inst)", multiplier: 1.25, resistanceEffect: 0.0, instabilityEffect: -1, activation: 'Passive' },
            { name: "Rieger-C2 (Passive, +20% Power, -3% Inst)", multiplier: 1.20, resistanceEffect: 0.0, instabilityEffect: -3, activation: 'Passive' },
            { name: "Focus III (Passive, -5% Power, +40% Opt Window)", multiplier: 0.95, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "Focus II (Passive, -10% Power, +37% Opt Window)", multiplier: 0.90, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "Focus (Passive, -15% Power, +30% Opt Window)", multiplier: 0.85, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "Torrent III (Passive, +40% Instability)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 40, activation: 'Passive' }, 
            { name: "Torrent II (Passive, +35% Instability)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 35, activation: 'Passive' }, 
            { name: "Torrent (Passive, +30% Instability)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 30, activation: 'Passive' }, 
            { name: "XTR-XL (Passive, +25% Opt Window, -24% Inert)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "XTR-L (Passive, +22% Opt Window, -23% Inert)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "XTR (Passive, +15% Opt Window, -20% Inert)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "FLTR-XL (Passive, -24% Inert)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "Vaux-C3 (Passive, -5% Charge Rate)", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Passive' },
            { name: "None", multiplier: 1.00, resistanceEffect: 0.0, instabilityEffect: 0.0, activation: 'Default' },
        ]; 
        
        function sortModules(modules) {
            return modules.sort((a, b) => {
                if (a.name === 'None') return -1;
                if (b.name === 'None') return 1;
                if (a.activation === 'Active' && b.activation === 'Passive') return -1;
                if (a.activation === 'Passive' && b.activation === 'Active') return 1;
                if (a.multiplier !== b.multiplier) {
                    return b.multiplier - a.multiplier;
                }
                return a.name.localeCompare(b.name);
            });
        }
        const sortedModules = sortModules([...powerModules]); 

        const gadgets = [
            { name: "Sabir (-50% Res, +15% Inst)", reduction: -50.0, instabilityEffect: 15, type: 'Multiplicative' }, 
            { name: "OptiMax (-30% Resistance )", reduction: -30.0, instabilityEffect: 0.0, type: 'Multiplicative' },
            { name: "BoreMax (+10% Resistance, -70% Instability )", reduction: 10.0, instabilityEffect: -70, type: 'Additive' }, 
            { name: "Waveshift (Stability/Charge Rate, -35% Instability)", reduction: 0.0, instabilityEffect: -35, type: 'Utility' }, 
            { name: "Stalwart (Instability Reduction, -35% Instability)", reduction: 0.0, instabilityEffect: -35, type: 'Utility' }, 
            { name: "Okunis (Optimal Window/Charge Rate)", reduction: 0.0, instabilityEffect: 0.0, type: 'Utility' },
            { name: "None", reduction: 0.0, instabilityEffect: 0.0, type: 'None' }, 
        ].sort((a, b) => b.reduction - a.reduction);

        let armIdCounter = 0; 

        function createArmConfigHtml(armIndex, ship) {
            armIdCounter++; 
            const armUniqueId = `arm-${ship.id}-${armIdCounter}`;
            const isFixedLaser = ship.isFixedLaser; 

            // Filter heads based on ship restrictions
            const availableHeads = allLaserHeads.filter(head => {
                // Golem (Fixed)
                if (ship.id === 'golem') return head.name.includes('Pitman');
                
                // General exclusions
                if (head.name.includes('Pitman')) return false; // Pitman is Golem only
                if (head.size === 0) return false; // Exclude other Size 0s
                
                // Specific Ship Restrictions
                if (ship.id === 'mole') return head.size === 2; // MOLE: Size 2 ONLY
                if (ship.id === 'prospector') return head.size === 1; // Prospector: Size 1 ONLY
                
                return head.size <= ship.maxLaserSize;
            });

            // Helper to generate option HTML
            const generateOption = (head) => {
                let isSelected = false;
                if (ship.id === 'mole' && head.name.includes('Helix II')) isSelected = true;
                else if (ship.id === 'prospector' && head.name.includes('Helix I')) isSelected = true;
                else if (ship.id === 'golem' && head.name.includes('Pitman')) isSelected = true;

                return `<option 
                        value="${head.power}" 
                        data-slots="${head.moduleSlots}" 
                        data-resistance="${head.resistanceEffect}" 
                        data-instability="${head.instabilityEffect}" 
                        ${isSelected ? 'selected' : ''}>
                            ${head.name} (${head.moduleSlots} Slots)
                        </option>`;
            };

            // Group by Size for Dropdown
            const size2Heads = availableHeads.filter(h => h.size === 2);
            const size1Heads = availableHeads.filter(h => h.size === 1);
            
            let laserOptionsHtml = '';

            // Generate Optgroups
            if (size2Heads.length > 0) {
                laserOptionsHtml += `<optgroup label="Size 2 Laser Heads">`;
                laserOptionsHtml += size2Heads.map(generateOption).join('');
                laserOptionsHtml += `</optgroup>`;
            }
            if (size1Heads.length > 0) {
                laserOptionsHtml += `<optgroup label="Size 1 Laser Heads">`;
                laserOptionsHtml += size1Heads.map(generateOption).join('');
                laserOptionsHtml += `</optgroup>`;
            }
            
            // Fallback if no groups (e.g. Golem or empty)
            if (laserOptionsHtml === '' && availableHeads.length > 0) {
                 laserOptionsHtml = availableHeads.map(generateOption).join('');
            }

            let laserSelectAttributes = '';
            let laserSelectDisabled = '';
            
            let defaultLaserData;
            if (isFixedLaser) {
                defaultLaserData = allLaserHeads.find(h => h.name.includes(ship.fixedLaserName.split('(')[0].trim()));
            } else {
                defaultLaserData = allLaserHeads.find(h => h.power === ship.defaultLaser);
            }
            
            const actualMaxSlots = defaultLaserData?.moduleSlots || ship.moduleSlots;

            if (isFixedLaser) {
                laserSelectDisabled = 'disabled';
                const pitmanLaser = allLaserHeads.find(h => h.name.includes('Pitman'));
                laserOptionsHtml = `<option value="${pitmanLaser.power}" data-slots="${actualMaxSlots}" data-resistance="${pitmanLaser.resistanceEffect}" data-instability="${pitmanLaser.instabilityEffect}" selected>${ship.fixedLaserName} (Fixed, ${actualMaxSlots} Slots)</option>`;
            } else {
                laserSelectAttributes = `onchange="updateLaserConfig(this, '${armUniqueId}'); calculate();"`;
            }
            
            // --- MODULE DROPDOWN GROUPING ---
            const activeModulesHtml = sortedModules
                .filter(m => m.activation === 'Active')
                .map(mod => `<option value="${mod.name}">${mod.name}</option>`)
                .join('');
            
            const passiveModulesHtml = sortedModules
                .filter(m => m.activation === 'Passive')
                .map(mod => `<option value="${mod.name}">${mod.name}</option>`)
                .join('');

            const defaultOption = `<option value="None" selected>None</option>`;
            
            const finalModuleOptions = `
                ${defaultOption}
                <optgroup label="Active Modules">
                    ${activeModulesHtml}
                </optgroup>
                <optgroup label="Passive Modules">
                    ${passiveModulesHtml}
                </optgroup>
            `;

            let moduleSlotsHtml = '<div id="module-slots-container-' + armUniqueId + '">';
            for (let i = 1; i <= 3; i++) {
                const isDisabled = i > actualMaxSlots;
                const slotText = isDisabled ? `--- SLOT DISABLED (${actualMaxSlots} Slots Max) ---` : `Module Slot ${i}`;
                const initialValue = 'None'; 
                const disabledClass = isDisabled ? 'opacity-50' : '';
                
                moduleSlotsHtml += `
                    <select id="${armUniqueId}-mod${i}" class="arm-module-select w-full p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white mb-3 ${disabledClass}" 
                            onchange="calculate()" value="${initialValue}" ${isDisabled ? 'disabled' : ''}>
                        ${isDisabled ? `<option value="None">${slotText}</option>` : finalModuleOptions}
                    </select>
                `;
            }
            moduleSlotsHtml += '</div>';

            return `
                <div id="${armUniqueId}" class="p-4 rounded-xl shadow-lg ship-arm-card space-y-3" data-ship-id="${ship.id}" data-max-modules="${actualMaxSlots}">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-2">
                            <h4 class="text-lg font-bold ${ship.id === 'mole' ? 'text-indigo-400' : ship.id === 'prospector' ? 'text-green-400' : 'text-amber-400'}">
                                ${ship.name} - Head ${armIndex}
                            </h4>
                            <!-- Toggle Switch -->
                            <label class="relative inline-flex items-center cursor-pointer ml-3">
                                <input type="checkbox" id="${armUniqueId}-enable" class="sr-only peer" checked onchange="toggleArm('${armUniqueId}'); calculate();">
                                <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <button onclick="removeArmConfig('${armUniqueId}')" title="Remove Laser Head" class="p-1 bg-red-600 hover:bg-red-700 text-white rounded-full transition-all duration-150 active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <label class="block text-sm font-medium text-gray-400">Laser Head (Base Power)</label>
                    <select id="${armUniqueId}-laser" class="arm-laser-select w-full p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white"
                            data-max-size="${ship.maxLaserSize}" ${laserSelectAttributes} ${laserSelectDisabled}>
                        ${laserOptionsHtml}
                    </select>
                    <p class="text-xs text-gray-500 italic text-right -mt-2 mb-2">Click or tap to view options</p>

                    <label class="block text-sm font-medium text-gray-400">Modules (Max <span id="${armUniqueId}-slot-count">${actualMaxSlots}</span> Slots)</label>
                    ${moduleSlotsHtml}
                </div>
            `;
        }
        
        function toggleArm(armId) {
            const container = document.getElementById(armId);
            const checkbox = document.getElementById(armId + '-enable');
            
            if (checkbox.checked) {
                container.classList.remove('disabled-arm');
            } else {
                container.classList.add('disabled-arm');
            }
        }
        
        function updateLaserConfig(selectElement, armUniqueId) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const newMaxSlots = parseInt(selectedOption.getAttribute('data-slots'));
            const container = document.getElementById(armUniqueId);
            const slotContainer = document.getElementById(`module-slots-container-${armUniqueId}`);
            const slotCountDisplay = document.getElementById(`${armUniqueId}-slot-count`);

            if (!container || !slotContainer) return;

            container.setAttribute('data-max-modules', newMaxSlots);
            slotCountDisplay.textContent = newMaxSlots;

            // Re-generate module options with groups for the update function
            const activeModulesHtml = sortedModules
                .filter(m => m.activation === 'Active')
                .map(mod => `<option value="${mod.name}">${mod.name}</option>`)
                .join('');
            
            const passiveModulesHtml = sortedModules
                .filter(m => m.activation === 'Passive')
                .map(mod => `<option value="${mod.name}">${mod.name}</option>`)
                .join('');

            const defaultOption = `<option value="None">None</option>`;
            
            const finalModuleOptions = `
                ${defaultOption}
                <optgroup label="Active Modules">
                    ${activeModulesHtml}
                </optgroup>
                <optgroup label="Passive Modules">
                    ${passiveModulesHtml}
                </optgroup>
            `;

            let newModuleSlotsHtml = '';
            for (let i = 1; i <= 3; i++) {
                const isDisabled = i > newMaxSlots;
                const slotText = isDisabled ? `--- SLOT DISABLED (${newMaxSlots} Slots Max) ---` : `Module Slot ${i}`;
                const initialValue = 'None'; 
                const disabledClass = isDisabled ? 'opacity-50' : '';

                const oldSelect = document.getElementById(`${armUniqueId}-mod${i}`);
                const retainedValue = oldSelect && !isDisabled ? oldSelect.value : initialValue;
                
                // Use REPLACE to set selected, messy but functional for string injection
                let options = isDisabled ? `<option value="None">${slotText}</option>` : finalModuleOptions.replace(`value="${retainedValue}"`, `value="${retainedValue}" selected`);

                newModuleSlotsHtml += `
                    <select id="${armUniqueId}-mod${i}" class="arm-module-select w-full p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white mb-3 ${disabledClass}" 
                            onchange="calculate()" value="${retainedValue}" ${isDisabled ? 'disabled' : ''}>
                        ${options}
                    </select>
                `;
            }

            slotContainer.innerHTML = newModuleSlotsHtml;
        }

        function addShipLoadout() {
            const container = document.getElementById('multiShipContainer');
            const selectElement = document.getElementById('shipSelectToAdd');
            const selectedShipId = selectElement.value;
            const shipData = ships.find(s => s.id === selectedShipId);

            if (!shipData) return;

            const placeholder = container.querySelector('p.text-gray-500');
            if (placeholder) {
                placeholder.remove();
            }
            
            for (let i = 1; i <= shipData.arms; i++) {
                const armHtml = createArmConfigHtml(i, shipData);
                container.insertAdjacentHTML('beforeend', armHtml);
            }
            
            calculate();
        }

        function removeArmConfig(armId) {
            const armElement = document.getElementById(armId);
            if (armElement) {
                armElement.remove();
            }
            
            const container = document.getElementById('multiShipContainer');
            if (container.children.length === 0) {
                container.innerHTML = `
                    <p class="text-center text-gray-500 p-4 border border-dashed border-gray-700 rounded-lg">
                        Add ships above to configure their mining laser heads.
                    </p>
                `;
            }
            calculate();
        }

        // --- UPDATED: Hardcoded Image URLs for reliability ---
        function updateShipImage() {
            const shipSelectElement = document.getElementById('shipSelectToAdd');
            const selectedShipId = shipSelectElement.value;
            const imageElement = document.getElementById('selectedShipImage');

            // Hardcoded mapping to ensure correct display without relying on data array
            let imageUrl = '';
            if (selectedShipId === 'mole') {
                imageUrl = "https://github.com/esramos-design/mfa.github.io/blob/main/mole.jpg?raw=true";
            } else if (selectedShipId === 'prospector') {
                imageUrl = "https://github.com/esramos-design/mfa.github.io/blob/main/prospector.jpg?raw=true";
            } else if (selectedShipId === 'golem') {
                imageUrl = "https://github.com/esramos-design/mfa.github.io/blob/main/golem.jpg?raw=true";
            }

            if (imageUrl) {
                imageElement.src = imageUrl;
                imageElement.classList.remove('hidden');
            } else {
                imageElement.classList.add('hidden');
            }
        }

        function populateSelects() {
            // --- ROBUST SHIP LIST POPULATION ---
            const shipSelectElement = document.getElementById('shipSelectToAdd');
            if (shipSelectElement && ships.length > 0) {
                shipSelectElement.innerHTML = ships.map((ship) => 
                    `<option value="${ship.id}">${ship.name} (Laser Heads: ${ship.arms})</option>`
                ).join('');
                shipSelectElement.value = 'mole';
                
                // Initial image load
                updateShipImage();
            } else {
                console.error("populateSelects error: Element not found or ships array empty.");
            }
            
            // --- ROBUST GADGET LIST POPULATION ---
            const gadgetSelectElement = document.getElementById('gadgetSelect');
            if (gadgetSelectElement && gadgets.length > 0) {
                const defaultGadget = gadgets.find(g => g.name === "None");
                gadgetSelectElement.innerHTML = gadgets.map(g =>
                    `<option value="${g.name}" ${g === defaultGadget ? 'selected' : ''}>${g.name}</option>`
                ).join('');

                if (defaultGadget) {
                    gadgetSelectElement.value = defaultGadget.name;
                }
            }
            
            calculate(); 
        }

        function assessDifficulty(instability, resistance) {
            let difficultyScore = resistance * 1.5 + instability;
            
            if (difficultyScore >= 100) {
                return { text: "EXTREME: Very high instability and resistance. Requires exceptional skill and stability modules.", color: "text-red-500" };
            } else if (difficultyScore >= 60) {
                return { text: "HARD: High instability/resistance. Requires specialized modules (Forel/Torrent) for safe charging.", color: "text-orange-400" };
            } else if (difficultyScore >= 30) {
                return { text: "MODERATE: Average difficulty. Standard play should be fine, but stability modules are helpful.", color: "text-yellow-300" };
            } else {
                return { text: "EASY: Low difficulty rock. Minimal risk of overheating or explosion.", color: "text-green-400" };
            }
        }

        function updateCharts(effectivePower, requiredPower, finalResistance, finalInstability, rockMass) {
            const powerCanvas = document.getElementById('powerChart');
            const modCanvas = document.getElementById('modChart');
            const resistanceCanvas = document.getElementById('resistanceChart');

            if (!powerCanvas || !modCanvas || !resistanceCanvas) return;

            const powerCtx = powerCanvas.getContext('2d');
            const modCtx = modCanvas.getContext('2d');
            const resistanceCtx = resistanceCanvas.getContext('2d');
            
            if (powerChart) powerChart.destroy();
            if (modChart) modChart.destroy();
            if (resistanceChart) resistanceChart.destroy();

            const margin = effectivePower - requiredPower;
            const success = margin >= 0;
            const totalMax = Math.max(effectivePower, requiredPower) * 1.1; 
            
            const dataPower = effectivePower / 1000;
            const dataRequired = requiredPower / 1000;
            const dataMax = totalMax / 1000;

            powerChart = new Chart(powerCtx, {
                type: 'bar',
                data: {
                    labels: ['Team Power (kMW)', 'Required Power (kMW)'],
                    datasets: [{
                        label: 'Power',
                        data: [dataPower, dataRequired],
                        backgroundColor: [
                            success ? '#10b981' : '#f87171',
                            '#3b82f6', 
                        ],
                        borderColor: [
                            success ? '#059669' : '#dc2626',
                            '#2563eb',
                        ],
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    aspectRatio: 2, 
                    indexAxis: 'y', 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.x !== null) {
                                        label += (context.parsed.x * 1000).toLocaleString(undefined, { maximumFractionDigits: 2 }) + ' MW';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0,
                            max: dataMax,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0) + ' kMW';
                                },
                                color: '#9ca3af' 
                            },
                            grid: { color: '#374151' } 
                        },
                        y: {
                            ticks: { color: '#e5e7eb' },
                            grid: { display: false }
                        }
                    }
                }
            });

            const resValue = finalResistance;
            const instabValue = finalInstability;
            
            // Calculate Risk Profile
            // Base assumes a "Safe Capacity" of 100. 
            // Any sum of Resistance + Instability reduces the Safe Margin.
            let safeMargin = 100 - (resValue + instabValue);
            if (safeMargin < 0) safeMargin = 0; // Prevent negative margin if risks are extreme

            const totalProfileData = [resValue, instabValue, safeMargin];

            modChart = new Chart(modCtx, {
                type: 'doughnut',
                data: {
                    labels: [
                        `Resistance (${resValue.toFixed(1)}%)`, 
                        `Instability (${instabValue.toFixed(2)}%)`,
                        `Safe Margin (${safeMargin.toFixed(1)}%)`
                    ],
                    datasets: [{
                        label: 'Risk Contribution',
                        data: totalProfileData,
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.9)', // Red (Resistance)
                            'rgba(147, 51, 234, 0.9)', // Purple (Instability)
                            'rgba(55, 65, 81, 0.5)'    // Dark Grey (Safe Margin)
                        ],
                        borderColor: '#161b22',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e5e7eb',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        title: {
                            display: false, // Title handled by HTML header
                        },
                        tooltip: {
                             callbacks: {
                                label: (context) => {
                                    const value = context.raw;
                                    return `${context.label}`;
                                }
                            }
                        }
                    },
                    cutout: '60%' 
                }
            });

            // --- Chart 3: Resistance Curve Data Generation ---
            const resLabels = [];
            const reqData = [];
            const myPowerData = [];
            
            // Sweep Resistance from 0 to 100%
            for(let i=0; i<=100; i+=5) {
                resLabels.push(i + '%');
                // Calculate required power using tool logic: (mass * (1 - resistanceDecimal)) / 5
                let decimal = i / 100.0;
                let req = (rockMass * (1.0 - decimal)) / 5.0;
                reqData.push(req / 1000); // Convert to kMW
                myPowerData.push(effectivePower / 1000); // My power is constant relative to Rock Resistance in this model
            }
            
            resistanceChart = new Chart(resistanceCtx, {
                type: 'line',
                data: {
                    labels: resLabels,
                    datasets: [
                        {
                            label: 'Team Power',
                            data: myPowerData,
                            borderColor: '#3b82f6', // Blue
                            backgroundColor: '#3b82f6',
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Required Power (Calc)',
                            data: reqData,
                            borderColor: '#fbbf24', // Amber/Yellow
                            backgroundColor: '#fbbf24',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#9ca3af', font: { size: 10 } }
                        },
                        title: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' kMW';
                                }
                            }
                        }
                    },
                    scales: {
                         x: {
                            ticks: { color: '#9ca3af', maxTicksLimit: 11 },
                            grid: { color: '#374151' },
                            title: { display: true, text: 'Resistance %', color: '#6b7280', font: { size: 10 } }
                        },
                        y: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' },
                            title: { display: true, text: 'Power (kMW)', color: '#6b7280', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function calculate() {
            const resultsContainer = document.getElementById('results');
            const suggestionContainer = document.getElementById('suggestion');
            const configsContainer = document.getElementById('configs');
            const warningsContainer = document.getElementById('warnings');
            const allArms = document.querySelectorAll('.ship-arm-card');
            
            if (allArms.length === 0) {
                displayResult('No mining laser heads added. Assemble your team above to begin the calculation.', 'text-gray-400');
                
                if (suggestionContainer) suggestionContainer.innerHTML = `<p class="text-center text-gray-400 italic">Loadout recommendations will appear here.</p>`;
                if (configsContainer) configsContainer.innerHTML = `<p class="text-center text-gray-400 italic">Max power configs will appear here.</p>`;
                if (warningsContainer) warningsContainer.innerHTML = `<p class="text-center text-gray-400 italic">Warnings will appear here.</p>`;
                
                const powerCanvas = document.getElementById('powerChart');
                const modCanvas = document.getElementById('modChart');
                const resCanvas = document.getElementById('resistanceChart');
                if (powerChart) { powerChart.destroy(); powerChart = null; }
                if (modChart) { modChart.destroy(); modChart = null; }
                if (resistanceChart) { resistanceChart.destroy(); resistanceChart = null; }
                return;
            }

            // Calculation logic (unchanged)
            let totalEffectiveLaserPower = 0;
            let totalResistanceMultiplier = 1.0; 
            let totalInstabilityMultiplier = 1.0; 
            let validationError = false;
            let activeArmsCount = 0;

            allArms.forEach(arm => {
                const armUniqueId = arm.id;
                // Check if switch is enabled
                const isEnabledCheck = document.getElementById(`${armUniqueId}-enable`);
                // Default to true if switch not found (failsafe)
                const isEnabled = isEnabledCheck ? isEnabledCheck.checked : true;

                if (!isEnabled) {
                    return; // Skip inactive arms completely
                }
                
                activeArmsCount++;

                const maxModules = parseInt(arm.dataset.maxModules);
                const laserSelect = document.getElementById(`${armUniqueId}-laser`);
                const basePowerValue = laserSelect ? (laserSelect.value || '0') : '0';
                const basePower = parseFloat(basePowerValue);
                const selectedOption = laserSelect.options[laserSelect.selectedIndex];
                let armResistanceMultiplier = 1.0;
                let armInstabilityMultiplier = 1.0;
                let totalModulePowerMultiplier = 1.0;
                let activeModules = [];
                let passiveModules = [];
                const laserResistanceEffect = parseFloat(selectedOption.getAttribute('data-resistance')) || 0;
                const laserInstabilityEffect = parseFloat(selectedOption.getAttribute('data-instability')) || 0;

                armResistanceMultiplier *= (1 + (laserResistanceEffect / 100));
                armInstabilityMultiplier *= (1 + (laserInstabilityEffect / 100));
                
                for (let i = 1; i <= 3; i++) { 
                    const moduleSelect = document.getElementById(`${armUniqueId}-mod${i}`);
                    if (moduleSelect && i <= maxModules) { 
                        const moduleName = moduleSelect.value;
                        const selectedModule = powerModules.find(m => m.name === moduleName);
                        if (selectedModule && selectedModule.name !== 'None') {
                            if (selectedModule.activation === 'Active') activeModules.push(selectedModule);
                            else if (selectedModule.activation === 'Passive') passiveModules.push(selectedModule);
                        }
                    }
                }
                
                if (activeModules.length > 0) {
                    activeModules.sort((a, b) => b.multiplier - a.multiplier);
                    const activeModule = activeModules[0];
                    totalModulePowerMultiplier *= activeModule.multiplier; 
                    armInstabilityMultiplier *= (1 + (activeModule.instabilityEffect / 100)); 
                    armResistanceMultiplier *= (1 + (activeModule.resistanceEffect / 100));
                }

                passiveModules.forEach(mod => {
                    totalModulePowerMultiplier *= mod.multiplier; 
                    armInstabilityMultiplier *= (1 + (mod.instabilityEffect / 100)); 
                    armResistanceMultiplier *= (1 + (mod.resistanceEffect / 100));
                });

                totalResistanceMultiplier *= armResistanceMultiplier;
                totalInstabilityMultiplier *= armInstabilityMultiplier;

                if (isNaN(basePower) || basePower <= 0) {
                    validationError = true;
                } else {
                    totalEffectiveLaserPower += basePower * totalModulePowerMultiplier;
                }
            });

            if (activeArmsCount === 0) {
                displayResult('No active mining laser heads. Enable at least one laser head.', 'text-yellow-400');
                
                const powerCanvas = document.getElementById('powerChart');
                const modCanvas = document.getElementById('modChart');
                const resCanvas = document.getElementById('resistanceChart');
                if (powerChart) { powerChart.destroy(); powerChart = null; }
                if (modChart) { modChart.destroy(); modChart = null; }
                if (resistanceChart) { resistanceChart.destroy(); resistanceChart = null; }
                return;
            }

            // Geometric Mean root is based on ACTIVE arms now
            const totalModifierRoot = 1.0 / activeArmsCount;
            totalResistanceMultiplier = Math.pow(totalResistanceMultiplier, totalModifierRoot);
            totalInstabilityMultiplier = Math.pow(totalInstabilityMultiplier, totalModifierRoot);

            const baseResistance = parseFloat(document.getElementById('resistance').value);
            const initialInstability = parseFloat(document.getElementById('instability').value);
            const gadgetSelect = document.getElementById('gadgetSelect');
            const selectedGadgetName = gadgetSelect.value;
            const rockMass = parseFloat(document.getElementById('rockMass').value);
            
            if (validationError || isNaN(baseResistance) || isNaN(rockMass) || isNaN(initialInstability) || totalEffectiveLaserPower <= 0) {
                displayResult('Error: Ensure all active laser heads have a valid Laser Head selected and all rock parameters contain valid positive numbers.', 'text-yellow-400');
                return;
            }

            const selectedGadget = gadgets.find(g => g.name === selectedGadgetName);
            if (selectedGadget) {
                totalResistanceMultiplier *= (1 + (selectedGadget.reduction / 100));
                totalInstabilityMultiplier *= (1 + (selectedGadget.instabilityEffect / 100));
            }
            
            let finalEffectiveResistance = baseResistance * totalResistanceMultiplier;
            let finalModifiedInstability = initialInstability * totalInstabilityMultiplier;

            if (finalEffectiveResistance < 0) finalEffectiveResistance = 0; 
            if (finalModifiedInstability < 0) finalModifiedInstability = 0; 
            
            const resistanceDecimal = finalEffectiveResistance / 100.0;
            let breakableMassLimit;
            let requiredEffectivePower = 0; 

            if (resistanceDecimal >= 1.0) {
                breakableMassLimit = 0.0;
            } else {
                const denominator = 1.0 - resistanceDecimal;
                breakableMassLimit = (totalEffectiveLaserPower * 5) / denominator;
                requiredEffectivePower = (rockMass * denominator) / 5; 
            }

            const isSuccess = breakableMassLimit >= rockMass;
            const formattedMaxMass = breakableMassLimit.toLocaleString(undefined, { maximumFractionDigits: 2 });
            const formattedRockMass = rockMass.toLocaleString();
            const formattedEffectivePower = totalEffectiveLaserPower.toLocaleString(undefined, { maximumFractionDigits: 2 });
            
            let verdictClass = isSuccess ? 'bg-green-700/80' : 'bg-red-700/80';
            let verdictIcon = isSuccess ? '' : '';
            let verdictText = isSuccess ? 'FRACTURE SUCCESSFUL!' : 'FRACTURE FAILED. Power short.';
            
            let massDifference = isSuccess ? 
                `${(breakableMassLimit - rockMass).toLocaleString(undefined, { maximumFractionDigits: 2 })} kg over the target mass.` : 
                `${(rockMass - breakableMassLimit).toLocaleString(undefined, { maximumFractionDigits: 2 })} kg short of the target mass.`;

            const difficulty = assessDifficulty(finalModifiedInstability, finalEffectiveResistance);

            const outputHtml = `
                <div class="space-y-6 text-white text-center">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 rounded-xl bg-[#21262d] shadow-inner border border-gray-700">
                            <p class="text-sm text-gray-400">Final Effective Resistance</p>
                            <p class="text-3xl font-extrabold text-red-400 mt-1">${finalEffectiveResistance.toFixed(1)}%</p>
                            <p class="text-xs text-gray-500">(Base ${baseResistance.toFixed(1)}% | ${totalResistanceMultiplier.toFixed(2)}x)</p>
                        </div>
                        <div class="p-3 rounded-xl bg-[#21262d] shadow-inner border border-gray-700">
                            <p class="text-sm text-gray-400">Modified Instability</p>
                            <p class="text-3xl font-extrabold text-purple-400 mt-1">${finalModifiedInstability.toFixed(2)}%</p>
                            <p class="text-xs text-gray-500">(Base ${initialInstability.toFixed(2)}% | ${totalInstabilityMultiplier.toFixed(2)}x)</p>
                        </div>
                    </div>
                    
                    <div class="p-3 rounded-xl bg-indigo-900/40 shadow-inner border border-indigo-700">
                        <p class="text-sm text-gray-400">Total Combined Effective Laser Power (${activeArmsCount} Active Heads)</p>
                        <p class="text-4xl font-extrabold text-yellow-300 mt-1">${formattedEffectivePower} MW</p>
                    </div>

                    <div class="p-3 rounded-xl bg-[#21262d] shadow-inner border border-gray-700">
                        <p class="text-sm text-gray-400">Max Theoretical Breakable Mass Limit</p>
                        <p class="text-4xl font-extrabold text-indigo-300 mt-1">${formattedMaxMass} kg</p>
                    </div>
                    
                    <div class="p-4 rounded-xl font-semibold text-lg text-white ${verdictClass} shadow-xl mt-6">
                        <p class="text-2xl">${verdictIcon} ${verdictText}</p>
                        <p class="text-sm pt-2 text-gray-200 italic">${massDifference}</p>
                        <p class="text-sm pt-1 text-gray-300">Target Rock Mass: ${formattedRockMass} kg</p>
                    </div>
                    
                    <div class="p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <p class="text-base font-semibold text-gray-300">Mining Difficulty Assessment:</p>
                        <p class="mt-1 font-bold ${difficulty.color}">${difficulty.text}</p>
                    </div>
                </div>
            `;

            resultsContainer.innerHTML = outputHtml;

            // --- Recommendations & Warnings Generation ---
            
            // 1. Define Ideal Components for Max Power Recommendations
            const recommendedGadget = gadgets.find(g => g.name.startsWith("Sabir"));
            const topActiveModule = powerModules.find(m => m.activation === 'Active' && m.name.startsWith("Surge"));
            const topPassiveModules = powerModules.filter(m => m.activation === 'Passive').sort((a, b) => b.multiplier - a.multiplier);
            
            // Top 2 passive modules (Rieger-C3, Rieger-C2 typically)
            const recommendedPassiveModules = [ 
                topPassiveModules.find(m => m.name.startsWith("Rieger-C3")),
                topPassiveModules.find(m => m.name.startsWith("Rieger-C2")),
            ].filter(Boolean);

            // Recommended Lasers
            const recLaserS2 = allLaserHeads.find(h => h.name.includes("Helix II")); 
            const recLaserS1 = allLaserHeads.find(h => h.name.includes("Helix I")); 
            const recGolemLaser = allLaserHeads.find(h => h.name.includes("Pitman"));

            // 2. Calculate Minimum Arms Needed
            // Max S2 Laser (Helix II: 4080 MW, 3 slots) * Surge (1.50) * Rieger-C3 (1.25) * Rieger-C2 (1.20) = ~9180 MW
            const maxEffectivePowerPerBestArm = 4080 * 1.50 * 1.25 * 1.20; 
            const minArmsRequired = requiredEffectivePower > 0 ? Math.ceil(requiredEffectivePower / maxEffectivePowerPerBestArm) : 1;
            const currentArmsSufficient = activeArmsCount >= minArmsRequired;

            // 3. Build HTML Strings
            let requirementHtml = '';
            let configsHtml = '';
            let warningsHtml = '';

            // --- Block A: Requirements / Warnings for Column 3 ---
            requirementHtml += `
                <div class="p-4 rounded-xl shadow-lg border ${currentArmsSufficient ? 'border-green-600 bg-green-900/40' : 'border-red-600 bg-red-900/40'} text-center mb-6">
                    <h3 class="text-xl font-bold ${currentArmsSufficient ? 'text-green-300' : 'text-red-300'}">
                        Min. Laser Heads Required
                    </h3>
                    <p class="text-sm text-gray-300 mt-2">
                        Required Effective Power: <span class="font-extrabold text-yellow-300">${requiredEffectivePower.toLocaleString(undefined, { maximumFractionDigits: 2 })} MW</span>
                    </p>
                    <p class="text-4xl font-extrabold text-white mt-2">
                        ${minArmsRequired}
                    </p>
                    <p class="text-xs text-gray-400 mt-1">
                        (Based on max S2 loadout: ${maxEffectivePowerPerBestArm.toLocaleString(undefined, { maximumFractionDigits: 0 })} MW/arm)
                    </p>
                    ${!currentArmsSufficient ? 
                        `<p class="text-sm text-red-200 mt-3 font-bold">WARNING: Your current active team (${activeArmsCount} arms) is insufficient.</p>` :
                        `<p class="text-sm text-green-200 mt-3 font-bold">STATUS: Your current active team (${activeArmsCount} arms) is sufficient.</p>`
                    }
                </div>
            `;

            if (!isSuccess && requiredEffectivePower > 0) {
                   const powerNeeded = requiredEffectivePower - totalEffectiveLaserPower;
                   warningsHtml += `
                     <div class="p-4 bg-red-900/40 rounded-xl border border-red-700/50 mb-6">
                         <h3 class="text-xl font-bold text-red-300 mb-2"> Power Shortfall Alert!</h3>
                         <p class="text-gray-300">You are <strong>${powerNeeded.toLocaleString(undefined, { maximumFractionDigits: 0 })} MW</strong> short.</p>
                     </div>
                   `;
            }
            
            if (finalEffectiveResistance > 30 || finalModifiedInstability > 40) {
                warningsHtml += `
                    <div class="p-4 bg-purple-900/40 rounded-xl border border-purple-700/50 mb-6">
                        <h3 class="text-xl font-bold text-purple-300 mb-2"> Stability Warning</h3>
                        <p class="text-sm text-gray-300">High Resistance/Instability detected. Consider <strong>Stampede</strong> (Instability) or <strong>Surge</strong> (Resistance) modules.</p>
                    </div>
                `;
            }

            // --- Block B: Max Power Configs for Column 4 ---
            configsHtml += `<div class="p-4 bg-gray-800/50 rounded-lg mb-6 border border-blue-600">
                <p class="font-bold text-blue-300">Max Resistance Reduction Gadget:</p>
                <p class="text-lg text-white font-semibold mt-1">${recommendedGadget ? recommendedGadget.name : 'N/A'}</p>
                <p class="text-sm text-gray-400">(Recommended to reduce target resistance)</p>
            </div>`;
            
            configsHtml += '<div class="space-y-4">';

            const displayLoadouts = [
                { id: 'mole', name: 'MOLE (S2 - 3 Slots)', arms: 3, laser: recLaserS2, slots: 3 }, 
                { id: 'prospector', name: 'Prospector (S1 - 2 Slots)', arms: 1, laser: recLaserS1, slots: 2 },
                { id: 'golem', name: 'Golem (Fixed - 2 Slots)', arms: 1, laser: recGolemLaser, slots: 2 } 
            ];

            displayLoadouts.forEach(type => {
                if (!type.laser) return;
                
                let moduleList = [];
                if (type.slots === 2) {
                    moduleList = [topActiveModule, recommendedPassiveModules[0]].filter(Boolean);
                } else {
                    moduleList = [topActiveModule, ...recommendedPassiveModules].filter(Boolean);
                }

                let loadoutMultiplier = 1.0;
                moduleList.forEach(m => loadoutMultiplier *= m.multiplier);
                const loadoutPower = type.laser.power * loadoutMultiplier;

                const moduleHtml = moduleList.map((mod, i) => 
                    `<li class="ml-4 list-disc text-green-300">Slot ${i+1}: <span class="font-bold">${mod.name}</span> (x${mod.multiplier.toFixed(2)})</li>`
                ).join('');

                const titleColor = type.id === 'mole' ? 'text-indigo-400' : type.id === 'prospector' ? 'text-green-400' : 'text-amber-400';

                configsHtml += `
                    <div class="p-4 rounded-xl bg-gray-900 border border-gray-700">
                        <h4 class="text-lg font-bold ${titleColor}">${type.name}</h4>
                        <p class="text-sm text-gray-400 mt-1">Max Potential: <span class="text-yellow-400 font-bold">${loadoutPower.toLocaleString(undefined, { maximumFractionDigits: 0 })} MW</span></p>
                        
                        <div class="mt-2 p-2 bg-[#161b22] rounded border border-gray-800">
                            <p class="text-xs text-blue-400 font-bold uppercase">Laser Head</p>
                            <p class="text-sm text-white">${type.laser.name}</p>
                        </div>
                        <div class="mt-2 p-2 bg-[#161b22] rounded border border-gray-800">
                            <p class="text-xs text-blue-400 font-bold uppercase">Modules</p>
                            <ul class="text-sm space-y-1">${moduleHtml}</ul>
                        </div>
                    </div>
                `;
            });
            configsHtml += '</div>';

            // 4. Update DOM elements in columns 3 and 4
            if (warningsContainer) warningsContainer.innerHTML = requirementHtml + warningsHtml;
            if (configsContainer) configsContainer.innerHTML = configsHtml;

            // --- E. Update Charts ---
            updateCharts(totalEffectiveLaserPower, requiredEffectivePower, finalEffectiveResistance, finalModifiedInstability, rockMass);
        }

        // Helper function for error messages
        function displayResult(message, className) {
            document.getElementById('results').innerHTML = `<p class="text-center mt-4 ${className} font-bold text-lg">${message}</p>`;
        }
        
        // --- OCR FUNCTIONALITY ---

        // 1. Paste Event Listener (Global)
        document.addEventListener('paste', function(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    const blob = item.getAsFile();
                    processOCR(blob);
                    break; // Only process the first image found
                }
            }
        });

        // 2. File Input Handler
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                processOCR(input.files[0]);
            }
        }

        // 3. Main OCR Processing Function
        async function processOCR(imageBlob) {
            const loadingOverlay = document.getElementById('ocr-loading');
            const statusText = document.getElementById('ocr-status');
            
            loadingOverlay.classList.remove('hidden');
            statusText.innerText = "Preprocessing Image...";

            try {
                // Create a worker
                const worker = await Tesseract.createWorker();
                
                statusText.innerText = "Recognizing Text...";
                
                // Run recognition
                const ret = await worker.recognize(imageBlob);
                const text = ret.data.text;
                
                console.log("OCR Result:", text); // Debugging
                statusText.innerText = "Parsing Data...";
                
                // Parse the text
                applyScannedData(text);
                
                await worker.terminate();
                
            } catch (err) {
                console.error(err);
                alert("Failed to scan image. Please ensure the screenshot is clear.");
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // 4. Parse Regex & Update Inputs
        function applyScannedData(text) {
            // Clean up common OCR misinterpretations for numbers (e.g., 'S' instead of '5', 'O' instead of '0')
            // Note: Simple cleanup, complex cases might require specific handling
            
            // Regex Patterns optimized for Star Citizen UI
            // Looks for label, optional colons/spaces, followed by number (handling commas)
            const massRegex = /(?:Mass|Mas|M|Rock Mass)[\s:.]*([\d,.]+)/i;
            const resRegex = /(?:Resistance|Res|Resist)[\s:.]*([\d,.]+)/i;
            const instRegex = /(?:Instability|Inst|Stablity)[\s:.]*([\d,.]+)/i; // 'Stablity' handles common typos

            const massMatch = text.match(massRegex);
            const resMatch = text.match(resRegex);
            const instMatch = text.match(instRegex);

            let updated = false;

            if (massMatch && massMatch[1]) {
                // Remove commas and convert to float
                const val = parseFloat(massMatch[1].replace(/,/g, ''));
                if (!isNaN(val)) {
                    document.getElementById('rockMass').value = val;
                    updated = true;
                }
            }

            if (resMatch && resMatch[1]) {
                const val = parseFloat(resMatch[1].replace(/,/g, ''));
                // SC Resistance is usually 0-100. If > 1, assume percent. If < 1 (e.g. 0.5), convert to 50? 
                // Usually SC UI shows "50%".
                if (!isNaN(val)) {
                    document.getElementById('resistance').value = val;
                    updated = true;
                }
            }

            if (instMatch && instMatch[1]) {
                const val = parseFloat(instMatch[1].replace(/,/g, ''));
                if (!isNaN(val)) {
                    document.getElementById('instability').value = val;
                    updated = true;
                }
            }

            if (updated) {
                // Trigger calculation to update charts
                calculate();
                
                // Visual feedback
                const container = document.getElementById('ocr-drop-zone');
                container.classList.add('border-green-500');
                setTimeout(() => container.classList.remove('border-green-500'), 2000);
            } else {
                alert("Could not detect Mass, Resistance, or Instability values. \n\nTip: Crop the screenshot closer to the rock stats on the right side of the UI.");
            }
        }

        // --- CRITICAL FIX: Ensure DOM is loaded before populating ---
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Populate Ship Select
            populateSelects();
        });

    </script>
</body>
</html>
