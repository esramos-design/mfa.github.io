<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mining Fracture Analyser</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define the Inter font family and a space-themed dark background */
        @import url('https://fonts.fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Deep space blue/black */
            color: #e5e7eb; /* Light gray text */
            min-height: 100vh;
        }
        
        /* Custom input and select styling for a sci-fi look */
        input[type="number"], select {
            background-color: #161b22;
            border: 1px solid #30363d;
            color: #e5e7eb; /* Softer light gray for input text */
            transition: border-color 0.2s, box-shadow 0.2s;
            /* Standardize select appearance across browsers */
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
            /* Add padding to account for the default select arrow */
            padding-right: 2.5rem; 
        }

        /* --- UPDATED EYE-FRIENDLY FOCUS STYLE --- */
        input[type="number"]:focus, select:focus {
            border-color: #38bdf8; /* Bright Sky Blue for high visibility */
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.5); /* Wider, brighter focus ring */
            outline: none;
        }
        /* --- END UPDATED FOCUS STYLE --- */

        /* Styling for the dynamically added ship arms */
        .ship-arm-card {
            background-color: #21262d;
            border: 1px solid #30363d;
            transition: border-color 0.2s;
        }
        .ship-arm-card:hover {
            border-color: #60a5fa;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex justify-center items-start">

    <div class="w-full max-w-xl bg-[#161b22] p-6 sm:p-8 rounded-2xl shadow-2xl border border-blue-900/30">
        <header class="text-center mb-8">
            <!-- ORGANIZATION BRANDING - FIXED WITH IMAGE LOGO -->
            <div class="mb-3 flex items-center justify-center space-x-3">
                <img src="https://cdn.discordapp.com/attachments/1377796906910224384/1377797363003035688/THRUSTERS-Logo.png?ex=68eb9709&is=68ea4589&hm=ca0d0fcd60d510de453c82c278bd460bcad2ec094cc736a78f59fbff67bf00c7&" 
                     alt="THRUSTERS & DUST Logo" 
                     class="h-10 w-10 rounded-full object-cover">
                <p class="text-lg sm:text-xl font-semibold uppercase tracking-widest text-gray-200">
                    THRUSTERS & DUST
                </p>
            </div>
            <!-- END ORGANIZATION BRANDING -->

            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-400">Mining Fracture Analyser</h1>
            <p class="text-sm text-gray-400 mt-2">Calculate the **combined effective fracture power** of your multi-ship mining crew against challenging planetary and asteroid rocks.</p>
        </header>

        <!-- Dynamic Ship Loadout Management -->
        <div class="p-4 bg-blue-900/20 rounded-xl mb-6 border border-blue-700/50">
            <label for="shipSelectToAdd" class="block text-sm font-medium mb-2 text-blue-300">1. Assemble Your Mining Team</label>
            <div class="flex space-x-2">
                <select id="shipSelectToAdd" class="flex-grow p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white">
                    <!-- Options populated by JS -->
                </select>
                <button onclick="addShipLoadout()"
                        class="p-3 text-sm font-bold rounded-lg transition-all duration-200 
                               bg-blue-600 hover:bg-blue-700 shadow-md active:scale-95 whitespace-nowrap">
                    Add Ship
                </button>
            </div>
            <!-- New instructional text -->
            <p class="text-xs text-gray-500 mt-2 italic text-right">Click or tap to view options</p>
            <!-- End new instructional text -->
        </div>

        <!-- Loadout Configuration Container (Dynamically populated) -->
        <h2 class="text-xl font-semibold text-gray-300 mb-4 mt-6">Active Mining Laser Heads:</h2>
        <div id="multiShipContainer" class="space-y-4">
            <p class="text-center text-gray-500 p-4 border border-dashed border-gray-700 rounded-lg">
                Add ships above to configure their mining laser heads.
            </p>
        </div>

        <!-- Gadget Slot (Resistance Reduction) -->
        <div class="p-4 bg-[#21262d] rounded-xl mt-8">
            <label for="gadgetSelect" class="block text-sm font-medium mb-2 text-gray-300">2. Select Gadget (Applies once to Rock)</label>
            <select id="gadgetSelect" onchange="calculate()"
                   class="w-full p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white">
                <!-- Options populated by JS -->
            </select>
            <!-- New instructional text -->
            <p class="text-xs text-gray-500 mt-2 italic text-right">Click or tap to view options</p>
            <!-- End new instructional text -->
        </div>
        
        <!-- Rock Stats Input (Resistance and Instability) -->
        <h2 class="text-xl font-semibold text-blue-300 mt-8 mb-4">3. Rock Parameters</h2>
        <div class="grid grid-cols-2 gap-4">
            <div class="p-4 bg-[#21262d] rounded-xl">
                <label for="resistance" class="block text-sm font-medium mb-2 text-gray-300">Base Resistance (%)</label>
                <input type="number" id="resistance" value="16.0" step="0.1" placeholder="e.g., 16.0"
                       class="w-full p-3 rounded-lg" oninput="calculate()">
            </div>
            
            <div class="p-4 bg-[#21262d] rounded-xl">
                <label for="instability" class="block text-sm font-medium mb-2 text-gray-300">Rock Instability (%)</label>
                <input type="number" id="instability" value="20.0" step="0.1" placeholder="e.g., 20.0"
                       class="w-full p-3 rounded-lg" oninput="calculate()">
            </div>
        </div>

        <!-- Target Rock Mass Input -->
        <div class="p-4 bg-[#21262d] rounded-xl mt-6">
            <label for="rockMass" class="block text-sm font-medium mb-2 text-gray-300">4. Target Rock Mass (kg) [For Verdict]</label>
            <input type="number" id="rockMass" value="23922" placeholder="e.g., 23922"
                   class="w-full p-3 rounded-lg" oninput="calculate()">
        </div>

        <button onclick="calculate()"
                class="w-full p-4 text-lg font-bold rounded-xl transition-all duration-200 mt-6 
                       bg-indigo-600 hover:bg-indigo-700 shadow-md hover:shadow-lg active:scale-95">
            Calculate Combined Fracture Limit
        </button>

        <section id="results" class="mt-8 pt-6 border-t border-gray-700/50">
            <h2 class="text-xl font-semibold text-center text-blue-300 mb-4">Calculation Results</h2>
            <p class="text-center text-gray-400 italic">Add ships and enter rock data to begin.</p>
        </section>
        
        <!-- Recommendation output will be inserted here when fracture fails -->
        <section id="suggestion" class="mt-8 pt-6 border-t border-gray-700/50 hidden">
        </section>

        <!-- CHIRONDRAGON Branding Footer -->
        <footer class="mt-10 pt-4 border-t border-gray-700/50 text-center text-sm">
            <!-- Updated text to only say "Powered by" -->
            <p class="text-gray-500">Powered by <span class="font-bold text-blue-400">CHIRONDRAGON</span></p>
            <div class="mt-2 space-x-4 text-xs">
                <!-- RSI Link -->
                <a href="https://robertsspaceindustries.com/en/citizens/CHIRONDRAGON" target="_blank" class="text-indigo-400 hover:text-indigo-300 transition-colors duration-150">
                    RSI Profile
                </a>
                <span class="text-gray-600">|</span>
                <!-- UEX Data Runner Link -->
                <a href="https://uexcorp.space/@CHIRONDRAGON?tab=datarunner&set_lang=en_US" target="_blank" class="text-indigo-400 hover:text-indigo-300 transition-colors duration-150">
                    UEX Data Runner
                </a>
                <span class="text-gray-600">|</span>
                <!-- Discord Link - UPDATED HREF -->
                <a href="https://discord.gg/ADcUVtx9DU" target="_blank" class="text-indigo-400 hover:text-indigo-300 transition-colors duration-150">
                    Thrusters & Dust Discord
                </a>
            </div>
        </footer>
    </div>

    <script>
        // Data Definitions based on the latest single-ship file, adapted for dynamic adding
        const ships = [
            // Updated defaultLaser powers based on new laser data
            { id: "mole", name: "Argo MOLE", arms: 3, maxLaserSize: 2, defaultLaser: 4080, moduleSlots: 3, isFixedLaser: false }, 
            { id: "prospector", name: "MISC Prospector", arms: 1, maxLaserSize: 1, defaultLaser: 3150, moduleSlots: 3, isFixedLaser: false }, 
            { id: "golem", name: "Drake Golem", arms: 1, maxLaserSize: 1, defaultLaser: 2700, moduleSlots: 2, isFixedLaser: true, fixedLaserName: "Pitman (~2700 MW)" } 
        ];

        // --- UPDATED LASER HEADS DATA ---
        const allLaserHeads = [
            // Size 1 Lasers (Max Power in MW)
            { name: "Arbor MH1 (~1890 MW)", power: 1890, size: 1 }, 
            { name: "Hofstede-S1 (~2100 MW)", power: 2100, size: 1 },
            { name: "Impact I (~2100 MW)", power: 2100, size: 1 },
            { name: "Klein-S1 (~2220 MW)", power: 2220, size: 1 },
            { name: "Arbor MH2 (~2400 MW)", power: 2400, size: 1 }, 
            { name: "Lancet MH1 (~2520 MW)", power: 2520, size: 1 },
            { name: "Pitman (~2700 MW)", power: 2700, size: 1 }, 
            { name: "Helix I (~3150 MW)", power: 3150, size: 1 },

            // Size 2 Lasers (Max Power in MW)
            { name: "Hofstede-S2 (~3360 MW)", power: 3360, size: 2 },
            { name: "Lancet MH2 (~3600 MW)", power: 3600, size: 2 },
            { name: "Klein-S2 (~3600 MW)", power: 3600, size: 2 },
            { name: "Impact II (~4080 MW)", power: 4080, size: 2 }, 
            { name: "Helix II (~4080 MW)", power: 4080, size: 2 } 
        ].sort((a, b) => a.power - b.power); 

        // --- UPDATED POWER MODULES DATA WITH EFFECTS ---
        const powerModules = [
            // Power Modules (Active)
            { name: "Surge (Active, +50% Power, -15% Resistance)", multiplier: 1.50, resistanceEffect: -15, instabilityEffect: 0, activation: 'Active' },
            { name: "Brandt (Active, +35% Power, +15% Resistance)", multiplier: 1.35, resistanceEffect: 15, instabilityEffect: 0, activation: 'Active' },
            { name: "Stampede (Active, +35% Power, -10 Instability)", multiplier: 1.35, resistanceEffect: 0, instabilityEffect: -10, activation: 'Active' },
            { name: "Forel (Active, Stability/Extraction Focus)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Active' },
            { name: "Lifeline (Active, Low Instability/High Overcharge)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Active' },
            { name: "Torpid (Active, +60% Charge Rate)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Active' },
            { name: "Optimum (Active, -15% Power, -80% Catastrophic Rate)", multiplier: 0.85, resistanceEffect: 0, instabilityEffect: 0, activation: 'Active' },
            { name: "Rime (Active, -15% Power, -25% Resistance)", multiplier: 0.85, resistanceEffect: -25, instabilityEffect: 0, activation: 'Active' },
            
            // Power Modules (Passive)
            { name: "Rieger-C3 (Passive, +25% Power, -1% Instability)", multiplier: 1.25, resistanceEffect: 0, instabilityEffect: -1, activation: 'Passive' },
            { name: "Rieger-C2 (Passive, +20% Power, -3% Instability)", multiplier: 1.20, resistanceEffect: 0, instabilityEffect: -3, activation: 'Passive' },
            { name: "Torrent III (Passive, +40% Charge Rate/Instability)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 40, activation: 'Passive' }, 
            { name: "Torrent II (Passive, +35% Charge Rate/Instability)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 35, activation: 'Passive' }, 
            { name: "Torrent (Passive, +30% Charge Rate/Instability)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 30, activation: 'Passive' }, 
            { name: "Vaux-C3 (Passive, -5% Charge Rate)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Passive' },
            { name: "Vaux-C2 (Passive, -15% Charge Rate)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Passive' },
            { name: "Vaux (Passive, -20% Charge Rate)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Passive' },
            { name: "FLTR-XL (Passive, -24% Inert Materials)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Passive' },
            { name: "FLTR-L (Passive, -23% Inert Materials)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Passive' },
            { name: "FLTR (Passive, -20% Inert Materials)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Passive' },
            { name: "XTR-XL (Passive, +25% Opt. Charge Window/Inert)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Passive' },
            { name: "XTR-L (Passive, +22% Opt. Charge Window/Inert)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Passive' },
            { name: "XTR (Passive, +15% Opt. Charge Window/Inert)", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Passive' },
            { name: "Focus III (Passive, -5% Power, +40% Opt. Charge Window)", multiplier: 0.95, resistanceEffect: 0, instabilityEffect: 0, activation: 'Passive' },
            { name: "Focus II (Passive, -10% Power, +37% Opt. Charge Window)", multiplier: 0.90, resistanceEffect: 0, instabilityEffect: 0, activation: 'Passive' },
            { name: "Focus (Passive, -15% Power, +30% Opt. Charge Window)", multiplier: 0.85, resistanceEffect: 0, instabilityEffect: 0, activation: 'Passive' },
            
            // Default/None
            { name: "None", multiplier: 1.00, resistanceEffect: 0, instabilityEffect: 0, activation: 'Default' },
        ];
        
        // Custom sort function: Default, Active (by power), Passive (by power)
        function sortModules(modules) {
            return modules.sort((a, b) => {
                // 1. Put 'None' first
                if (a.name === 'None') return -1;
                if (b.name === 'None') return 1;

                // 2. Group Active before Passive
                if (a.activation === 'Active' && b.activation === 'Passive') return -1;
                if (a.activation === 'Passive' && b.activation === 'Active') return 1;

                // 3. Within the same group, sort by power multiplier (highest first)
                if (a.multiplier !== b.multiplier) {
                    return b.multiplier - a.multiplier;
                }
                
                // 4. Fallback to alphabetical
                return a.name.localeCompare(b.name);
            });
        }
        const sortedModules = sortModules([...powerModules]); // Create a copy and sort it


        // --- GADGETS DATA ---
        const gadgets = [
            { name: "None", reduction: 0.0 }, 
            { name: "Sabir (-50% Resistance)", reduction: 50.0 },
            { name: "OptiMax (-30% Resistance)", reduction: 30.0 },
            { name: "BoreMax (+10% Resistance)", reduction: -10.0 }, // Negative reduction value means a resistance increase (additive)
            { name: "Waveshift (Instability/Charge)", reduction: 0.0 }, 
            { name: "Stalwart (Instability/Charge)", reduction: 0.0 }, 
            { name: "Okunis (Charge Rate/Window)", reduction: 0.0 },
        ].sort((a, b) => b.reduction - a.reduction);

        let armIdCounter = 0; // Unique ID for each added laser head

        /**
         * Generates the HTML for a single mining laser head's configuration.
         * @param {number} armIndex - The index of the laser head (1, 2, or 3) for display.
         * @param {object} ship - The ship data object (MOLE, Prospector, Golem).
         * @returns {string} The HTML for the laser head configuration.
         */
        function createArmConfigHtml(armIndex, ship) {
            armIdCounter++; // Ensure unique ID for this laser head
            const armUniqueId = `arm-${ship.id}-${armIdCounter}`;
            const isFixedLaser = ship.isFixedLaser; 

            // 1. Laser Head Options (Filtered by ship's maxLaserSize)
            let laserOptionsHtml = allLaserHeads
                .filter(head => head.size <= ship.maxLaserSize)
                .map(head => {
                    const isSelected = head.power === ship.defaultLaser;
                    return `<option value="${head.power}" ${isSelected ? 'selected' : ''}>${head.name}</option>`;
                }).join('');

            let laserSelectAttributes = '';
            let laserSelectDisabled = '';
            if (isFixedLaser) {
                laserSelectDisabled = 'disabled';
                laserOptionsHtml = `<option value="${ship.defaultLaser}" selected>${ship.fixedLaserName} (Fixed)</option>`;
            } else {
                laserSelectAttributes = `onchange="calculate()"`;
            }
            
            // 2. Module Slot Options (Sorted and grouped)
            const moduleOptionsHtml = sortedModules.map(mod => 
                `<option value="${mod.name}" ${mod.name.startsWith('None') ? 'selected' : ''}>${mod.name}</option>`
            ).join('');

            // 3. Module Slots (Enable/Disable 3rd slot based on moduleSlots)
            let moduleSlotsHtml = '';
            for (let i = 1; i <= 3; i++) {
                const isDisabled = i > ship.moduleSlots;
                const slotText = isDisabled ? `--- SLOT DISABLED (${ship.moduleSlots} Slots Max) ---` : `Module Slot ${i}`;
                const initialValue = 'None'; // VALUE: Now stores the module NAME, 'None' is the default
                const disabledClass = isDisabled ? 'opacity-50' : '';
                
                moduleSlotsHtml += `
                    <select id="${armUniqueId}-mod${i}" class="arm-module-select w-full p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white mb-3 ${disabledClass}" 
                            onchange="calculate()" value="${initialValue}" ${isDisabled ? 'disabled' : ''}>
                        ${isDisabled ? `<option value="None">${slotText}</option>` : moduleOptionsHtml}
                    </select>
                `;
            }

            // --- Full Laser Head Structure ---
            return `
                <div id="${armUniqueId}" class="p-4 rounded-xl shadow-lg ship-arm-card space-y-3" data-ship-id="${ship.id}" data-max-modules="${ship.moduleSlots}">
                    <div class="flex justify-between items-start">
                        <h4 class="text-lg font-bold ${ship.id === 'mole' ? 'text-indigo-400' : ship.id === 'prospector' ? 'text-green-400' : 'text-amber-400'}">
                            ${ship.name} - Laser Head ${armIndex}
                        </h4>
                        <button onclick="removeArmConfig('${armUniqueId}')" title="Remove Laser Head" class="p-1 bg-red-600 hover:bg-red-700 text-white rounded-full transition-all duration-150 active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <label class="block text-sm font-medium text-gray-400">Laser Head (Base Power)</label>
                    <select id="${armUniqueId}-laser" class="arm-laser-select w-full p-3 rounded-lg bg-[#161b22] border border-[#30363d] text-white"
                            data-max-size="${ship.maxLaserSize}" ${laserSelectAttributes} ${laserSelectDisabled}>
                        ${laserOptionsHtml}
                    </select>
                    <p class="text-xs text-gray-500 italic text-right -mt-2 mb-2">Click or tap to view options</p>

                    <label class="block text-sm font-medium text-gray-400">Modules (Max ${ship.moduleSlots} Slots)</label>
                    ${moduleSlotsHtml}
                </div>
            `;
        }

        /**
         * Adds a set of loadout arms corresponding to the selected ship.
         */
        function addShipLoadout() {
            const container = document.getElementById('multiShipContainer');
            const selectElement = document.getElementById('shipSelectToAdd');
            const selectedShipId = selectElement.value;
            const shipData = ships.find(s => s.id === selectedShipId);

            if (!shipData) return;

            // Remove initial placeholder message if present
            const placeholder = container.querySelector('p.text-gray-500');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Add all arms for the selected ship
            for (let i = 1; i <= shipData.arms; i++) {
                const armHtml = createArmConfigHtml(i, shipData);
                container.insertAdjacentHTML('beforeend', armHtml);
            }
            
            // Recalculate after adding new ships
            calculate();
        }

        /**
         * Removes an arm configuration from the DOM.
         * @param {string} armId - The unique ID of the arm element to remove.
         */
        function removeArmConfig(armId) {
            const armElement = document.getElementById(armId);
            if (armElement) {
                armElement.remove();
            }
            
            const container = document.getElementById('multiShipContainer');
            // If all arms are removed, show the placeholder again
            if (container.children.length === 0) {
                container.innerHTML = `
                    <p class="text-center text-gray-500 p-4 border border-dashed border-gray-700 rounded-lg">
                        Add ships above to configure their mining laser heads.
                    </p>
                `;
            }
            calculate();
        }


        /**
         * Dynamically populates the ship and gadget select dropdowns on load.
         */
        function populateSelects() {
            // 1. Populate "Add Ship" Select
            const shipSelectElement = document.getElementById('shipSelectToAdd');
            if (shipSelectElement) {
                shipSelectElement.innerHTML = ships.map((ship) => 
                    `<option value="${ship.id}">${ship.name} (Laser Heads: ${ship.arms})</option>`
                ).join('');
                // Default to MOLE for easy initial testing of multi-arm ships
                shipSelectElement.value = 'mole';
            }
            
            // 2. Populate Gadget Slot
            const gadgetSelectElement = document.getElementById('gadgetSelect');
            if (gadgetSelectElement) {
                // Find the default gadget (Sabir) by name/reduction
                const defaultGadget = gadgets.find(g => g.name.startsWith("Sabir"));
                gadgetSelectElement.innerHTML = gadgets.map(g => 
                    // VALUE: Uses reduction. If positive (reduction), it's multiplicative. If negative (increase), it's additive.
                    `<option value="${g.reduction}" ${g === defaultGadget ? 'selected' : ''}>${g.name}</option>`
                ).join('');
                if (defaultGadget) {
                    gadgetSelectElement.value = defaultGadget.reduction.toString();
                }
            }
            
            // Run initial calculation (which will show the 'no ships' message)
            calculate(); 
        }

        /**
         * Assesses mining difficulty based on Instability and Resistance.
         */
        function assessDifficulty(instability, resistance) {
            // Note: The difficulty score calculation logic has been simplified slightly to be based on the final, modified rock parameters
            let difficultyScore = resistance * 1.5 + instability;
            
            if (difficultyScore >= 100) {
                return { text: "EXTREME: Very high instability and resistance. Requires exceptional skill and stability modules.", color: "text-red-500" };
            } else if (difficultyScore >= 60) {
                return { text: "HARD: High instability/resistance. Requires specialized modules (Forel/Torrent) for safe charging.", color: "text-orange-400" };
            } else if (difficultyScore >= 30) {
                return { text: "MODERATE: Average difficulty. Standard play should be fine, but stability modules are helpful.", color: "text-yellow-300" };
            } else {
                return { text: "EASY: Low difficulty rock. Minimal risk of overheating or explosion.", color: "text-green-400" };
            }
        }


        /**
         * The core JavaScript function to perform the mining calculation and suggestion.
         */
        function calculate() {
            const resultsContainer = document.getElementById('results');
            const suggestionContainer = document.getElementById('suggestion');
            const allArms = document.querySelectorAll('.ship-arm-card');
            
            // 1. Input Validation and Power/Modifier Summation
            if (allArms.length === 0) {
                displayResult('No mining laser heads added. Assemble your team above to begin the calculation.', 'text-gray-400');
                suggestionContainer.classList.add('hidden');
                return;
            }

            let totalEffectiveLaserPower = 0;
            
            // NEW MODIFIERS for complex resistance/instability tracking
            let totalAdditiveResistance = 0; // Tracks positive resistance additions (e.g., Brandt +15)
            let totalReductionMultiplier = 1.0; // Tracks multiplicative resistance reduction factor (e.g., Surge 0.85, Sabir 0.5)
            let totalInstabilityModifier = 0; // Stays additive
            let validationError = false;
            let totalArmsCount = allArms.length;

            allArms.forEach(arm => {
                const armUniqueId = arm.id;
                const maxModules = parseInt(arm.dataset.maxModules);
                
                // Get Laser Power
                const laserSelect = document.getElementById(`${armUniqueId}-laser`);
                const basePowerValue = laserSelect ? (laserSelect.value || '0') : '0';
                const basePower = parseFloat(basePowerValue);
                
                // --- MODULE EFFECT CALCULATION (Per Arm) ---
                let totalModulePowerMultiplier = 1.0;
                let activeModules = [];
                let passiveModules = [];
                
                // 1. Collect all module selections for this arm
                for (let i = 1; i <= 3; i++) { 
                    const moduleSelect = document.getElementById(`${armUniqueId}-mod${i}`);
                    if (moduleSelect && i <= maxModules) { 
                        const moduleName = moduleSelect.value;
                        const selectedModule = powerModules.find(m => m.name === moduleName);

                        if (selectedModule && selectedModule.name !== 'None') {
                            if (selectedModule.activation === 'Active') {
                                activeModules.push(selectedModule);
                            } else if (selectedModule.activation === 'Passive') {
                                passiveModules.push(selectedModule);
                            }
                        }
                    }
                }

                // 2. Apply Active Module Rule (only the most powerful one is active)
                if (activeModules.length > 0) {
                    activeModules.sort((a, b) => b.multiplier - a.multiplier);
                    const activeModule = activeModules[0];
                    
                    // Apply Power Multiplier and Additive Instability to the total calculation
                    totalModulePowerMultiplier *= activeModule.multiplier; 
                    totalInstabilityModifier += activeModule.instabilityEffect; 

                    // Apply Resistance Effect
                    if (activeModule.resistanceEffect < 0) {
                        // Resistance reduction (Multiplicative Reduction): e.g., Surge -15 -> x 0.85
                        totalReductionMultiplier *= (1 - (Math.abs(activeModule.resistanceEffect) / 100));
                    } else if (activeModule.resistanceEffect > 0) {
                        // Resistance increase (Additive Percentage Point): e.g., Brandt +15 -> +15% points
                        totalAdditiveResistance += activeModule.resistanceEffect;
                    }
                }

                // 3. Apply Passive Module Rule (all stack)
                passiveModules.forEach(mod => {
                    // Apply Power Multiplier and Additive Instability
                    totalModulePowerMultiplier *= mod.multiplier; 
                    totalInstabilityModifier += mod.instabilityEffect; 

                    // Apply Resistance Effect
                    if (mod.resistanceEffect < 0) {
                        // Resistance reduction (Multiplicative Reduction)
                        totalReductionMultiplier *= (1 - (Math.abs(mod.resistanceEffect) / 100));
                    } else if (mod.resistanceEffect > 0) {
                        // Resistance increase (Additive Percentage Point)
                        totalAdditiveResistance += mod.resistanceEffect;
                    }
                });
                // --- END MODULE EFFECT CALCULATION ---

                if (isNaN(basePower) || basePower <= 0) {
                    validationError = true;
                } else {
                    // Total effective power is the sum of (Base Power * Total Multiplier) for each arm
                    totalEffectiveLaserPower += basePower * totalModulePowerMultiplier;
                }
            });

            // Get Rock & Gadget Stats
            const baseResistance = parseFloat(document.getElementById('resistance').value);
            const initialInstability = parseFloat(document.getElementById('instability').value);
            const gadgetReductionValue = parseFloat(document.getElementById('gadgetSelect').value);
            const rockMass = parseFloat(document.getElementById('rockMass').value);
            
            // Final Validation (Catches NaN from number inputs if they are cleared by the user)
            if (validationError || isNaN(baseResistance) || isNaN(rockMass) || isNaN(initialInstability) || totalEffectiveLaserPower <= 0) {
                displayResult('Error: Ensure all active laser heads have a valid Laser Head selected and all rock parameters contain valid positive numbers.', 'text-yellow-400');
                suggestionContainer.classList.add('hidden');
                return;
            }

            // 2. Calculate Final Rock Parameters
            
            // Step 1: Apply all module ADDITIVE effects (positive resistance)
            let resistanceAfterAdditiveMods = baseResistance + totalAdditiveResistance;
            let finalModifiedInstability = initialInstability + totalInstabilityModifier;

            // Step 2: Apply Gadget effect
            const selectedGadget = gadgets.find(g => g.reduction === gadgetReductionValue);

            if (selectedGadget) {
                if (selectedGadget.reduction > 0) { // e.g., Sabir 50.0 (Reduction)
                    // Gadget reduction applies multiplicatively with module reductions
                    totalReductionMultiplier *= (1 - (selectedGadget.reduction / 100));
                } else if (selectedGadget.reduction < 0) { // e.g., BoreMax -10.0 (Increase)
                    // Gadget increase applies additively
                    resistanceAfterAdditiveMods += Math.abs(selectedGadget.reduction);
                }
            }
            
            // Step 3: Apply the total multiplicative reduction factor
            let finalEffectiveResistance = resistanceAfterAdditiveMods * totalReductionMultiplier;

            // Apply final clamps
            if (finalEffectiveResistance < 0) finalEffectiveResistance = 0; 
            if (finalModifiedInstability < -50) finalModifiedInstability = -50; 
            
            // --- Output Display Formatting ---
            const totalResistanceReductionPercentage = (1 - totalReductionMultiplier) * 100;
            const resistanceDisplayBreakdown = `Add: +${totalAdditiveResistance.toFixed(1)}% | Reduct: ${totalResistanceReductionPercentage.toFixed(1)}% Multiplicative`;
            // ---------------------------------

            // 3. Perform Fracture Calculation
            const resistanceDecimal = finalEffectiveResistance / 100.0;
            
            let breakableMassLimit;
            let requiredEffectivePower = 0; 

            if (resistanceDecimal >= 1.0) {
                breakableMassLimit = 0.0;
            } else {
                const denominator = 1.0 - resistanceDecimal;
                // Formula: (Total Effective Laser Power * 5) / (1 - Effective Resistance)
                breakableMassLimit = (totalEffectiveLaserPower * 5) / denominator;
                
                // Required Power = (Target Mass * (1 - Effective Resistance)) / 5
                requiredEffectivePower = (rockMass * denominator) / 5; 
            }

            // 4. Determine Verdict and Format Output
            const isSuccess = breakableMassLimit >= rockMass;

            const formattedMaxMass = breakableMassLimit.toLocaleString(undefined, { maximumFractionDigits: 2 });
            const formattedRockMass = rockMass.toLocaleString();
            const formattedEffectivePower = totalEffectiveLaserPower.toLocaleString(undefined, { maximumFractionDigits: 2 });
            
            let verdictClass = isSuccess ? 'bg-green-700/80' : 'bg-red-700/80';
            let verdictIcon = isSuccess ? '✅' : '❌';
            let verdictText = isSuccess ? 'FRACTURE SUCCESSFUL!' : 'FRACTURE FAILED. Power short.';
            
            let massDifference = isSuccess ? 
                `${(breakableMassLimit - rockMass).toLocaleString(undefined, { maximumFractionDigits: 2 })} kg over the target mass.` : 
                `${(rockMass - breakableMassLimit).toLocaleString(undefined, { maximumFractionDigits: 2 })} kg short of the target mass.`;

            // Difficulty Assessment uses the final module-modified instability and effective resistance
            const difficulty = assessDifficulty(finalModifiedInstability, finalEffectiveResistance);


            const outputHtml = `
                <div class="space-y-6 text-white text-center">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 rounded-xl bg-[#21262d] shadow-inner border border-gray-700">
                            <p class="text-sm text-gray-400">Final Effective Resistance</p>
                            <p class="text-3xl font-extrabold text-red-400 mt-1">${finalEffectiveResistance.toFixed(1)}%</p>
                            <p class="text-xs text-gray-500">(Base ${baseResistance.toFixed(1)}% | ${resistanceDisplayBreakdown})</p>
                        </div>
                        <div class="p-3 rounded-xl bg-[#21262d] shadow-inner border border-gray-700">
                            <p class="text-sm text-gray-400">Modified Instability</p>
                            <p class="text-3xl font-extrabold text-purple-400 mt-1">${finalModifiedInstability.toFixed(1)}%</p>
                            <p class="text-xs text-gray-500">(Base ${initialInstability.toFixed(1)}% | Mod: ${totalInstabilityModifier > 0 ? '+' : ''}${totalInstabilityModifier.toFixed(1)}%)</p>
                        </div>
                    </div>
                    
                    <div class="p-3 rounded-xl bg-indigo-900/40 shadow-inner border border-indigo-700">
                        <p class="text-sm text-gray-400">Total Combined Effective Laser Power (${totalArmsCount} Laser Heads)</p>
                        <p class="text-4xl font-extrabold text-yellow-300 mt-1">${formattedEffectivePower} MW</p>
                    </div>

                    <div class="p-3 rounded-xl bg-[#21262d] shadow-inner border border-gray-700">
                        <p class="text-sm text-gray-400">Max Theoretical Breakable Mass Limit</p>
                        <p class="text-4xl font-extrabold text-indigo-300 mt-1">${formattedMaxMass} kg</p>
                    </div>
                    
                    <div class="p-4 rounded-xl font-semibold text-lg text-white ${verdictClass} shadow-xl mt-6">
                        <p class="text-2xl">${verdictIcon} ${verdictText}</p>
                        <p class="text-sm pt-2 text-gray-200 italic">${massDifference}</p>
                        <p class="text-sm pt-1 text-gray-300">Target Rock Mass: ${formattedRockMass} kg</p>
                    </div>
                    
                    <div class="p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <p class="text-base font-semibold text-gray-300">Mining Difficulty Assessment:</p>
                        <p class="mt-1 font-bold ${difficulty.color}">${difficulty.text}</p>
                    </div>
                </div>
            `;

            resultsContainer.innerHTML = outputHtml;
            
            // 5. Generate Suggestions (Failure Alert, Stability Warning, and Max Loadout)
            let suggestionHtml = '';
            let recommendedLoadoutHtml = '';
            let warningsHtml = ''; 
            
            // --- A. Generate Max Power Loadout Recommendation (ALWAYS GENERATED) ---
            
            // Ideal Loadout Components for Max Power
            const recommendedGadget = gadgets.find(g => g.name.startsWith("Sabir"));
            const topActiveModule = powerModules.find(m => m.activation === 'Active' && m.name.startsWith("Surge")); // Surge (1.50)
            const topPassiveModules = powerModules.filter(m => m.activation === 'Passive').sort((a, b) => b.multiplier - a.multiplier);
            
            // The two best passive modules (Rieger-C3, Rieger-C2)
            const recommendedPassiveModules = [ 
                topPassiveModules.find(m => m.name.startsWith("Rieger-C3")),
                topPassiveModules.find(m => m.name.startsWith("Rieger-C2")),
            ].filter(Boolean); // Filter out null/undefined if any are missing

            const recommendedLaserS2 = allLaserHeads.find(h => h.name.startsWith("Helix II")); 
            const recommendedLaserS1 = allLaserHeads.find(h => h.name.startsWith("Helix I"));  
            const recommendedGolemLaser = allLaserHeads.find(h => h.name.startsWith("Pitman")); 

            recommendedLoadoutHtml += `<h2 class="text-xl font-semibold text-center text-yellow-300 mb-4">Max Power Loadout Recommendation</h2>`;
            
            recommendedLoadoutHtml += `<div class="p-4 bg-gray-800/50 rounded-lg mb-6 border border-blue-600">
                <p class="font-bold text-blue-300">Max Resistance Reduction Gadget:</p>
                <p class="text-lg text-white font-semibold mt-1">${recommendedGadget.name}</p>
                <p class="text-sm text-gray-400">(Recommended to reduce target resistance)</p>
            </div>`;

            recommendedLoadoutHtml += '<h3 class="text-lg font-bold text-center text-yellow-300 mb-4">Loadout Per Active Laser Head</h3>';
            recommendedLoadoutHtml += '<div class="space-y-4">';

            allArms.forEach((arm) => {
                const shipId = arm.dataset.shipId;
                const shipData = ships.find(s => s.id === shipId);
                const maxModules = parseInt(arm.dataset.maxModules);
                const armDisplayNumber = arm.querySelector('h4').innerText.split(' - ')[1]; 

                let laserName, laserPower, moduleList;

                if (shipId === 'golem') {
                    laserName = recommendedGolemLaser.name;
                    laserPower = recommendedGolemLaser.power;
                    // Golem (2 slots): 1 Active (Surge) + 1 Passive (Rieger-C3)
                    moduleList = [topActiveModule, recommendedPassiveModules[0]].filter(Boolean);
                } else if (shipId === 'mole') {
                    laserName = recommendedLaserS2.name;
                    laserPower = recommendedLaserS2.power;
                    // MOLE (3 slots): 1 Active (Surge) + 2 Passive (Rieger-C3, Rieger-C2)
                    moduleList = [topActiveModule, ...recommendedPassiveModules].filter(Boolean); 
                } else { // Prospector
                    laserName = recommendedLaserS1.name;
                    laserPower = recommendedLaserS1.power;
                    // Prospector (3 slots): 1 Active (Surge) + 2 Passive (Rieger-C3, Rieger-C2)
                    moduleList = [topActiveModule, ...recommendedPassiveModules].filter(Boolean);
                }
                
                moduleList = moduleList.slice(0, maxModules);
                
                // Calculate the max effective power for this recommended arm loadout
                let rec_power_multiplier = 1.0;
                
                const rec_active_module = moduleList.find(m => m.activation === 'Active');
                const rec_passive_modules = moduleList.filter(m => m.activation === 'Passive');
                
                if (rec_active_module) {
                    rec_power_multiplier *= rec_active_module.multiplier;
                }
                rec_passive_modules.forEach(mod => {
                    rec_power_multiplier *= mod.multiplier;
                });
                
                const maxEffectivePower = laserPower * rec_power_multiplier;
                
                const moduleHtml = moduleList.map((mod, i) => 
                    `<li class="ml-4 list-disc text-green-300">Slot ${i+1}: <span class="font-bold">${mod.name}</span> (x${mod.multiplier.toFixed(2)})</li>`
                ).join('');
                
                const titleColorClass = shipId === 'mole' ? 'text-indigo-400' : shipId === 'prospector' ? 'text-green-400' : 'text-amber-400';

                recommendedLoadoutHtml += `
                    <div class="p-4 rounded-xl bg-gray-900 border border-gray-700">
                        <h4 class="text-lg font-bold ${titleColorClass}">${shipData.name} - ${armDisplayNumber}</h4>
                        <p class="text-sm text-gray-400 mt-1">
                            Max Achievable Power: <span class="text-yellow-400 font-bold">${maxEffectivePower.toLocaleString(undefined, { maximumFractionDigits: 2 })} MW</span>
                        </p>
                        
                        <div class="mt-3 p-3 bg-[#161b22] rounded-lg">
                            <p class="font-medium text-blue-400">Laser Head:</p>
                            <p class="text-base font-bold text-white">${laserName}</p>
                        </div>
                                                    
                        <div class="mt-3 p-3 bg-[#161b22] rounded-lg">
                            <p class="font-medium text-blue-400">Recommended Modules (${maxModules} Slots):</p>
                            <ul class="text-sm space-y-1 pt-1">
                                ${moduleHtml}
                            </ul>
                        </div>
                    </div>
                `;
            });

            recommendedLoadoutHtml += '</div>';

            // --- B. Generate Failure Warning (CONDITIONAL) ---
            if (!isSuccess && requiredEffectivePower > 0) {
                 
                 const formattedRequiredPower = requiredEffectivePower.toLocaleString(undefined, { maximumFractionDigits: 2 });
                 const powerNeeded = requiredEffectivePower - totalEffectiveLaserPower;
                 
                 const formattedPowerPerArmNeeded = (requiredEffectivePower / totalArmsCount).toLocaleString(undefined, { maximumFractionDigits: 2 });
                 
                 warningsHtml += `
                    <div class="p-4 bg-red-900/40 rounded-xl border border-red-700/50 mb-6">
                        <h3 class="text-xl font-bold text-red-300 mb-2">🚀 Power Shortfall Alert!</h3>
                        <p class="text-gray-300">The current loadout is **${powerNeeded.toLocaleString(undefined, { maximumFractionDigits: 2 })} MW** short. Your Total Effective Laser Power of **${formattedEffectivePower} MW** must reach at least **${formattedRequiredPower} MW**.</p>
                        <p class="mt-2 text-sm text-yellow-200">
                            **Action Plan:**
                            <ul class="list-disc list-inside ml-2 mt-1 space-y-1">
                                <li>Upgrade to the **Max Power Loadout** shown below (using only 1 Active Module per head).</li>
                                <li>Focus on stacking the most powerful single Active Module (**Surge**) with your strongest Passive Modules.</li>
                                <li>Ensure you are using a resistance-reducing gadget like **Sabir** (-50%).</li>
                            </ul>
                        </p>
                    </div>
                 `;
            }
            
            // --- C. Generate Stability Warning (CONDITIONAL) ---
            if (finalEffectiveResistance > 30 || finalModifiedInstability > 40) {
                
                let instabilityTip = finalModifiedInstability > 40 ? 'Your **Instability** is critically high. Expect a small optimal window.' : '';
                let resistanceTip = finalEffectiveResistance > 30 ? 'Your **Resistance** is high, making the rock hard to heat.' : '';

                warningsHtml += `
                    <div class="p-4 bg-purple-900/40 rounded-xl border border-purple-700/50 ${warningsHtml.length > 0 ? '' : 'mb-6'}">
                        <h3 class="text-xl font-bold text-purple-300 mb-2">🛡️ Rock Stability Warning!</h3>
                        <p class="text-gray-300">
                            ${instabilityTip} ${resistanceTip}
                        </p>
                        <p class="mt-2 text-sm text-yellow-200">
                            **Module Recommendation:**
                            <ul class="list-disc list-inside ml-2 mt-1 space-y-1">
                                <li>To reduce **Instability**: Equip **Stampede** (Active) or **Rieger-C2/C3** (Passive).</li>
                                <li>To reduce **Resistance**: Equip **Surge** (Active) or **Rime** (Active).</li>
                                <li>For optimal window control: Use **Focus** series modules.</li>
                            </ul>
                        </p>
                    </div>
                `;
            }
            
            // --- D. Combine and Display ---
            if (warningsHtml.length > 0) {
                // If there were warnings, prepend them to the loadout recommendation
                suggestionContainer.innerHTML = `<h2 class="text-xl font-semibold text-center text-red-400 mb-4">Urgent Analysis & Loadout Guide</h2>` + warningsHtml + recommendedLoadoutHtml;
                suggestionContainer.classList.remove('hidden');
            } else if (recommendedLoadoutHtml.length > 0) {
                // If only the loadout recommendation exists (successful, low difficulty rock)
                suggestionContainer.innerHTML = recommendedLoadoutHtml;
                suggestionContainer.classList.remove('hidden');
            } else {
                suggestionContainer.classList.add('hidden');
            }
        }

        // Helper function for error messages
        function displayResult(message, className) {
            document.getElementById('results').innerHTML = `<p class="text-center mt-4 ${className} font-bold text-lg">${message}</p>`;
        }
        
        // Run initial population on load
        window.onload = () => {
            populateSelects();
        };
    </script>
</body>
</html>
